
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="‡πÇ‡∏ô‡∏ô‡πÑ‡∏ó‡∏¢">

    <meta name="theme-color" content="#2563eb">
    <title>‡πÇ‡∏ô‡∏ô‡πÑ‡∏ó‡∏¢</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="static/icons/lb.ico" type="image/x-icon"> <!-- ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏≤‡∏ò‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ó‡∏ò‡πå -->

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô <head> ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Leaflet GeoJSON Layer (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å GeoPackage) -->

    <style>
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        #map { height: 100vh; width: 100vw; z-index: 0; }
        
        /* ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå ‚Üí ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô cursor */
        .cursor-crosshair-add {
            cursor: crosshair !important;
        }

        /* ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏£‡πá‡∏ß */
        .leaflet-container {
            user-select: none;
            -webkit-user-select: none;
        }

        /* ‡∏Ç‡πâ‡∏≠ 1: ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô 20%, ‡∏´‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô, ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô 15%) */
        .crosshair {
            position: absolute;
            top: 35%; /* ‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á (50% - 15%) */
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 1000;
        }
        .crosshair-center {
            width: 6px; height: 6px;
            background-color: #ffffff;
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .crosshair-circle {
            width: 60px; height: 60px; /* ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å 50px */
            border: 3px solid rgba(255, 255, 255, 0.9); /* ‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô */
            border-radius: 50%;
            position: relative;
        }
        .crosshair-line { position: absolute; background-color: rgba(255, 255, 255, 0.9); }
        .line-v { width: 3px; height: 18px; left: 50%; transform: translateX(-50%); }
        .line-h { height: 3px; width: 18px; top: 50%; transform: translateY(-50%); }
        .v-top { top: -20px; } .v-bottom { bottom: -20px; }
        .h-left { left: -20px; } .h-right { right: -20px; }

        /* ‡∏ß‡∏á‡∏Å‡∏•‡∏° - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à */
        .circle-round {
          border-radius: 50% !important;
        }

        /* ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° - ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß */
        .circle-square {
          border-radius: 0 !important;
        }

        /* ‡∏£‡∏π‡∏õ‡∏´‡∏°‡∏∏‡∏î - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏≤‡∏™‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ SVG ‡πÅ‡∏ó‡∏ô) */
        .pin-marker {
            /* ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏© ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÉ‡∏ä‡πâ SVG */
        }

        /* ‚úÖ ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Desktop) */
        /* ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå ‚Üí ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö cursor ‡πÄ‡∏õ‡πá‡∏ô crosshair ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà */
        #map.cursor-crosshair-add,
        #map.cursor-crosshair-add .leaflet-container,
        #map.cursor-crosshair-add .leaflet-pane,
        #map.cursor-crosshair-add .leaflet-interactive,
        #map.cursor-crosshair-add .leaflet-path,
        #map.cursor-crosshair-add .leaflet-poly {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><line x1="16" y1="4" x2="16" y2="28" stroke="white" stroke-width="2" stroke-linecap="round"/><line x1="4" y1="16" x2="28" y2="16" stroke="white" stroke-width="3" stroke-linecap="round"/><rect x="0" y="0" width="36" height="32" fill="none"') 16 16, crosshair !important;
        }

        /* ‚úÖ ‡∏õ‡∏¥‡∏î pointer-events ‡∏ö‡∏ô polygon ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏õ‡∏•‡∏á) */
        #map.cursor-crosshair-add .leaflet-interactive {
            pointer-events: none !important;
        }

        /* ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå (‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) */
        #btn-mouse-add-mode {
            display: none;
        }

        @media (min-width: 769px) {
            #btn-mouse-add-mode {
                display: flex !important;
            }
        }

        #btn-mouse-add-mode.active-tool {
            background-color: #2563eb !important;
            color: white !important;
            border: 2px solid white;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç */
        .bg-custom-green { 
            background-color: rgba(187, 247, 208, 0.9) !important; 
        }
        .bg-custom-pink { 
            background-color: rgba(255, 249, 196, 0.9) !important; 
        }
        .bg-custom-check-status { 
            background-color: rgba(187, 247, 208, 0.9) !important; 
            font-weight: bold;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
        .form-input[readonly] {
            background-color: rgba(187, 247, 208, 0.9) !important;
            cursor: not-allowed !important;
            opacity: 0.85;
            border-color: #9ca3af !important;
        }
        .form-input[readonly]:hover {
            border-color: #6b7280 !important;
        }

        /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏£‡∏Å */
        .form-input.green-bg {
            background-color: rgba(187, 247, 208, 0.9) !important;
        }

        /* ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≠‡∏á */
        .form-input.pink-bg {
            background-color: rgba(255, 204, 204, 0.3) !important; /* ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô */
        }

        /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" */
        .form-input.check-status {
            background-color: rgba(187, 247, 208, 0.9) !important;
            font-weight: bold;
        }

        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß" */
        .status-‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß { 
            background: rgba(187, 247, 208, 0.9) !important; 
            color: #065f46; 
        }

        /* ‚úÖ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á (parcel_cod) */
        .parcel-label {
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
            pointer-events: none !important;  /* ‚úÖ ‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å */
        }

        .parcel-label-text {
            display: block;
            text-align: center;
            line-height: 1.3;
            color: #dc2626;  /* üî¥ ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏° */
            
            /* ‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
            text-shadow: 
                -1px -1px 0 #fff, 1px -1px 0 #fff,
                -1px 1px 0 #fff, 1px 1px 0 #fff,
                -2px 0 0 #fff, 2px 0 0 #fff,
                0 -2px 0 #fff, 0 2px 0 #fff;
            
            font-size: 12px;
            font-weight: bold;
            font-family: 'Sarabun', 'Tahoma', sans-serif;
            transform: translateY(-5px);  /* ‚úÖ ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            white-space: nowrap;
        }

        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ Label ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) */
        .parcel-label {
            display: none; 
        }

        /* ============================================
           POPUP STYLES - ‡∏ä‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏à‡∏ö (‡∏ó‡∏±‡∏ö Leaflet ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
           ============================================ */

        /* ‚úÖ Popup Wrapper - ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏°‡∏∏‡∏°‡∏°‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á */
        .mobile-popup .leaflet-popup-content-wrapper,
        .mobile-popup-raw .leaflet-popup-content-wrapper {
            padding: 0 !important;
            margin: 4px !important;
            border-radius: 6px !important;  /* ‚úÖ ‡∏°‡∏∏‡∏°‡∏°‡∏ô */
            box-shadow: 0 4px 20px rgba(0,0,0,0.25) !important;
            background: #fff !important;
            overflow: hidden !important;
        }

        /* ‚úÖ Popup Content - ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á */
        .mobile-popup .leaflet-popup-content,
        .mobile-popup-raw .leaflet-popup-content {
            margin: 0 !important;
            width: auto !important;
            min-width: 150px !important;
            max-width: 480px !important;
            text-align: center !important;
            line-height: 1.5 !important;
            font-family: 'Sarabun', 'Tahoma', sans-serif !important;
        }
        .popup-simple {
            padding: 8px 12px !important;   /* ‚úÖ ‡∏•‡∏î padding ‡πÉ‡∏´‡πâ‡∏Å‡∏∞‡∏ó‡∏±‡∏î‡∏£‡∏±‡∏î */
            background: #fff;
            font-family: 'Sarabun', 'Tahoma', sans-serif;
            text-align: center !important;  /* ‚úÖ ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å */
            min-width: 120px;
            max-width: 240px;
            margin: 0 auto;  /* ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô popup */
        }
        .popup-simple .popup-header {
            display: block;            /* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å flex ‡πÄ‡∏õ‡πá‡∏ô block */
            cursor: pointer;
            padding-bottom: 4px;
            border-bottom: 1px solid #eee;
            text-align: center !important;  /* ‚úÖ ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
        }
        .popup-simple .parcel-cod {
            font-weight: bold;
            color: black;
            font-size: 13px;
            display: block;            /* ‚úÖ ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
            text-align: center !important;
            white-space: nowrap;       /* ‚úÖ ‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
            overflow: hidden;
            text-overflow: ellipsis;   /* ‚úÖ ‡∏ñ‡πâ‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô ‚Üí ‡πÅ‡∏™‡∏î‡∏á ... */
        }
        .popup-simple .popup-owner {
            font-size: 13px;
            color: #3b82f6;
            padding-top: 4px;
            text-align: center !important;  /* ‚úÖ ‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            word-break: break-word;    /* ‚úÖ ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏ô */
            line-height: 1.3;
        }

        /* ‚úÖ Popup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö - ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .mobile-popup-raw .leaflet-popup-content-wrapper {
            padding: 0 !important;
            border-radius: 6px !important;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25) !important;
        }
        .mobile-popup-raw .leaflet-popup-content {
            margin: 0 !important;
            width: auto !important;
            min-width: 200px !important;  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 280px ‡πÄ‡∏õ‡πá‡∏ô 320px */
            max-width: 300px !important;  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 280px ‡πÄ‡∏õ‡πá‡∏ô 450px */
        }

        .popup-raw {
            background: #fff;
            font-family: 'Sarabun', 'Tahoma', sans-serif;
            max-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .popup-raw-body {
            padding: 10px 14px;  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á */
            overflow-y: auto;
            flex: 1;
        }

        .popup-raw table {
            width: 100%;
            font-size: 12px;  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            border-collapse: collapse;
        }

        .popup-raw td {
            padding: 5px 3px;  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° padding */
            vertical-align: top;
            text-align: left !important; 
        }

        .popup-raw td.k {
            font-weight: 600;
            color: #475569;
            width: 35%;  /* ‚úÖ ‡∏•‡∏î‡∏à‡∏≤‡∏Å 40% ‡πÉ‡∏´‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô */
            white-space: nowrap;
        }

        .popup-raw td.v {
            color: #1e293b;
            word-break: break-word;  /* ‚úÖ ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏ô */
        }

        /* ‚úÖ Scrollbar ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .popup-raw-body::-webkit-scrollbar {
            width: 4px;
        }
        .popup-raw-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô popup ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≠ */
        @media (max-width: 480px) {
            .mobile-popup .leaflet-popup-content-wrapper,
            .mobile-popup-raw .leaflet-popup-content-wrapper {
                margin: 4px !important;
            }
            .popup-raw {
                max-height: 40vh !important;
            }
        }

        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô .side-panel ‡πÉ‡∏´‡πâ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ */
        .side-panel { 
            transition: transform 0.3s ease-in-out; 
            transform: translateX(100%); 
            background: rgba(200, 200, 200, 1.0); /* ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ 95% */            
            z-index: 1010;
            box-shadow: -5px 0 25px rgba(0,0,0,0.15); /* ‡πÄ‡∏á‡∏≤‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô */
        }
        .form-label { 
            font-size: 0.85rem; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
            font-weight: 700; 
            color: #dc2626; /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
            margin-bottom: 0.2rem; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á */
            display: block;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8); /* ‡πÄ‡∏á‡∏≤‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß */
        }
        .form-input { 
            width: 100%; 
            padding: 0.5rem 0.75rem; /* ‡πÄ‡∏û‡∏¥‡πà‡∏° padding */
            font-size: 0.9rem; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
            font-weight: 600; /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏≤ */
            color: #2563eb; /* ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô */
            background-color: rgba(255, 255, 255, 0.6); /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™ */
            border: 1.5px solid #d1d5db; /* ‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏ô‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô */
            border-radius: 0.3rem; 
            outline: none;
            transition: border-color 0.2s ease;
        }
        .form-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2); /* ‡πÄ‡∏á‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
        }
        .form-input::placeholder {
            color: #9ca3af; /* ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö placeholder */
            font-style: italic;
        }
        .side-panel.open { transform: translateX(0); }
        
        /* ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢/‡∏¢‡∏∑‡∏î‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ */
        .map-btn { 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢/‡∏¢‡∏∑‡∏î */
            transform: none !important;
            transition: background-color 0.2s, color 0.2s !important;
        }
        .map-btn:active,
        .map-btn:focus,
        .map-btn:hover {
            transform: none !important;
            scale: none !important;
        }
        .active-tool { 
            background-color: #2563eb !important; 
            color: white !important; 
            border: 2px solid white;
            transform: none !important;
        }

        .active-edit { 
            background-color: #2563eb !important; 
            color: white !important; 
            border: 2px solid white !important;
            transform: none !important;
        }

        /* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏Ñ‡∏ó‡∏µ‡∏ü */
        .active-tool i,
        .active-tool svg {
            color: white !important;
            stroke: white !important;
        }

        /* ‡∏Ç‡πâ‡∏≠ 2: ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å (‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á = ‡πÄ‡∏™‡πâ‡∏ô‡∏ú‡πà‡∏≤‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å 70px) */
        .confirm-btn-overlay {
        position: absolute;
        bottom: calc(2.5rem + 4.375rem + 4.375rem); /* bottom-10 (40px) + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏õ‡∏∏‡πà‡∏° (70px) + ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á (70px) */
        left: 50%;
        transform: translateX(-50%);
        z-index: 1005;
        }
        /* ‚úÖ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ü‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á - ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏™‡∏°‡∏π‡∏ó */
        #settings-menu {
            transition: all 0.2s ease-in-out;
        }

        #settings-menu button {
            opacity: 0;
            transform: translateY(-20px);
            /* ‚úÖ ‡∏£‡∏∞‡∏ö‡∏∏ property ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ + ‡πÉ‡∏ä‡πâ cubic-bezier */
            transition: 
                opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: opacity, transform;  /* ‚úÖ ‡∏ö‡∏≠‡∏Å‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° GPU */
        }

        #settings-menu button:hover {
            transform: translateY(0) scale(1.05) !important;
            transition: transform 0.2s ease-out !important;
        }

        /* ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡∏Å */
        #settings-menu {
            backface-visibility: hidden;
            perspective: 1000px;
        }
        /* ============================================
           ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡πÅ‡∏ú‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏•)
           ============================================ */
        #side-panel input[type="number"]::-webkit-inner-spin-button,
        #side-panel input[type="number"]::-webkit-outer-spin-button {
          -webkit-appearance: none !important;
          margin: 0 !important;
        }

        #side-panel input[type="number"] {
          -moz-appearance: textfield !important; /* Firefox */
          appearance: textfield !important; /* Standard */
        }

        /* ============================================
        ‡∏ã‡πà‡∏≠‡∏ô‡∏•‡∏π‡∏Å‡∏®‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
        ============================================ */
        #calc-width::-webkit-inner-spin-button,
        #calc-width::-webkit-outer-spin-button,
        #calc-length::-webkit-inner-spin-button,
        #calc-length::-webkit-outer-spin-button,
        #calc-result::-webkit-inner-spin-button,
        #calc-result::-webkit-outer-spin-button {
          -webkit-appearance: none !important;
          margin: 0 !important;
        }

        #calc-width,
        #calc-length,
        #calc-result {
          -moz-appearance: textfield !important;
          appearance: textfield !important;
        }

        /* ========== ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏á + ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å ========== */
        #crosshair {
          transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                      opacity 0.6s ease;
          transform: translate(-50%, -50%) translateY(100vh); /* ‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á + ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á */
          opacity: 0;
          will-change: transform, opacity;
        }
        #crosshair.visible {
          transform: translate(-50%, -50%) translateY(0); /* ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á + ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ */
          opacity: 1;
        }

        #add-trigger-container {
          transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                      opacity 0.6s ease;
          transform: translateX(-50%) translateY(100vh); /* ‡∏£‡∏ß‡∏°‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á + ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏á */
          opacity: 0;
          will-change: transform, opacity;
        }
        #add-trigger-container.visible {
          transform: translateX(-50%) translateY(0); /* ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á + ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏Å‡∏ï‡∏¥ */
          opacity: 1;
        }
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡πà‡∏á‡∏Æ‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏ß‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
        #map {
          transform: translate3d(0, 0, 0);
          will-change: transform;
        }

        /* ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∑‡πà‡∏ô) */
        .leaflet-zoom-anim .circle-marker,
        .leaflet-zoom-anim .crosshair {
          display: none !important;
        }
        /* ============================================
           ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Å‡∏é‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
           ============================================ */
        @media (max-width: 768px) {
            /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô */
            #crosshair,
            #add-trigger-container {
                transition-duration: 0.35s;
            }
            
            /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏•‡∏∞‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å */
            .side-panel .form-input {
                font-size: 0.8125rem !important; /* 13px */
                padding: 0.4rem 0.6rem !important;
            }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πÄ‡∏ö‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏î‡∏∏‡∏• */
            .side-panel .form-label {
                font-size: 0.8125rem !important;
                margin-bottom: 0.2rem !important;
            }
            
            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á */
            .side-panel button[onclick*="camera"] {
                padding: 0.5rem !important;
                font-size: 0.75rem !important;
            }
        }
        /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        @media (max-width: 768px) {
            .calc-btn-a {
                width: 40px !important;
                height: 40px !important;
                font-size: 16px !important;
                right: 4px !important;
            }
            .input-area-wrapper {
                padding-right: 3.5rem !important;
            }
        }
        /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á <style> */
        @media (max-width: 768px) {
            .grid.grid-cols-2 {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
            .grid.grid-cols-2 .form-label {
                font-size: 0.75rem !important;
            }
            .grid.grid-cols-2 .form-input {
                font-size: 0.8125rem !important;
                padding: 0.4rem 0.5rem !important;
            }
        }
        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á */
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin {
          animation: spin 0.5s linear;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û */
        #image-gallery-modal {
        }

        #gallery-grid::-webkit-scrollbar {
          width: 8px;
        }

        #gallery-grid::-webkit-scrollbar-track {
          background: #1f2937;
        }

        #gallery-grid::-webkit-scrollbar-thumb {
          background: #4b5563;
          border-radius: 4px;
        }

        #gallery-grid::-webkit-scrollbar-thumb:hover {
          background: #6b7280;
        }
        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal */
        @keyframes scale-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes scale-out {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.9); }
        }
        .animate-scale-in { animation: scale-in 0.2s ease-out; }
        .animate-scale-out { animation: scale-out 0.2s ease-in; }
        /* PWA Install Prompt Animation */
        @keyframes slideUp {
          from { transform: translate(-50%, 20px); opacity: 0; }
          to { transform: translate(-50%, 0); opacity: 1; }
        }

        #installPrompt {
          animation: slideUp 0.3s ease-out;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #installPrompt.hidden {
          display: none;
        }
        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-fade-out { animation: fade-out 0.3s ease-in; }
        /* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î */
        @keyframes flash-green {
            0%, 100% { background-color: white; }
            50% { background-color: #22c55e; color: white; }
        }
        .refresh-success { animation: flash-green 0.5s ease 3; }

        /* ‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fade-out {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-fade-out { animation: fade-out 0.3s ease-in; }

        .circle-marker {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
        }
        .circle-building { background-color: #f97316; }
        .circle-sign { background-color: #22c55e; }
        
        .user-location-dot {
            width: 14px; height: 14px;
            background-color: #2563eb;
            border: 2px solid white;
            border-radius: 50%;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
        .data-table-panel {
            position: fixed;
            bottom: 5px;
            left: 5px;
            width: 90%;
            max-width: 900px;
            max-height: 45vh; /* ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å 60vh ‡πÄ‡∏õ‡πá‡∏ô 47vh */
            height: 45vh; /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ñ‡∏á‡∏ó‡∏µ‡πà 47% */
            background: white;
            border-radius: 6px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1003;
            display: none;
            flex-direction: column;
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        .data-table-panel.open {
            display: flex;
            transform: translateY(0);
        }
        .data-table-panel.open {
            display: flex;
            transform: translateY(0);
        }
        .table-header {
            background: linear-gradient(135deg, #667eea 0%, #db2777 100%);
            color: white;
            padding: 0.1rem 0.5rem;
            min-height: 20px;       /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á */
            height: 44px;  
            gap: 0.25rem;    
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .table-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .table-tab {
            padding: 6px 6px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .table-tab.active {
            background: white;
            color: #667eea;
        }
        .table-tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }
        .table-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .data-table th {
            background: #f3f4f6;
            padding: 6px 8px;
            text-align: left;
            font-weight: 700;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .data-table td {
            padding: 4px;
            border-bottom: 1px solid #e5e7eb;
            vertical-align: middle;
        }
        .data-table tr:hover {
            background: #f9fafb;
        }
        .data-table tr:nth-child(even) {
            background: #f9fafb;
        }
        /* ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏≤‡∏™ text-center ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ */
        .data-table th.text-center,
        .data-table td.text-center {
            text-align: center !important; /* ‚úÖ ‡πÉ‡∏ä‡πâ !important ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏±‡∏ö‡∏Å‡∏é‡πÄ‡∏î‡∏¥‡∏° */
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .status-‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à { background: #fef3c7; color: #92400e; }
        .status-‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß { background: #d1fae5; color: #065f46; }
        .status-‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß { background: #fee2e2; color: #991b1b; }
        .zoom-btn {
            padding: 4px 10px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .zoom-btn:hover {
            background: #1d4ed8;
            transform: scale(1.05);
        }
        .marker-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }
        .marker-building { background-color: #f97316; }
        .marker-sign { background-color: #22c55e; }
    </style>
</head>
<!-- Custom Modal Dialogs -->
<!-- Modal ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö -->
<div id="confirm-delete-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[2000] hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-scale-in">
        <div class="p-6">
            <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                <i data-lucide="trash-2" class="w-8 h-8 text-red-600"></i>
            </div>
            <h3 id="delete-modal-title" class="text-xl font-bold text-center text-gray-900 mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
            <p id="delete-modal-message" class="text-center text-gray-600 mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ?</p>
            
            <div class="flex gap-3">
                <button onclick="cancelDelete()" class="flex-1 py-3 px-6 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all active:scale-95">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button onclick="confirmDeleteAction()" class="flex-1 py-3 px-6 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                    ‡∏•‡∏ö
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
<div id="edit-mode-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-[2000] hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-scale-in">
        <div class="p-6">
            <div class="flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mx-auto mb-4">
                <i data-lucide="move" class="w-8 h-8 text-blue-600"></i>
            </div>
            <h3 class="text-xl font-bold text-center text-gray-900 mb-2">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h3>
            <p class="text-center text-gray-600 mb-6">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</p>
            
            <div class="flex justify-center">
                <button onclick="closeEditModeModal()" class="py-3 px-8 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all active:scale-95">
                    ‡∏ï‡∏Å‡∏•‡∏á
                </button>
            </div>
        </div>
    </div>
</div>
<body class="bg-gray-100">

    <div id="map"></div>

    <!-- ‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á -->
    <div id="crosshair" class="crosshair hidden">
        <div class="crosshair-circle">
            <div class="crosshair-line line-v v-top"></div>
            <div class="crosshair-line line-v v-bottom"></div>
            <div class="crosshair-line line-h h-left"></div>
            <div class="crosshair-line line-h h-right"></div>
        </div>
        <div class="crosshair-center"></div>
    </div>

    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏° - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÉ‡∏ô HTML -->
    <div id="confirm-overlay" class="confirm-btn-overlay hidden">
        <button id="btn-confirm-action" onclick="confirmCapture()" 
                class="flex items-center gap-2 px-6 py-4 rounded-full text-white font-bold shadow-2xl active:scale-95 transition-all text-lg border-4 border-white">
            <i data-lucide="check-circle" class="w-6 h-6"></i>
            <span id="confirm-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î</span>
        </button>
    </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä (‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢) -->
        <div class="absolute top-4 left-4 z-[1001]">
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á (‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å) -->
          <button id="btn-settings" onclick="toggleSettingsMenu()" class="map-btn p-3 text-gray-600 hover:text-blue-600 transition-all relative group mb-2">
            <i data-lucide="settings-2" id="settings-icon" class="w-6 h-6"></i>
            <!-- ‡∏à‡∏∏‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
            <span id="settings-badge" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span>
          </button>
          
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä -->
          <button id="btn-refresh" onclick="refreshData()" class="map-btn p-3 text-blue-600 transition-all">
            <i data-lucide="refresh-cw" id="refresh-icon" class="w-6 h-6"></i>
          </button>
          
          <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏°‡∏≤ -->
          <div id="settings-menu" class="mt-2 space-y-2 hidden">
            <!-- ‡∏õ‡∏∏‡πà‡∏° 1: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á -->
            <button onclick="exportBuildingGeoJSON()" class="map-btn p-3 w-48 bg-gradient-to-r from-orange-400 to-orange-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
              <i data-lucide="home" class="w-5 h-5"></i>
              <span class="text-xs font-bold">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</span>
            </button>
            <!-- ‡∏õ‡∏∏‡πà‡∏° 2: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏õ‡πâ‡∏≤‡∏¢ -->
            <button onclick="exportSignGeoJSON()" class="map-btn p-3 w-48 bg-gradient-to-r from-green-400 to-green-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
              <i data-lucide="map-pin" class="w-5 h-5"></i>
              <span class="text-xs font-bold">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏õ‡πâ‡∏≤‡∏¢</span>
            </button>
            <!-- ‡∏õ‡∏∏‡πà‡∏° 3: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á -->
            <button onclick="loadBuildingImages()" class="map-btn p-3 w-48 bg-gradient-to-r from-blue-400 to-blue-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
              <i data-lucide="image" class="w-5 h-5"></i>
              <span class="text-xs font-bold">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</span>
            </button>
            <!-- ‡∏õ‡∏∏‡πà‡∏° 4: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏õ‡πâ‡∏≤‡∏¢ -->
            <button onclick="loadSignImages()" class="map-btn p-3 w-48 bg-gradient-to-r from-purple-400 to-purple-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
              <i data-lucide="gallery-horizontal" class="w-5 h-5"></i>
              <span class="text-xs font-bold">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏õ‡πâ‡∏≤‡∏¢</span>
            </button>
            <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° 5: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á (parcel) -->
            <button onclick="downloadMapFile('parcel')" class="map-btn p-3 w-48 bg-gradient-to-r from-yellow-400 to-yellow-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
                <i data-lucide="download" class="w-5 h-5"></i>
                <div>
                    <div class="font-semibold text-xs">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á</div>
                    <div class="text-[10px] opacity-90">‡πÑ‡∏ü‡∏•‡πå parcel.geojson</div>
                </div>
            </button>
            <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° 6: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï -->
            <button onclick="downloadMapFile('boundary')" class="map-btn p-3 w-48 bg-gradient-to-r from-red-400 to-red-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
                <i data-lucide="download" class="w-5 h-5"></i>
                <div>
                    <div class="font-semibold text-xs">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï</div>
                    <div class="text-[10px] opacity-90">‡πÑ‡∏ü‡∏•‡πå boundary.geojson</div>
                </div>
            </button>
            <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° 7: ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á -->
            <button onclick="downloadMapFile('building')" class="map-btn p-3 w-48 bg-gradient-to-r from-orange-400 to-orange-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
                <i data-lucide="download" class="w-5 h-5"></i>
                <div>
                    <div class="font-semibold text-xs">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</div>
                    <div class="text-[10px] opacity-90">‡πÑ‡∏ü‡∏•‡πå building.geojson</div>
                </div>
            </button>
            <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° 8: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á 3 ‡πÑ‡∏ü‡∏•‡πå) -->
            <button onclick="selectMapFile()" class="map-btn p-3 w-48 bg-gradient-to-r from-teal-400 to-teal-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
                <i data-lucide="folder-open" class="w-5 h-5"></i>
                <div>
                    <div class="font-semibold text-xs">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
                    <div class="text-[10px] opacity-90">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå .geojson</div>
                </div>
            </button>
            <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏° 9: ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà -->
            <button onclick="clearMapData()" class="map-btn p-3 w-48 bg-gradient-to-r from-red-400 to-red-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
            <i data-lucide="trash-2" class="w-5 h-5"></i>
            <div>
            <div class="font-semibold text-xs">‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
            <div class="text-[10px] opacity-90">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            </button>
            <!-- ‚úÖ Input ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå -->
            <input type="file" id="map-file-input" accept=".geojson,.json" class="hidden" onchange="handleMapFileSelect(event)">
          </div>
        </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç -->
    <div class="absolute top-4 right-4 z-[1001] flex flex-row gap-2">
        <!-- ‚úÖ ‡∏•‡∏ö active:scale-95 ‡∏´‡∏£‡∏∑‡∏≠ similar ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ -->
        <button id="btn-building" onclick="activateTool('building')" class="map-btn p-3" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á">
            <i data-lucide="home" class="w-6 h-6 text-orange-500"></i>
        </button>
        <button id="btn-sign" onclick="activateTool('sign')" class="map-btn p-3" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡πâ‡∏≤‡∏¢">
            <i data-lucide="map-pin" class="w-6 h-6 text-green-500"></i>
        </button>
        <button id="btn-edit" onclick="toggleEditMode()" class="map-btn p-3" title="‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á">
            <i data-lucide="move" class="w-6 h-6 text-red-600"></i>
        </button>
        <button id="btn-mouse-add-mode" onclick="toggleMouseAddMode()" class="map-btn p-3" title="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå)">
            <i data-lucide="plus" class="w-6 h-6 text-blue-600"></i>
        </button>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô -->
    <div class="absolute bottom-4 left-4 z-[1001]">
    <button onclick="locateUser()" class="map-btn p-3 shadow-lg border-2 border-blue-100">
    <div class="user-location-dot"></div>
    </button>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å (Add Trigger) -->
    <div id="add-trigger-container" class="absolute bottom-10 left-1/2 -translate-x-1/2 z-[1001] hidden">
        <button onclick="showConfirmButton()" class="p-4 bg-blue-600/50 text-white rounded-full shadow-xl border-[3px] border-white active:scale-90 transition-all">
            <i data-lucide="plus" class="w-8 h-8"></i>
        </button>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á -->
    <div class="absolute bottom-4 right-4 z-[1002]">
        <button id="btn-show-table" onclick="toggleTable()" class="map-btn p-3 bg-white hover:bg-blue-50">
            <i data-lucide="table" id="table-icon" class="w-6 h-6 text-blue-600"></i>
        </button>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div id="data-table-panel" class="data-table-panel">
        <div class="table-header">
            <div class="flex items-center gap-2">
                <div class="table-tabs">
                    <div class="table-tab active" onclick="switchTableTab('building')">
                        <span>‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</span>
                        <span id="building-count-badge" class="ml-2 px-2 py-0.5 bg-orange-400 text-white text-xs rounded-full font-medium">0</span>
                    </div>
                    <div class="table-tab" onclick="switchTableTab('sign')">
                        <span>‡∏õ‡πâ‡∏≤‡∏¢</span>
                        <span id="sign-count-badge" class="ml-2 px-2 py-0.5 bg-green-500 text-white text-xs rounded-full font-medium">0</span>
                    </div>
                </div>
            </div>
            <button onclick="toggleTable()" class="p-1.5 hover:bg-white/20 rounded-full">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>
        <div class="table-content">
            <div id="building-table-container" class="table-tab-content">
                <table class="data-table" id="building-table">
                    <thead>
                        <tr>
                            <th style="width: 30px"><i data-lucide="map-pin" class="w-4 h-4"></i></th>
                            <th class="sortable-header" data-sort="building_c">‡∏£‡∏´‡∏±‡∏™</th>
                            <th class="sortable-header" data-sort="full_name">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</th>
                            <th class="text-center sortable-header" data-sort="hs_no">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th class="text-center sortable-header" data-sort="hs_moo">‡∏´‡∏°‡∏π‡πà</th>
                            <th class="sortable-header" data-sort="b_type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                            <th class="text-center sortable-header" data-sort="b_mat">‡∏ß‡∏±‡∏™‡∏î‡∏∏</th>
                            <th class="text-center sortable-header" data-sort="no_floor">‡∏ä‡∏±‡πâ‡∏ô</th>
                            <th class="text-center sortable-header" data-sort="b_area">‡∏û.‡∏ó.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á(‡∏ï‡∏£.‡∏°.)</th>
                            <th class="text-center sortable-header" data-sort="b_year">‡∏≠‡∏≤‡∏¢‡∏∏</th>
                            <th class="sortable-header" data-sort="b_note">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                            <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß -->
                            <th class="sortable-header bg-custom-green" data-sort="b_use">‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå</th>
                            <th class="sortable-header bg-custom-green" data-sort="buse_area">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
                            <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏≤‡∏™‡∏û‡∏∑‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (‡πÉ‡∏ä‡πâ bg-custom-pink ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß) -->
                            <th class="sortable-header bg-custom-pink" data-sort="b_use2">‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå(2)</th>
                            <th class="sortable-header bg-custom-pink" data-sort="buse_area2">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ(2)</th>
                            <th class="sortable-header" data-sort="land_use">‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô</th>
                            <th class="sortable-header" data-sort="check">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                            <th style="width: 60px">‡∏ã‡∏π‡∏°</th>
                        </tr>
                    </thead>
                    <tbody id="building-table-body">
                        <tr>
                            <td colspan="15" class="text-center py-8 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="sign-table-container" class="table-tab-content hidden">
                <table class="data-table" id="sign-table">
                    <thead>
                        <tr>
                            <th style="width: 30px"><i data-lucide="map-pin" class="w-4 h-4"></i></th>
                            <th class="sortable-header" data-sort="s_code">‡∏£‡∏´‡∏±‡∏™</th>
                            <th class="sortable-header" data-sort="s_characte">‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞</th>
                            <th class="text-center sortable-header" data-sort="s_wide">‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏ã.‡∏°.)</th>
                            <th class="text-center sortable-header" data-sort="s_length">‡∏¢‡∏≤‡∏ß (‡∏ã.‡∏°.)</th>
                            <th class="text-center sortable-header" data-sort="no_side">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô</th>
                            <th class="sortable-header" data-sort="s_text">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th>
                            <th class="sortable-header" data-sort="check">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                            <th style="width: 60px">‡∏ã‡∏π‡∏°</th>
                        </tr>
                    </thead>
                    <tbody id="sign-table-body">
                        <tr>
                            <td colspan="8" class="text-center py-8 text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á) -->
    <div id="image-preview-container" class="data-table-panel" style="display: none; z-index: 1004; bottom: 5px; transform: translateY(0);">
        <div class="table-header" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);">
            <div class="flex items-center justify-between w-full">
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-white text-sm">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
                </div>
                <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û -->
                <button onclick="hideImagePreview()" class="p-2 hover:bg-white/20 rounded-full transition">
                    <i data-lucide="x" class="w-5 h-5 text-white"></i>
                </button>
            </div>
        </div>
        <div class="table-content flex items-center justify-center p-4">
            <img id="image-preview" src="" alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" class="max-w-full max-h-full object-contain hidden">
            <div id="image-preview-placeholder" class="text-gray-300 text-sm">
                ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÅ‡∏ú‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà
            </div>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
    <div id="side-panel" class="side-panel fixed top-0 right-0 w-[44vw] sm:w-[280px] h-full z-[1002] shadow-2xl flex flex-col">
        <!-- ‚úÖ ‡∏•‡∏î padding ‡∏à‡∏≤‡∏Å p-4 ‡πÄ‡∏õ‡πá‡∏ô p-2 ‡πÅ‡∏•‡∏∞‡∏•‡∏î gap ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á title ‡∏Å‡∏±‡∏ö latlng -->
        <div class="p-2 pb-3 border-b flex justify-between items-center bg-gray-50">
            <div>
                <h2 id="panel-title" class="font-bold text-blue-900 text-lg leading-tight">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <p id="latlng-display" class="text-[9px] text-gray-500 font-mono mt-0.5"></p>
            </div>
            <button onclick="closePanel()" class="p-1.5 hover:bg-gray-200 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
        </div>
        <form id="survey-form" class="flex-1 overflow-y-auto p-3 space-y-2"></form>
        <div class="p-2 bg-white border-t">
            <button type="button" onclick="saveSurveyData()" class="w-full bg-blue-600 text-white py-2.5 rounded-md font-bold flex items-center justify-center gap-2 text-sm">
                <i data-lucide="save" class="w-4 h-4"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
        </div>
    </div>

    <script>
        const CONFIG = {
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyFWpmT-X62o3H_leBlJ35qLJv3I57We_DzlvcmQLwm-NcIwLM3k-GFq_namGrG8zylMw/exec'
        };

    // ‚úÖ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        let map;
        let activeTool = null;
        let isEditMode = false;
        let surveyLayers = L.layerGroup();
        let editingMarker = null;
        let markersBeingMoved = new Set(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ - ‡πÄ‡∏Å‡πá‡∏ö rowKey ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞ Cache
        let allBuildings = []; 
        let allSigns = [];   
        let movingMarkerId = null; // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö ID ‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏≤‡∏Å‡∏≠‡∏¢‡∏π‡πà  
        
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

        let autoUpdateInterval = null;
        let isUpdating = false;
        let isUploadingImage = false; // [cite: 71]

        let canvasRenderer; // ‚úÖ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏Å‡∏•‡∏ö‡∏≠‡∏•

        // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        let isRefreshing = false;  // ‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î
        let lastAutoRefreshTime = 0;  // ‚úÖ ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        const AUTO_REFRESH_COOLDOWN = 30000;  // ‚úÖ 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (30000ms)

        function initMap() {
            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Canvas Renderer 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            canvasRenderer = L.canvas({ padding: 0.5 });
            
            const mapOptions = {
                zoomControl: false,
                attributionControl: false,
                preferCanvas: true,
                renderer: canvasRenderer, // ‚úÖ ‡πÉ‡∏ä‡πâ renderer ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
                zoomSnap: isMobile() ? 0.5 : 1,
                wheelDebounceTime: 40,
                doubleClickZoom: false
            };

          map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            preferCanvas: true,
            // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏•‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏à‡∏≠‡πÑ‡∏î‡πâ
            padding: [50, 50], // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏ö‡∏ô, ‡∏•‡πà‡∏≤‡∏á, ‡∏ã‡πâ‡∏≤‡∏¢, ‡∏Ç‡∏ß‡∏≤)
            maxBoundsViscosity: 0.5, // ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏∑‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï (‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô)
            inertia: true, // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏¥‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏ä‡∏µ‡∏¢
            inertiaDeceleration: 3000, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏≤‡∏£‡∏ä‡∏∞‡∏•‡∏≠‡∏ï‡∏±‡∏ß
            inertiaMaxSpeed: 1500, // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
            // ‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏•‡πâ‡∏ô‡πÑ‡∏î‡πâ)
            // maxBounds: undefined
          }).setView([15.196, 102.141], 14);

          // Hardware Acceleration
          const container = map.getContainer();
          container.style.transform = 'translate3d(0, 0, 0)';
          
        // Google Hybrid Tile Options - ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û
        const tileOptions = {
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
            updateWhenIdle: false, // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏ì‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏´‡∏¢‡∏∏‡∏î)
            updateWhenZooming: true, // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡∏ì‡∏∞‡∏ã‡∏π‡∏°
            keepBuffer: isMobile() ? 6 : 10, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ü‡πÄ‡∏ü‡∏≠‡∏£‡πå (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ 4, ‡∏Ñ‡∏≠‡∏° 8)
            maxNativeZoom: 19, // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ó‡∏•‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ
            reuseTiles: true, // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÑ‡∏ó‡∏•‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ã‡πâ‡∏≥‡πÅ‡∏ó‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
            className: 'map-tiles-optimized'
        };

        // Low Res / Background Layer
        const lowResLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            ...tileOptions,
            maxZoom: 15,
            zIndex: 1
        });

        // High Res Layer
        const highResLayer = L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            ...tileOptions,
            minZoom: 16,
            maxZoom: 22,
            zIndex: 2
        });

          lowResLayer.addTo(map);
          highResLayer.addTo(map);
          surveyLayers.addTo(map);
        }
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
        function isMobile() {
          return /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô activateTool ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ mouseAddType
        function activateTool(tool) {
            // ‚úÖ 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (isEditMode) {
                isEditMode = false;
                document.getElementById('btn-edit').classList.remove('active-edit');
                surveyLayers.eachLayer(l => l.dragging && l.dragging.disable());
            }

            // 2. ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°)
            if (activeTool === tool) {
                deactivateTools();
                return;
            }

            // 3. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
            activeTool = tool;
            
            // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
            document.getElementById('btn-building').classList.remove('active-tool');
            document.getElementById('btn-sign').classList.remove('active-tool');
            
            // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            if (tool === 'building') {
                document.getElementById('btn-building').classList.add('active-tool');
            } else if (tool === 'sign') {
                document.getElementById('btn-sign').classList.add('active-tool');
            }

            // 4. ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠ NOT ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå)
            if (!mouseAddMode) {
                const crosshair = document.getElementById('crosshair');
                const addTrigger = document.getElementById('add-trigger-container');
                crosshair.classList.remove('hidden');
                addTrigger.classList.remove('hidden');
                void crosshair.offsetWidth;
                void addTrigger.offsetWidth;
                crosshair.classList.add('visible');
                addTrigger.classList.add('visible');
            } else {
                const crosshair = document.getElementById('crosshair');
                const addTrigger = document.getElementById('add-trigger-container');
                crosshair.classList.add('hidden');
                addTrigger.classList.add('hidden');
            }

            document.getElementById('confirm-overlay').classList.add('hidden');
            // ‚úÖ ‡∏Å‡∏î‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            triggerAutoRefresh();
        }

        // ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        let mapCache = {};

        function cacheCurrentView() {
            const bounds = map.getBounds();
            const zoom = map.getZoom();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Ñ‡∏ä
            const cacheKey = `${bounds.getNorth()},${bounds.getEast()},${bounds.getSouth()},${bounds.getWest()}_${zoom}`;
            
            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡πÅ‡∏Ñ‡∏ä
            mapCache[cacheKey] = {
                timestamp: new Date().toISOString(),
                bounds: bounds,
                zoom: zoom
            };
            
            console.log(`‡πÅ‡∏Ñ‡∏ä‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${cacheKey}`);
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ
        function loadCachedMapViews() {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage
            const cached = localStorage.getItem('mapCache');
            if (cached) {
                mapCache = JSON.parse(cached);
                console.log('‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏Ñ‡∏ä‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('mapCache', JSON.stringify(mapCache));
        });

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ
        loadCachedMapViews();

        function deactivateTools() {
          activeTool = null;
          document.getElementById('btn-building').classList.remove('active-tool');
          document.getElementById('btn-sign').classList.remove('active-tool');
          
          const crosshair = document.getElementById('crosshair');
          const addTrigger = document.getElementById('add-trigger-container');
          
          // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á
          crosshair.classList.remove('visible');
          addTrigger.classList.remove('visible');
          
          // ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÜ
          setTimeout(() => {
            crosshair.classList.add('hidden');
            addTrigger.classList.add('hidden');
            document.getElementById('confirm-overlay').classList.add('hidden');
          }, 400); // ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡∏ô 0.4s
        }

        // ============================================
        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏π‡πÄ‡∏Å‡∏¥‡πâ‡∏•‡πÑ‡∏î‡∏£‡πå‡∏ü (‡∏£‡∏ß‡∏° 3 ‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
        // ============================================
        const MAP_CONFIG = {
            // ‚úÖ Parcel Layer
            parcel: {
                googleDriveFileId: '1SMsX1sXaugcy3HMyep85o684S82s6lAm',
                fileName: 'parcel.geojson',
                layers: ['parcel'],
                localCacheKey: 'parcel_geojson_cache',
                lastModifiedKey: 'parcel_geojson_last_modified',
                lastCheckKey: 'parcel_geojson_last_check',
            },
            // ‚úÖ Boundary Layer
            boundary: {
                googleDriveFileId: '1V9sGcXeM91QyBA9dPjlBph7u--qJ_ERx',
                fileName: 'boundary.geojson',
                layers: ['boundary'],
                localCacheKey: 'boundary_geojson_cache',
                lastModifiedKey: 'boundary_geojson_last_modified',
                lastCheckKey: 'boundary_geojson_last_check',
            },
            // ‚úÖ Building Layer
            building: {
                googleDriveFileId: '1TliaF3dkFQBsdaWjdmv_-nHuCs85tW_3',
                fileName: 'building.geojson',
                layers: ['building'],
                localCacheKey: 'building_geojson_cache',
                lastModifiedKey: 'building_geojson_last_modified',
                lastCheckKey: 'building_geojson_last_check',
            }
        };

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btnEdit = document.getElementById('btn-edit');

            if (isEditMode) {
                // ‚úÖ 1. ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå
                if (mouseAddMode) {
                    mouseAddMode = false;
                    document.getElementById('btn-mouse-add-mode').classList.remove('active-tool');
                    document.getElementById('map').classList.remove('cursor-crosshair-add');
                    document.getElementById('map').style.cursor = 'default';
                }

                // ‚úÖ 2. ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏õ‡πâ‡∏≤‡∏¢
                activeTool = null;
                document.getElementById('btn-building').classList.remove('active-tool');
                document.getElementById('btn-sign').classList.remove('active-tool');
                
                // ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á
                document.getElementById('crosshair').classList.add('hidden');
                document.getElementById('add-trigger-container').classList.add('hidden');

                btnEdit.classList.add('active-edit');

                // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå
                surveyLayers.eachLayer(function(layer) {
                    if (layer._popupData && layer.dragging && layer.dragging.enable) {
                        layer.dragging.enable();
                        layer.off('dragend');
                        layer.on('dragend', async function(e) {
                            const newLatLng = e.target.getLatLng();
                            const marker = e.target;
                            const data = marker._popupData;
                            if (data) {
                                await updateMarkerPosition(marker, data, newLatLng);
                            }
                        });
                    }
                });
                showEditModeModal();

                // ‚úÖ ‡∏Å‡∏î‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                triggerAutoRefresh();
            } else {
                btnEdit.classList.remove('active-edit');

                surveyLayers.eachLayer(function(layer) {
                    if (layer.dragging && layer.dragging.disable) {
                        layer.dragging.disable();
                    }
                });
                // ‚úÖ ‡∏Å‡∏î‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                triggerAutoRefresh();
            }
        }

        // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå
        let mouseAddMode = false;
        let mouseAddType = null; // 'building' ‡∏´‡∏£‡∏∑‡∏≠ 'sign'
        let mouseClickLatLng = null; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
        let mouseTempMarker = null; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
        // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå

        // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå
        function toggleMouseAddMode() {
            mouseAddMode = !mouseAddMode;
            const btn = document.getElementById('btn-mouse-add-mode');
            const mapContainer = document.getElementById('map');
            
            // ‚úÖ 1. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            if (mouseAddMode && isEditMode) {
                isEditMode = false;
                document.getElementById('btn-edit').classList.remove('active-edit');
                surveyLayers.eachLayer(l => l.dragging && l.dragging.disable());
            }
            
            if (mouseAddMode) {
                // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î
                btn.classList.add('active-tool');
                
                // ‚úÖ 2. Default: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                if (!activeTool) {
                    activeTool = 'building';
                    document.getElementById('btn-building').classList.add('active-tool');
                    document.getElementById('btn-sign').classList.remove('active-tool');
                }
                
                // ‚úÖ 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á Cursor ‡πÅ‡∏ö‡∏ö crosshair
                const pixmap = document.createElement('canvas');
                pixmap.width = 32;
                pixmap.height = 32;
                const ctx = pixmap.getContext('2d');
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(16, 4);
                ctx.lineTo(16, 28);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(4, 16);
                ctx.lineTo(28, 16);
                ctx.stroke();
                const cursorUrl = pixmap.toDataURL();
                
                // ‚úÖ 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ cursor ‡πÉ‡∏´‡πâ map container
                mapContainer.style.cursor = `url(${cursorUrl}) 16 16, crosshair !important`;
                mapContainer.classList.add('cursor-crosshair-add');
                
                // ‚úÖ 5. ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏±‡∏ö parcel layers (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å! ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô cursor ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠)
                if (window.parcelLayer) {
                    window.parcelLayer.eachLayer(function(layer) {
                        if (layer.options) {
                            layer.options.interactive = false;
                        }
                        // ‚úÖ ‡∏õ‡∏¥‡∏î pointer-events ‡∏î‡πâ‡∏ß‡∏¢ CSS
                        if (layer._path) {
                            layer._path.style.pointerEvents = 'none';
                        }
                    });
                }
                
                // ‚úÖ 6. ‡∏õ‡∏¥‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å
                document.getElementById('crosshair').classList.add('hidden');
                document.getElementById('add-trigger-container').classList.add('hidden');
                
                // ‚úÖ 7. ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                document.getElementById('confirm-overlay').classList.add('hidden');
                
                // ‚úÖ 8. ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                if (mouseTempMarker) {
                    surveyLayers.removeLayer(mouseTempMarker);
                    mouseTempMarker = null;
                }
                mouseClickLatLng = null;
                
                showNotificationLeft(`‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á`, 'info');
                
            } else {
                // ‚úÖ ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î
                btn.classList.remove('active-tool');
                
                // ‚úÖ 9. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï cursor ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô default
                mapContainer.style.cursor = 'default !important';
                mapContainer.classList.remove('cursor-crosshair-add');
                
                // ‚úÖ 10. ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏±‡∏ö parcel layers ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
                if (window.parcelLayer) {
                    window.parcelLayer.eachLayer(function(layer) {
                        if (layer.options) {
                            layer.options.interactive = true;
                        }
                        if (layer._path) {
                            layer._path.style.pointerEvents = 'auto';
                        }
                    });
                }
                
                // ‚úÖ 11. ‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î
                if (mouseTempMarker) {
                    surveyLayers.removeLayer(mouseTempMarker);
                    mouseTempMarker = null;
                }
                mouseClickLatLng = null;
                
                // ‚úÖ 12. ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏≤‡∏™‡πå
                document.getElementById('confirm-overlay').classList.add('hidden');
                
                showNotificationLeft('‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏°‡∏≤‡∏™‡πå', 'info');
            }
        }

        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏≤‡∏™‡πå)
        function initMouseAddMode() {
            console.log('üîß initMouseAddMode called');
            
            if (typeof map === 'undefined' || !map) {
                console.error('‚ùå Map not initialized yet');
                setTimeout(initMouseAddMode, 500);
                return;
            }
            
            map.on('click', function(e) {
                // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°
                if (!mouseAddMode) return;
                
                // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
                if (!activeTool) {
                    showNotificationLeft('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡πâ‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                    return;
                }
                
                // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô event ‡∏£‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏¢‡∏±‡∏á layer ‡∏≠‡∏∑‡πà‡∏ô
                if (e.originalEvent) {
                    L.DomEvent.stopPropagation(e.originalEvent);
                }
                
                const latlng = e.latlng;
                console.log('üìç Map clicked at:', latlng);
                
                // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                if (mouseTempMarker) {
                    surveyLayers.removeLayer(mouseTempMarker);
                }
                
                mouseTempMarker = L.circleMarker(latlng, {
                    radius: 8,
                    color: activeTool === 'building' ? '#f97316' : '#22c55e',
                    fillColor: activeTool === 'building' ? '#f97316' : '#22c55e',
                    fillOpacity: 0.8,
                    weight: 2
                });
                
                mouseTempMarker.addTo(surveyLayers);
                mouseClickLatLng = latlng;
                
                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                document.getElementById('confirm-overlay').classList.remove('hidden');
                
                // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
                const btn = document.getElementById('btn-confirm-action');
                const text = document.getElementById('confirm-text');
                if (activeTool === 'building') {
                    btn.style.backgroundColor = '#f97316';  // üü† ‡∏™‡∏µ‡∏™‡πâ‡∏° - ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
                    text.innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á";
                } else {
                    btn.style.backgroundColor = '#22c55e';  // üü¢ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß - ‡∏õ‡πâ‡∏≤‡∏¢
                    text.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡πâ‡∏≤‡∏¢";
                }
                showNotificationLeft(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß - ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°${activeTool === 'building' ? '‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' : '‡∏õ‡πâ‡∏≤‡∏¢'}`, 'info');
            });
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏≤‡∏™‡πå
        function showConfirmButtonForMouseMode() {
            console.log('üîò showConfirmButtonForMouseMode called'); // ‚úÖ debug
            
            const overlay = document.getElementById('confirm-overlay');
            const btn = document.getElementById('btn-confirm-action');
            const text = document.getElementById('confirm-text');
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏´‡∏≤ element ‡πÄ‡∏à‡∏≠‡πÑ‡∏´‡∏°
            if (!overlay) {
                console.error('‚ùå confirm-overlay not found!');
                return;
            }
            if (!btn) {
                console.error('‚ùå btn-confirm-action not found!');
                return;
            }
            if (!text) {
                console.error('‚ùå confirm-text not found!');
                return;
            }
            
            // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            if (activeTool === 'building') {
                btn.style.backgroundColor = '#f97316';
                text.innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á";
                console.log('üè† Setting for building');
            } else {
                btn.style.backgroundColor = '#22c55e';
                text.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡πâ‡∏≤‡∏¢";
                console.log('üìç Setting for sign');
            }
            
            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            overlay.classList.remove('hidden');
            console.log('‚úÖ Overlay shown');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î/‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î
        function disableRefreshButton() {
            const btn = document.getElementById('btn-refresh');
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
        }

        function enableRefreshButton() {
            const btn = document.getElementById('btn-refresh');
            btn.disabled = false;
            btn.style.opacity = '1';
            btn.style.cursor = 'pointer';
        }


        // ‡∏Ç‡πâ‡∏≠ 2: ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
        function showConfirmButton() {
            const overlay = document.getElementById('confirm-overlay');
            const btn = document.getElementById('btn-confirm-action');
            const text = document.getElementById('confirm-text');

            if (activeTool === 'building') {
                btn.style.backgroundColor = '#f97316'; 
                text.innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á";
            } else {
                btn.style.backgroundColor = '#22c55e';
                text.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡πâ‡∏≤‡∏¢";
            }
            overlay.classList.remove('hidden');
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏≤‡∏™‡πå)
        async function confirmCapture() {
            let latlng;
            
            // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏≤‡∏™‡πå ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å
            if (mouseAddMode && mouseClickLatLng) {
                latlng = mouseClickLatLng;
            } else {
                // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
                const containerPoint = L.point(map.getSize().x / 2, map.getSize().y * 0.35);
                latlng = map.containerPointToLatLng(containerPoint);
            }
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            document.getElementById('confirm-overlay').classList.add('hidden');
            
            // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏≤‡∏™‡πå ‚Üí ‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            if (mouseAddMode && mouseTempMarker) {
                // ‚úÖ ‡πÅ‡∏Ñ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏à‡∏∏‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)
                backgroundUpload(latlng, activeTool, mouseTempMarker);
                
                // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
                mouseTempMarker = null;
                mouseClickLatLng = null;
                
                showNotificationLeft(`‡πÄ‡∏û‡∏¥‡πà‡∏°${activeTool === 'building' ? '‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' : '‡∏õ‡πâ‡∏≤‡∏¢'}‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            } else {
                // ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏á ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏´‡∏°‡πà
                const tempMarker = createCircleMarker(latlng, activeTool, false, '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à');
                tempMarker.addTo(surveyLayers);
                backgroundUpload(latlng, activeTool, tempMarker);
                showNotificationLeft(`‡πÄ‡∏û‡∏¥‡πà‡∏°${activeTool === 'building' ? '‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' : '‡∏õ‡πâ‡∏≤‡∏¢'}‡πÅ‡∏•‡πâ‡∏ß`, 'success');
            }
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô backgroundUpload
        async function backgroundUpload(latlng, type, marker) {
          const refreshBtn = document.getElementById('btn-refresh');
          const refreshIcon = document.getElementById('refresh-icon');
          disableRefreshButton();
          refreshIcon.classList.add('animate-spin');
          
          // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
          const newId = `${type}_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
          
          // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô + ‡πÄ‡∏û‡∏¥‡πà‡∏° id
          const data = {
            id: newId, // ‚úÖ ID ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á
            lat_long: `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`,
            date_added: new Date().toISOString(),
            tempMarker: true
          };
          
          // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
          // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
          if (type === 'sign') {
            data.s_code = `99Z000-S${Date.now().toString().slice(-3)}`;  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ 99Z000-
            data.s_name = '';
            data.s_type = '';
            data.s_wide = '0';
            data.s_length = '0';
          } else {
            data.building_c = `99Z000-B${Date.now().toString().slice(-5)}`;
            data.full_name = '';
            data.b_type = '';
            data.b_area = '0';
          }
          
          // ‚úÖ ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÉ‡∏ô‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
          marker._popupData = { ...data, type: type, tempMarker: true };
          setupMarkerPopup(marker, marker._popupData, type);
          
          try {
            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
            const queueId = addToSyncQueue('quickAdd', type, data);
            marker._popupData = {
              ...data,
              type: type,
              tempMarker: true,
              queued: true,
              queueId: queueId
            };
            setupMarkerPopup(marker, marker._popupData, type);
            
            // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            await processSyncQueue();
            
            // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 60 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
            const maxWaitTime = 60000;
            const startTime = Date.now();
            let queueItem = syncQueue.find(q => q.id === queueId);
            
            while (queueItem && queueItem.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à' && (Date.now() - startTime) < maxWaitTime) {
              await new Promise(resolve => setTimeout(resolve, 500));
              queueItem = syncQueue.find(q => q.id === queueId);
            }
            
            // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)
            // ‚ö†Ô∏è ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
            await loadExistingData();
            
            // ‚úÖ ‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß - ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÜ
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
            setTimeout(() => {
              surveyLayers.eachLayer(layer => {
                if (layer._popupData && layer._popupData.tempMarker) {
                  // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÉ‡∏ä‡πâ ID)
                  const realMarkerExists = allBuildings.some(b => b.id === layer._popupData.id) || 
                                           allSigns.some(s => s.id === layer._popupData.id);
                  
                  if (realMarkerExists) {
                    // ‚úÖ ‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                    surveyLayers.removeLayer(layer);
                    console.log(`‚úÖ ‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß: ${layer._popupData.id} (‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏•‡πâ‡∏ß)`);
                  } else {
                    // ‚ö†Ô∏è ‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏ö (‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå)
                    console.log(`‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß: ${layer._popupData.id} (‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á)`);
                  }
                }
              });
              
              refreshIcon.classList.remove('animate-spin');
              refreshBtn.classList.add('refresh-success');
              
              setTimeout(() => {
                refreshBtn.classList.remove('refresh-success');
                enableRefreshButton();
              }, 2000);
              
              if (queueItem && queueItem.status === 'success') {
                showNotificationLeft('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
              } else {
                showNotificationLeft('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå)', 'warning');
              }
            }, 1000); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πá‡∏ô 1000ms ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
            
          } catch (err) {
            refreshIcon.classList.remove('animate-spin');
            enableRefreshButton();
            showNotificationLeft("‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message, 'error');
          }
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û - ‡πÅ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå)
        // ============================================
        async function saveSurveyData() {
            const form = document.getElementById('survey-form');
            if (!form) {
                showNotificationLeft('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                return;
            }
            
            // ‚úÖ ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÑ‡∏ü‡∏•‡πå)
            const formData = new FormData(form);
            const data = {};

            for (let [key, value] of formData.entries()) {
                if (key.endsWith('_temp')) continue; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                
                const input = form.querySelector(`[name="${key}"]`);
                if (input && input.type === 'checkbox') {
                    data[key] = input.checked ? 'TRUE' : 'FALSE';
                } else if (input && input.type !== 'file') {
                    data[key] = value.trim();
                }
            }

            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á
            if (form.querySelector('[name="b_use2"]')) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
                const disabledFields = [
                    'b_use2', 'per_use2', 'buse_floor2', 'buse_area2', 'ment_use2', 'full_area2',
                    'land_use' // ‡πÄ‡∏û‡∏¥‡πà‡∏° land_use ‡∏î‡πâ‡∏ß‡∏¢ (‡πÅ‡∏°‡πâ‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤)
                ];
                
                disabledFields.forEach(fieldId => {
                    const field = form.querySelector(`[name="${fieldId}"]`);
                    if (field) {
                        // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÅ‡∏°‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô + trim ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
                        const rawValue = field.value || '';
                        data[fieldId] = rawValue.trim();
                        console.log(`üì§ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤ ${fieldId} (disabled) ‡πÉ‡∏ô payload: "${data[fieldId]}"`);
                    }
                });
            }

            // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ "‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô" ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡πÑ‡∏°‡πà‡∏û‡∏∂‡πà‡∏á‡∏û‡∏≤‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô UI)
            const bUseField = form.querySelector('select[name="b_use"]');
            const bUse2Field = form.querySelector('select[name="b_use2"]');
            let computedLandUse = '';

            if (bUseField && bUse2Field) {
                const bUseValue = (bUseField.value || '').trim();
                const bUse2Value = (bUse2Field.value || '').trim();
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏î‡∏¥‡∏°
                if (bUseValue && bUse2Value) {
                    computedLandUse = '5-‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'; // ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
                } else if (bUseValue) {
                    computedLandUse = bUseValue; // ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å b_use ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                } else if (bUse2Value) {
                    computedLandUse = bUse2Value; // ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å b_use2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                }
                // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á ‚Üí ‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£)
            }

            // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà)
            data.land_use = computedLandUse;
            console.log('‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ land_use ‡πÉ‡∏´‡∏°‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:', data.land_use || '(‡∏ß‡πà‡∏≤‡∏á)');

            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏´‡∏•‡πà‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!)
            let latLongValue = '';

            // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡πà‡∏≠‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!)
            const latLongInput = form.querySelector('input[name="lat_long"]');
            if (latLongInput && latLongInput.value.trim() !== '') {
                latLongValue = latLongInput.value.trim();
                console.log('üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ã‡πà‡∏≠‡∏ô:', latLongValue);
            }

            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ã‡πà‡∏≠‡∏ô ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å #latlng-display
            if (!latLongValue) {
                const latlngDisplay = document.getElementById('latlng-display')?.innerText;
                if (latlngDisplay && latlngDisplay.trim() !== '' && latlngDisplay !== '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
                    latLongValue = latlngDisplay.trim();
                    console.log('üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å #latlng-display:', latLongValue);
                }
            }

            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            if (!latLongValue && editingMarker && editingMarker._popupData) {
                latLongValue = editingMarker._popupData.lat_long || '';
                console.log('üìç ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å _popupData:', latLongValue);
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!latLongValue || latLongValue.trim() === '') {
                showNotificationLeft('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                console.error('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á');
                console.log('- ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ã‡πà‡∏≠‡∏ô:', latLongInput?.value);
                console.log('- #latlng-display:', document.getElementById('latlng-display')?.innerText);
                console.log('- editingMarker._popupData:', editingMarker?._popupData);
                return;
            }

            data.lat_long = latLongValue;
            console.log('‚úÖ ‡πÉ‡∏ä‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î:', data.lat_long);
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            let markerType;
            let rowKey = null;
            let action = 'add';
            
            if (editingMarker && editingMarker._popupData) {
                markerType = editingMarker._popupData.type || (editingMarker._popupData.building_c ? 'building' : 'sign');
                rowKey = editingMarker._popupData.id || editingMarker._popupData._row_num;
                action = 'update';
            } else {
                markerType = document.getElementById('marker-type')?.value || 'building';
                action = 'add';
            }
            
            if (!markerType || !['building', 'sign'].includes(markerType)) {
                showNotificationLeft('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                return;
            }

            // ============================================
            // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
            // ============================================
            if (markerType === 'building') {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!data.building_c || data.building_c.trim() === '') {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô B001, B002, ...)
                    const existingCodes = allBuildings.map(b => b.building_c).filter(c => c);
                    let maxNum = 0;
                    existingCodes.forEach(code => {
                        const match = code.match(/^B(\d+)$/);
                        if (match) {
                            maxNum = Math.max(maxNum, parseInt(match[1]));
                        }
                    });
                    data.building_c = `B${String(maxNum + 1).padStart(3, '0')}`;
                    console.log(`üè∑Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${data.building_c}`);
                }
            } else if (markerType === 'sign') {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏õ‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!data.s_code || data.s_code.trim() === '') {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏ä‡πà‡∏ô S001, S002, ...)
                    const existingCodes = allSigns.map(s => s.s_code).filter(c => c);
                    let maxNum = 0;
                    existingCodes.forEach(code => {
                        const match = code.match(/^S(\d+)$/);
                        if (match) {
                            maxNum = Math.max(maxNum, parseInt(match[1]));
                        }
                    });
                    data.s_code = `S${String(maxNum + 1).padStart(3, '0')}`;
                    console.log(`üè∑Ô∏è ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏´‡∏±‡∏™‡∏õ‡πâ‡∏≤‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${data.s_code}`);
                }
            }

            // ============================================
            // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            // ============================================
            let imageBase64 = null;
            let fileNameParam = null;
            const fileInput = form.querySelector('input[type="file"]');
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (fileInput && fileInput.files[0]) {
                const file = fileInput.files[0];
                const maxSize = markerType === 'building' ? 1500 : 2000;
                
                // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                const prefix = markerType === 'building' ? 'B' : 'S';
                const code = data.building_c || data.s_code || Date.now().toString().slice(-5);
                const extension = file.name.split('.').pop().toLowerCase() || 'jpg';
                fileNameParam = `${prefix}${code}.${extension}`;
                
                // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                try {
                    const resizedImage = await resizeImage(file, maxSize, maxSize);
                    const base64Data = resizedImage.split(',')[1];
                    imageBase64 = `${file.type};base64,${base64Data}`;
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á IndexedDB
                    await saveImageToDB(imageBase64, fileNameParam, rowKey || Date.now(), markerType);
                    console.log(`‚úÖ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô IndexedDB: ${fileNameParam}`);
                    
                    // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡πà‡∏°‡∏ô‡πå 'picture')
                    data.picture = fileNameParam;
                } catch (err) {
                    console.error('Error resizing image:', err);
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        const bytes = [...new Uint8Array(arrayBuffer)];
                        const binary = bytes.map(b => String.fromCharCode(b)).join('');
                        imageBase64 = `${file.type};base64,${btoa(binary)}`;
                        
                        await saveImageToDB(imageBase64, fileNameParam, rowKey || Date.now(), markerType);
                        console.log(`‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î: ${fileNameParam}`);
                        data.picture = fileNameParam;
                    } catch (fallbackErr) {
                        console.error('Fallback failed:', fallbackErr);
                        showNotificationLeft('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'warning');
                        // ‚úÖ ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ picture ‡∏´‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        delete data.picture;
                        imageBase64 = null;
                        fileNameParam = null;
                    }
                }
            } else {
                // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ picture ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ó‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ "image.jpg"
                console.log('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà - ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤ picture ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå');
            }
            
            // ‚úÖ ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ data.picture ‡πÅ‡∏•‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß)
            if (data.picture === 'image.jpg' || data.picture === '') {
                delete data.picture;
                console.warn('‚ö†Ô∏è ‡∏•‡∏ö‡∏Ñ‡πà‡∏≤ picture ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á: ', data.picture);
            }
            if (fileNameParam === 'image.jpg' || !fileNameParam || fileNameParam.trim() === '') {
                fileNameParam = null;
                imageBase64 = null;
                console.warn('‚ö†Ô∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á fileNameParam ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }

            // ============================================
            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
            // ============================================
            const queueId = addToSyncQueue(action, markerType, data, rowKey, imageBase64, fileNameParam);
            console.log(`‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏¥‡∏ß‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${queueId} (${action})`);
            
            // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (editingMarker) {
                editingMarker._popupData = {
                    ...editingMarker._popupData,
                    ...data,
                    queued: true,
                    queueId: queueId
                };
                setupMarkerPopup(editingMarker, editingMarker._popupData, markerType);
            }
            
            // ‚úÖ ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            closePanel();
            const msg = action === 'update' ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!';
            showNotificationLeft(`${msg} (‡∏£‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)`, 'success');
            
            // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏≤‡∏Å‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
            if (isOnline && navigator.onLine) {
                setTimeout(() => {
                    console.log('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ñ‡∏¥‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                    processSyncQueue();
                }, 300);
            }
            
            console.log('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
        }

        async function processDataSyncQueue() {
            console.log('üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            console.log('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå:', isOnline, 'navigator.onLine:', navigator.onLine);
            console.log('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', dataSyncQueue.length);
            
            if (!isOnline || !navigator.onLine) {
                console.log('‚ùå ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
                return;
            }
            
            if (dataSyncQueue.length === 0) {
                console.log('‚ÑπÔ∏è ‡∏Ñ‡∏¥‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡πà‡∏≤‡∏á - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î');
                return;
            }
            
            console.log(`üì¶ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${dataSyncQueue.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
            console.log('CONFIG.SCRIPT_URL:', CONFIG.SCRIPT_URL);
            
            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
            for (let i = 0; i < dataSyncQueue.length; i++) {
                const item = dataSyncQueue[i];
                
                if (item.status === 'success') {
                    console.log(`‚è≠Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${i + 1}: ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡∏Ç‡πâ‡∏≤‡∏°)`);
                    continue;
                }
                
                try {
                    console.log(`üì§ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${i + 1}/${dataSyncQueue.length}: ${item.action}`);
                    console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', JSON.stringify(item, null, 2));
                    
                    let result;
                    
                    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô 'add' ‡πÄ‡∏õ‡πá‡∏ô 'quickAdd'
                    switch (item.action) {
                        case 'add':
                        case 'quickAdd':
                            result = await sendDataWithRetry('quickAdd', item.type, item.data);
                            break;
                        case 'update':
                            result = await sendDataWithRetry('update', item.type, item.data, item.rowKey);
                            break;
                        case 'delete':
                            result = await sendDataWithRetry('delete', item.type, {}, item.rowKey);
                            break;
                        case 'updatePosition':
                            result = await sendDataWithRetry('updatePosition', item.type, item.data, item.rowKey);
                            break;
                        default:
                            console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å action: ${item.action}`);
                            continue;
                    }
                    
                    console.log(`üìä ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${i + 1}:`, result);
                    
                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏à‡∏£‡∏¥‡∏á‡πÜ
                    if (result && (result.success || (result.data && result.data.status === 200))) {
                        console.log(`‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${i + 1} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                        
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß
                        item.status = 'success';
                        item.syncedAt = new Date().toISOString();
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏•‡∏á‡πÉ‡∏ô localStorage
                        saveDataSyncQueueToStorage();
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
                        showNotificationLeft(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${i + 1}/${dataSyncQueue.length})`, 'success');
                        
                    } else {
                        console.warn(`‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${i + 1} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß - ‡∏£‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà`);
                        console.log('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:', result);
                        
                        item.retryCount = (item.retryCount || 0) + 1;
                        
                        if (item.retryCount >= 3) {
                            item.status = 'failed';
                            console.error(`‚ùå ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${i + 1} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á`);
                        }
                        
                        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏•‡∏á‡πÉ‡∏ô localStorage
                        saveDataSyncQueueToStorage();
                        
                        // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                        break;
                    }
                    
                    // ‡∏£‡∏≠ 500ms ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (err) {
                    console.error(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${i + 1}:`, err);
                    console.error('Stack trace:', err.stack);
                    
                    item.retryCount = (item.retryCount || 0) + 1;
                    
                    if (item.retryCount >= 3) {
                        item.status = 'failed';
                    }
                    
                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏•‡∏á‡πÉ‡∏ô localStorage
                    saveDataSyncQueueToStorage();
                    
                    // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                    break;
                }
            }
            
            // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏¥‡∏ß
            const successItems = dataSyncQueue.filter(item => item.status === 'success');
            for (const item of successItems) {
                removeFromDataSyncQueue(item.id);
            }
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å localStorage
            loadDataSyncQueueFromStorage();
            
            console.log(`‚úÖ ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô - ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${dataSyncQueue.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
            
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            if (dataSyncQueue.length > 0) {
                console.log('‚è≥ ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà - ‡∏à‡∏∞‡∏•‡∏≠‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ');
                setTimeout(() => {
                    processDataSyncQueue();
                }, 5000);
            }
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateMarkerPosition
        async function updateMarkerPosition(marker, data, newLatLng) {
            const refreshBtn = document.getElementById('btn-refresh');
            const refreshIcon = document.getElementById('refresh-icon');
            disableRefreshButton();
            refreshIcon.classList.add('animate-spin');
            
            const oldLatLng = data.lat_long;
            const newLatLngStr = `${newLatLng.lat.toFixed(6)}, ${newLatLng.lng.toFixed(6)}`;
            const rowKey = data._row_num || data.id;
            const type = data.type || (data.building_c ? 'building' : 'sign');
            
            if (!rowKey) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï");
                refreshIcon.classList.remove('animate-spin');
                enableRefreshButton();
                return;
            }
            
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
            markersBeingMoved.add(rowKey);
            
            // ‚úÖ ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
            let realMarker = null;
            surveyLayers.eachLayer(layer => {
                if (layer._popupData) {
                    const layerId = layer._popupData._row_num || layer._popupData.id;
                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
                    if (String(layerId) === String(rowKey) && !layer._popupData.tempMarker) {
                        realMarker = layer;
                    }
                }
            });
            
            if (!realMarker) {
                console.warn(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡πâ‡∏≤‡∏¢: ${rowKey}`);
                markersBeingMoved.delete(rowKey);
                refreshIcon.classList.remove('animate-spin');
                enableRefreshButton();
                return;
            }
            
            try {
                // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                realMarker._popupData.lat_long = newLatLngStr;
                realMarker.setLatLng(newLatLng);
                
                // ‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
                const body = new URLSearchParams();
                body.append('action', 'updatePosition');
                body.append('type', type);
                body.append('rowKey', rowKey);
                body.append('lat_long', newLatLngStr);
                
                const res = await fetch(CONFIG.SCRIPT_URL.trim(), {
                    method: 'POST',
                    body,
                    timeout: 10000
                });
                
                const result = await res.json();
                
                if (res.ok && result.status === 200) {
                    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
                    markersBeingMoved.delete(rowKey);
                    refreshIcon.classList.remove('animate-spin');
                    refreshBtn.classList.add('refresh-success');
                    
                    setTimeout(() => {
                        refreshBtn.classList.remove('refresh-success');
                        enableRefreshButton();
                    }, 2000);
                    
                    showNotificationLeft('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    throw new Error(result.message || "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                }
            } catch (err) {
                // ‚úÖ ‡∏´‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏°
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:', err);
                
                // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°
                const coords = oldLatLng.split(',').map(Number);
                realMarker.setLatLng(L.latLng(coords[0], coords[1]));
                realMarker._popupData.lat_long = oldLatLng;
                
                markersBeingMoved.delete(rowKey);
                refreshIcon.classList.remove('animate-spin');
                enableRefreshButton();
                
                showNotificationLeft("‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + err.message, 'error');
            }
        }


        // ‡∏Ç‡πâ‡∏≠ 3: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö + ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡πä‡∏≠‡∏ö‡∏≠‡∏±‡∏õ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
        function setupMarkerPopup(marker, data, type) {
            const popupDiv = document.createElement('div');
            popupDiv.className = "p-1 min-w-[160px]";
            popupDiv.innerHTML = `
                <p class="font-bold text-sm text-blue-900">${type === 'building' ? '‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' : '‡∏õ‡πâ‡∏≤‡∏¢'}</p>
                <p class="text-[10px] text-gray-500">${data.lat_long}</p>
                <div class="mt-2 space-y-2">
                    <button class="w-full bg-blue-600 text-white text-[11px] py-3 rounded font-bold shadow-sm active:bg-blue-700 hover:bg-blue-700 transition">‡πÅ‡∏Å‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    <button class="w-full bg-red-600 text-white text-[11px] py-3 rounded font-bold shadow-sm active:bg-red-700 hover:bg-red-700 transition">‡∏•‡∏ö‡∏à‡∏∏‡∏î</button>
                </div>
            `;
            
            // ‚úÖ ‡∏ú‡∏π‡∏Å‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÉ‡∏´‡πâ‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!)
            marker.bindPopup(popupDiv, {
                minWidth: 190,
                maxWidth: 220,
                autoPan: false, // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                closeOnClick: true
            });
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå
            marker._popupData = { ...data, type: type };
            
            // ‚úÖ ‡∏ú‡∏π‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ
            marker.on('popupopen', () => {
                const buttons = marker.getPopup().getElement().querySelectorAll('button');
                if (buttons[0]) {
                    buttons[0].onclick = (e) => {
                        e.stopPropagation();
                        openEditPanel(marker._popupData, marker._popupData.type, marker);
                    };
                }
                if (buttons[1]) {
                    buttons[1].onclick = (e) => {
                        e.stopPropagation();
                        showDeleteConfirm(marker, marker._popupData, marker._popupData.type);
                    };
                }
            });
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
        function autoFillBasedOnConditions() {
            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ
            const bNoteInput = document.querySelector('input[name="b_note"]');
            const bUseSelect = document.querySelector('select[name="b_use"]');
            const bUse2Select = document.querySelector('select[name="b_use2"]');
            const perUseSelect = document.querySelector('select[name="per_use"]');
            const perUse2Select = document.querySelector('select[name="per_use2"]');
            
            // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            const bNoteValue = bNoteInput?.value || '';
            const bUseValue = bUseSelect?.value || '';
            const bUse2Value = bUse2Select?.value || '';
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÄ‡∏ä‡πà‡∏≤" ‡πÉ‡∏ô b_note ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const hasChaInNote = bNoteValue.includes('‡πÄ‡∏ä‡πà‡∏≤');
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ b_use ‡∏´‡∏£‡∏∑‡∏≠ b_use2 ‡∏°‡∏µ "2-(3)" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const has23InBUse = bUseValue.includes('2-(3)');
            const has23InBUse2 = bUse2Value?.includes('2-(3)');
            
            // ============================================
            // ‚úÖ ‡∏Ç‡πâ‡∏≠ 1: ‡∏ñ‡πâ‡∏≤ b_note ‡∏°‡∏µ "‡πÄ‡∏ä‡πà‡∏≤" ‚Üí ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ b_use ‡πÄ‡∏õ‡πá‡∏ô 2-(3)
            // ============================================
            if (hasChaInNote && bUseSelect && !bUseSelect.disabled) {
                bUseSelect.value = '2-(3)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';
            }
            
            // ============================================
            // ‚úÖ ‡∏Ç‡πâ‡∏≠ 2: ‡∏ñ‡πâ‡∏≤ b_note ‡∏°‡∏µ "‡πÄ‡∏ä‡πà‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ b_use ‡∏°‡∏µ "2-(3)" ‚Üí ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ per_use ‡πÄ‡∏õ‡πá‡∏ô '‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤'
            // ============================================
            if ((hasChaInNote || has23InBUse) && perUseSelect && !perUseSelect.disabled) {
                perUseSelect.value = '‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤';
            }
            
            // ============================================
            // ‚úÖ ‡∏Ç‡πâ‡∏≠ 3: ‡∏ñ‡πâ‡∏≤ b_note ‡∏°‡∏µ "‡πÄ‡∏ä‡πà‡∏≤" ‡∏´‡∏£‡∏∑‡∏≠ b_use2 ‡∏°‡∏µ "2-(3)" ‚Üí ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ per_use2 ‡πÄ‡∏õ‡πá‡∏ô '‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤'
            // ============================================
            if ((hasChaInNote || has23InBUse2) && perUse2Select && !perUse2Select.disabled) {
                perUse2Select.value = '‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤';
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏à‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets (‡∏Ç‡πâ‡∏≠ 1)
        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô deleteMarker
        async function deleteMarker(marker, data, type) {
            const refreshBtn = document.getElementById('btn-refresh');
            const refreshIcon = document.getElementById('refresh-icon');
            
            // ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°
            disableRefreshButton();
            refreshIcon.classList.add('animate-spin');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)
            const deletingMsg = document.createElement('div');
            deletingMsg.className = 'fixed top-4 left-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-[2000] animate-fade-in';
            deletingMsg.innerHTML = '<i data-lucide="loader" class="w-5 h-5 inline mr-2 animate-spin"></i>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...';
            document.body.appendChild(deletingMsg);
            
            const rowKey = data._row_num || data.id;
            
            if (!rowKey) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏ö");
                refreshIcon.classList.remove('animate-spin');
                enableRefreshButton();
                deletingMsg.classList.add('animate-fade-out');
                setTimeout(() => deletingMsg.remove(), 300);
                return;
            }
            
            const body = new URLSearchParams();
            body.append('action', 'delete');
            body.append('type', type);
            body.append('rowKey', rowKey);
            
            try {
                const res = await fetch(CONFIG.SCRIPT_URL.trim(), { method: 'POST', body });
                
                if (res.ok) {
                    // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö"
                    deletingMsg.classList.add('animate-fade-out');
                    setTimeout(() => deletingMsg.remove(), 300);
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)
                    const successMsg = document.createElement('div');
                    successMsg.className = 'fixed top-4 left-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-[2000] animate-fade-in';
                    successMsg.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5 inline mr-2"></i>‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!';
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.classList.add('animate-fade-out');
                        setTimeout(() => successMsg.remove(), 300);
                    }, 500);
                    
                    surveyLayers.removeLayer(marker);
                    await loadExistingData();
                    
                    refreshIcon.classList.remove('animate-spin');
                    refreshBtn.classList.add('refresh-success');
                    setTimeout(() => {
                        refreshBtn.classList.remove('refresh-success');
                        enableRefreshButton();
                    }, 500);
                    
                    console.log("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                } else {
                    throw new Error("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                }
            } catch (err) {
                // ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö"
                deletingMsg.classList.add('animate-fade-out');
                setTimeout(() => deletingMsg.remove(), 300);
                
                refreshIcon.classList.remove('animate-spin');
                enableRefreshButton();
                console.error("Error deleting marker:", err);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)
                const errorMsg = document.createElement('div');
                errorMsg.className = 'fixed top-4 left-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-[2000] animate-fade-in';
                errorMsg.innerHTML = '<i data-lucide="alert-circle" class="w-5 h-5 inline mr-2"></i>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö!';
                document.body.appendChild(errorMsg);
                
                setTimeout(() => {
                    errorMsg.classList.add('animate-fade-out');
                    setTimeout(() => errorMsg.remove(), 300);
                }, 500);
                
                throw err;
            }
        }


        function openEditPanel(data, type, marker) {
            editingMarker = marker;
            const form = document.getElementById('survey-form');
            const initialFloor = data.no_floor ? `1-${data.no_floor}` : '1-1';
            //document.getElementById('latlng-display').innerText = data.lat_long;
            document.getElementById('panel-title').innerText = type === 'building' ? '‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' : '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡πâ‡∏≤‡∏¢';
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
            // let html = `<input type="hidden" id="marker-type" name="marker-type" value="${type}">`;

            const buildingFields = [
                { id: 'image', label: '‡∏£‡∏π‡∏õ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á', type: 'file', icon: 'camera' },
                { id: 'building_c', label: '‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á', type: 'text' },
                { id: 'b_type', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á', type: 'select', options: [ '000-‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏', '101-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÑ‡∏°‡πâ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '102-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÑ‡∏°‡πâ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏ï‡πâ‡∏ñ‡∏∏‡∏ô‡∏™‡∏π‡∏á', '103-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏ï‡∏∂‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '104-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÑ‡∏°‡πâ‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '105-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏ï‡∏∂‡∏Å‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '106-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ï‡∏∂‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÑ‡∏°‡πâ‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '107-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏ï‡∏∂‡∏Å‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô', '108-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÅ‡∏ù‡∏î‡∏ï‡∏∂‡∏Å‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '109-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÅ‡∏ù‡∏î‡∏ï‡∏∂‡∏Å‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô', '110-‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏£‡∏á‡πÑ‡∏ó‡∏¢‡πÑ‡∏°‡πâ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏ï‡πâ‡∏ñ‡∏∏‡∏ô‡∏™‡∏π‡∏á', '111-‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏£‡∏á‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ï‡∏∂‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÑ‡∏°‡πâ‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '112-‡∏ö‡πâ‡∏≤‡∏ô‡∏û‡∏±‡∏Å‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡πÅ‡∏ù‡∏î‡∏ï‡∏∂‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '201-‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ñ‡∏ß ‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Æ‡∏≤‡∏™‡πå) ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '202-‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ñ‡∏ß ‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Æ‡∏≤‡∏™‡πå) ‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '203-‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ñ‡∏ß ‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Æ‡∏≤‡∏™‡πå) ‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô', '204-‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏ñ‡∏ß ‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Æ‡∏≤‡∏™‡πå) ‡∏™‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô', '301-‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡πÑ‡∏°‡πâ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '302-‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡πÑ‡∏°‡πâ‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '303-‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ï‡∏∂‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÑ‡∏°‡πâ‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '401-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß', '402-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô', '403-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á', '404-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô', '405-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á', '406-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô', '407-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô‡∏Ñ‡∏£‡∏∂‡πà‡∏á', '408-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏´‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô', '409-‡∏ï‡∏∂‡∏Å‡πÅ‡∏ñ‡∏ß‡∏´‡∏Å‡∏ä‡∏±‡πâ‡∏ô', '501-‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 300 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£', '502-‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 300 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', '503-‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ /‡∏Ñ‡∏£‡∏±‡∏ß', '504-‡πÇ‡∏£‡∏á‡∏à‡∏≠‡∏î‡∏£‡∏ñ', '505-‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '506/1-‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ä‡∏±‡πâ‡∏ô', '506/2-‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', '507-‡πÇ‡∏£‡∏á‡∏°‡∏´‡∏£‡∏™‡∏û', '508-‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', '509/1-‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ä‡∏±‡πâ‡∏ô', '509/2-‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', '510-‡∏†‡∏±‡∏ï‡∏ï‡∏≤‡∏Ñ‡∏≤‡∏£', '511/1-‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '511/2-‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡∏Å‡∏£‡∏£‡∏° ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡πà‡∏á', '512-‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏û‡∏•‡∏¥‡∏á', '513-‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', '514-‡∏ï‡∏•‡∏≤‡∏î ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1,000 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£', '515-‡∏ï‡∏•‡∏≤‡∏î ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 1,000 ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏ï‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', '516-‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏Æ‡∏°‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®', '517-‡πÇ‡∏£‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå', '518-‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', '519-‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏à‡∏≠‡∏î‡∏£‡∏ñ', '520/1-‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏£‡∏ß‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ä‡∏±‡πâ‡∏ô', '520/2-‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏£‡∏ß‡∏° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤ 5 ‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', '521-‡∏õ‡πâ‡∏≠‡∏°‡∏¢‡∏≤‡∏°', '522-‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏°‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå', '523-‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏£‡∏ß‡∏°', '601-‡∏£‡∏±‡πâ‡∏ß‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï', '602-‡∏£‡∏±‡πâ‡∏ß‡∏•‡∏ß‡∏î‡∏´‡∏ô‡∏≤‡∏°', '603-‡∏£‡∏±‡πâ‡∏ß‡∏™‡∏±‡∏á‡∏Å‡∏∞‡∏™‡∏µ', '604-‡∏£‡∏±‡πâ‡∏ß‡∏•‡∏ß‡∏î‡∏ñ‡∏±‡∏Å', '605-‡∏£‡∏±‡πâ‡∏ß‡πÑ‡∏°‡πâ', '606-‡∏£‡∏±‡πâ‡∏ß‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏î‡∏±‡∏î', '607-‡∏£‡∏±‡πâ‡∏ß‡∏≠‡∏±‡∏•‡∏•‡∏≠‡∏¢‡∏î‡πå', '608-‡∏™‡∏£‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥', '609-‡∏•‡∏≤‡∏ô‡∏Å‡∏µ‡∏¨‡∏≤‡∏≠‡πÄ‡∏ô‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå', '610-‡∏ñ‡∏ô‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï', '611-‡∏•‡∏≤‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï', '612-‡∏ñ‡∏ô‡∏ô‡∏•‡∏≤‡∏î‡∏¢‡∏≤‡∏á', '613-‡∏õ‡πâ‡∏≤‡∏¢‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤', '614-‡∏ó‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏∑‡∏≠'] },
                // ‚úÖ ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà 1 - ‡∏ß‡∏±‡∏™‡∏î‡∏∏ + ‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)
                { id: 'b_mat', label: '‡∏ß‡∏±‡∏™‡∏î‡∏∏', type: 'select', options: ['‡πÑ‡∏°‡πâ', '‡∏ï‡∏∂‡∏Å', '‡∏ï‡∏∂‡∏Å/‡πÑ‡∏°‡πâ'], defaultValue: '‡∏ï‡∏∂‡∏Å', pairWith: 'b_year' },
                { id: 'b_year', label: '‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏õ‡∏µ)', type: 'select', options: [1, 2, 3, 5, 7, 10, 15, 20, 25, 30, 35, 40, 45, 50, 70, 80, 100], allowCustom: true, pairWith: 'b_mat' },
                                
                // ‚úÖ ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà 2 - ‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà + ‡∏´‡∏°‡∏π‡πà (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)
                { id: 'hs_no', label: '‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', type: 'text', pairWith: 'hs_moo' },
                { id: 'hs_moo', label: '‡∏´‡∏°‡∏π‡πà', type: 'select', options: ['', 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20], pairWith: 'hs_no' },
                
                // ‚úÖ ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà 4 - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô + ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô
                { 
                    id: 'no_floor', 
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô', 
                    type: 'select', 
                    options: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], 
                    defaultValue: 1, 
                    pairWith: 'b_area'  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                },
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô
                { 
                    id: 'b_area', 
                    label: '‡∏û‡∏ó.‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á', 
                    type: 'number', 
                    defaultValue: '', 
                    pairWith: 'no_floor',
                    withButton: true  // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                },

                { id: 'b_note', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', type: 'select', options: ['', '‡∏¢‡∏∏‡πâ‡∏á‡∏Ç‡πâ‡∏≤‡∏ß', '‡∏Ñ‡∏≠‡∏Å‡∏ß‡∏±‡∏ß', '‡πÄ‡∏•‡πâ‡∏≤‡πÑ‡∏Å‡πà', '‡∏Ñ‡∏≠‡∏Å‡∏´‡∏°‡∏π', '‡πÇ‡∏£‡∏á‡∏à‡∏≠‡∏î‡∏£‡∏ñ', '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥', '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥', '‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≤‡∏£‡πå‡∏ó', '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡∏ô‡∏≤', '‡πÄ‡∏û‡∏¥‡∏á‡∏û‡∏±‡∏Å', '‡πÇ‡∏£‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á', '‡πÄ‡∏Å‡πá‡∏ö‡∏ü‡∏≤‡∏á', '‡πÇ‡∏£‡∏á‡∏Ñ‡∏£‡∏±‡∏ß', '‡∏®‡∏≤‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', '‡∏ï‡∏π‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô', '‡∏ï‡∏π‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç', '‡∏ï‡∏π‡πâ‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç', '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó', '‡∏£‡∏∑‡πâ‡∏≠'], allowCustom: true },
                // ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 1 - ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                { id: 'b_use', label: '‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå', type: 'select', options: ['', '1-‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°', '2-(1)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å', '2-(2)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', '2-(3)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '3-‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£', '4-‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤/‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á'], customClass: 'bg-custom-green' },
                { id: 'per_use', label: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤', type: 'select', options: ['‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÄ‡∏≠‡∏á', '‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤', '‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ'], customClass: 'bg-custom-green' },

                // ‚úÖ ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà 3 - ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á + ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)
                { id: 'full_area', label: '‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á', type: 'select', options: ['', '‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', '‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô'], customClass: 'bg-custom-green', pairWith: 'buse_floor' },
                { 
                    id: 'buse_floor', 
                    label: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ', 
                    type: 'select', 
                    options: ['1-1', '1-2', '1-3', '1-4', '1-5'], 
                    allowCustom: true, 
                    customClass: 'bg-custom-green',
                    defaultValue: initialFloor,
                    pairWith: 'full_area'
                },
                { id: 'buse_area', label: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏ï‡∏£.‡∏°.)', type: 'number', customClass: 'bg-custom-green' },
                { id: 'ment_use', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', type: 'select', options: ['', '‡∏¢‡∏∏‡πâ‡∏á‡∏Ç‡πâ‡∏≤‡∏ß', '‡∏Ñ‡∏≠‡∏Å‡∏ß‡∏±‡∏ß', '‡πÄ‡∏•‡πâ‡∏≤‡πÑ‡∏Å‡πà', '‡∏Ñ‡∏≠‡∏Å‡∏´‡∏°‡∏π', '‡πÇ‡∏£‡∏á‡∏à‡∏≠‡∏î‡∏£‡∏ñ', '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥', '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥', '‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≤‡∏£‡πå‡∏ó', '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡∏ô‡∏≤', '‡πÄ‡∏û‡∏¥‡∏á‡∏û‡∏±‡∏Å', '‡πÇ‡∏£‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á', '‡πÄ‡∏Å‡πá‡∏ö‡∏ü‡∏≤‡∏á', '‡πÇ‡∏£‡∏á‡∏Ñ‡∏£‡∏±‡∏ß', '‡∏®‡∏≤‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', '‡∏ï‡∏π‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô', '‡∏ï‡∏π‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç', '‡∏ï‡∏π‡πâ‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç', '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó', '‡∏£‡∏∑‡πâ‡∏≠'], allowCustom: true, customClass: 'bg-custom-green' },
                
                // ‚úÖ ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2 - ‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π
                { id: 'b_use2', label: '‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå (2)', type: 'select', options: ['', '1-‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°', '2-(1)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å', '2-(2)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', '2-(3)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '3-‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£', '4-‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤/‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á'], defaultValue: '3-‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£', customClass: 'bg-custom-pink' },
                // ‚úÖ ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà 5 - ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ (2) + ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (2) (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)
                { id: 'per_use2', label: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏≤ (2)', type: 'select', options: ['‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÄ‡∏≠‡∏á', '‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤', '‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ä‡πâ'], defaultValue: '‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÄ‡∏≠‡∏á' , customClass: 'bg-custom-pink', pairWith: 'buse_floor2' },
                { id: 'buse_floor2', label: '‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (2)', type: 'select', options: ['', '1-1', '1-2', '1-3', '1-4', '1-5'], defaultValue: '1-1', allowCustom: true, customClass: 'bg-custom-pink', pairWith: 'per_use2' },
                {
                  id: 'buse_area2', 
                  label: '‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (2) (‡∏ï‡∏£.‡∏°.)', 
                  type: 'number', 
                  customClass: 'bg-custom-pink',
                  withButtons: true // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏•‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏õ‡∏∏‡πà‡∏°
                },
                { id: 'ment_use2', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (2)', type: 'select', options: ['', '‡∏¢‡∏∏‡πâ‡∏á‡∏Ç‡πâ‡∏≤‡∏ß', '‡∏Ñ‡∏≠‡∏Å‡∏ß‡∏±‡∏ß', '‡πÄ‡∏•‡πâ‡∏≤‡πÑ‡∏Å‡πà', '‡∏Ñ‡∏≠‡∏Å‡∏´‡∏°‡∏π', '‡πÇ‡∏£‡∏á‡∏à‡∏≠‡∏î‡∏£‡∏ñ', '‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥', '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ä‡∏≥', '‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≤‡∏£‡πå‡∏ó', '‡∏Å‡∏£‡∏∞‡∏ó‡πà‡∏≠‡∏°‡∏ô‡∏≤', '‡πÄ‡∏û‡∏¥‡∏á‡∏û‡∏±‡∏Å', '‡πÇ‡∏£‡∏á‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡∏≠‡∏á', '‡πÄ‡∏Å‡πá‡∏ö‡∏ü‡∏≤‡∏á', '‡πÇ‡∏£‡∏á‡∏Ñ‡∏£‡∏±‡∏ß', '‡∏®‡∏≤‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', '‡∏ï‡∏π‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô', '‡∏ï‡∏π‡πâ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç', '‡∏ï‡∏π‡πâ‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç', '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó', '‡∏£‡∏∑‡πâ‡∏≠'], allowCustom: true, customClass: 'bg-custom-pink' },
                { id: 'full_area2', label: '‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á (2)', type: 'select', options: ['', '‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô'], defaultValue: '‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô', customClass: 'bg-custom-pink' },
                { id: 'full_name', label: '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á', type: 'text' },
                { id: 'address', label: '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', type: 'text' },
                { 
                  id: 'land_use', 
                  label: '‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', 
                  type: 'select', 
                  options: ['', '1-‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°', '2-(1)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å', '2-(2)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏£‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô', '2-(3)‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢ ‡∏´‡∏•‡∏±‡∏á‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', '3-‡∏≠‡∏∑‡πà‡∏ô‡πÜ', '4-‡∏ó‡∏¥‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤/‡∏£‡∏Å‡∏£‡πâ‡∏≤‡∏á', '5-‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'], 
                  customClass: 'bg-custom-green',
                  computed: true, // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ (‡πÅ‡∏ó‡∏ô readonly: true)
                  disabled: true  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                },
                { id: 'check', label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', type: 'select', options: ['‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß'], customClass: 'bg-custom-check-status' }
            ];

            
            const signFields = [
                { id: 'image', label: '‡∏£‡∏π‡∏õ‡∏õ‡πâ‡∏≤‡∏¢', type: 'file', icon: 'camera' },
                { id: 's_code', label: '‡∏£‡∏´‡∏±‡∏™‡∏õ‡πâ‡∏≤‡∏¢', type: 'text' },
                { id: 's_name', label: '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏≤‡∏£', type: 'text' },
                { id: 's_type', label: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡πâ‡∏≤‡∏¢', type: 'select', options: ['‡∏õ‡πâ‡∏≤‡∏¢/‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '‡∏õ‡πâ‡∏≤‡∏¢/‡∏õ‡πâ‡∏≤‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 3 ‡∏ï‡∏£.‡∏°. ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ', '‡∏õ‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå'] },
                // ‚úÖ ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà 1 - ‡∏Å‡∏ß‡πâ‡∏≤‡∏á + ‡∏¢‡∏≤‡∏ß (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)
                { id: 's_wide', label: '‡∏Å‡∏ß‡πâ‡∏≤‡∏á(‡∏ã.‡∏°.)', type: 'number', defaultValue: '', pairWith: 's_length' },
                { id: 's_length', label: '‡∏¢‡∏≤‡∏ß(‡∏ã.‡∏°.)', type: 'number', defaultValue: '', pairWith: 's_wide' },

                // ‚úÖ ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà 2 - ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ + ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏õ‡πâ‡∏≤‡∏¢ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)
                { 
                    id: 'content_type_temp', 
                    label: '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤', 
                    type: 'select', 
                    options: ['1.‡πÑ‡∏ó‡∏¢‡∏•‡πâ‡∏ß‡∏ô', '2.‡πÑ‡∏ó‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î', '3.‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ó‡∏¢', '3.‡πÑ‡∏ó‡∏¢‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏™‡∏∏‡∏î'],
                    tempField: true,
                    pairWith: 'sign_type_detail_temp'
                },
                { 
                    id: 'sign_type_detail_temp', 
                    label: '‡∏ï‡∏±‡∏ß‡∏õ‡πâ‡∏≤‡∏¢', 
                    type: 'select', 
                    options: ['(‡∏Ç) ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ', '(‡∏Å) ‡∏à‡∏≠ LED', '(‡∏Å) ‡∏°‡∏≠‡πÄ‡∏ï‡∏≠‡∏£‡πå/‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß'],
                    tempField: true,
                    pairWith: 'content_type_temp'
                },
                // ‚úÖ ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà 3 - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô + ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞ (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô)
                { 
                    id: 'no_side', 
                    label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡πâ‡∏≤‡∏ô', 
                    type: 'select', 
                    options: [1, 2], 
                    defaultValue: 1, 
                    pairWith: 's_characte'  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                },
                // ‚úÖ ‡∏ü‡∏¥‡∏•‡∏î‡πå "‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞" ‡πÅ‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                { 
                    id: 's_characte', 
                    label: '‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞', 
                    type: 'text',
                    readonly: true,
                    description: '‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å 2 ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô',
                    pairWith: 'no_side'  // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                },
                { id: 's_text', label: '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏õ‡πâ‡∏≤‡∏¢', type: 'text' },
                { id: 'comment', label: '‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', type: 'text' },
                { id: 'fullname', label: '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á', type: 'text' },
                { id: 'address', label: '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà', type: 'text' },
                { id: 'check', label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', type: 'select', options: ['‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß', '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß'], customClass: 'bg-custom-check-status' }
            ];
            
            const fields = type === 'building' ? buildingFields : signFields;

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
            let html = `
                <input type="hidden" id="marker-type" name="marker-type" value="${type}">
                <input type="hidden" name="lat_long" value="${data.lat_long || ''}">
            `;
            fields.forEach(f => {
                // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (render ‡πÉ‡∏ô‡∏Ñ‡∏π‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)
                if (f.pairWith && fields.findIndex(x => x.id === f.pairWith) < fields.indexOf(f)) {
                    return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà 2 ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ render ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà 1
                }
                
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const pairedField = f.pairWith ? fields.find(x => x.id === f.pairWith) : null;
                
                // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏° div wrapper
                if (pairedField) {
                    html += `<div class="mb-2 grid grid-cols-2 gap-2">`;
                } else {
                    html += `<div class="mb-2">`;
                }
                
                // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏´‡∏•‡∏±‡∏Å
                html += `<div>`;
                if (f.type !== 'file') {
                    html += `<label class="form-label">${f.label}</label>`;
                }
                
                // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏¥‡∏•‡∏î‡πå
                let fieldValue = data[f.id] || '';
                if (f.id === 'check') {
                    if (fieldValue === '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') {
                        // ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ
                    } else if (data.picture && data.picture.trim() !== '') {
                        fieldValue = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß';
                    }
                }
                
                if (f.type === 'textarea') {
                    const customClass = f.customClass || '';
                    html += `<textarea name="${f.id}" class="form-input ${customClass}" rows="2"${f.readonly ? ' readonly' : ''}>${fieldValue}</textarea>`;
                } else if (f.type === 'file') {
                    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡πà‡∏°‡∏ô‡πå 'picture' ‡πÅ‡∏ó‡∏ô 'image'
                    let fileName = '';
                    if (type === 'building') {
                        fileName = data.picture || data.image?.split('/').pop()?.split('?')[0] || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
                    } else if (type === 'sign') {
                        fileName = data.picture || data.image?.split('/').pop()?.split('?')[0] || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
                    }
                    
                    // ‚úÖ ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 1800-1820) ‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ
                    html += `
                    <div class="mb-2">
                        <div class="mb-3">
                            <label class="form-label flex items-center gap-1">
                                <i data-lucide="camera" class="w-3 h-3"></i>
                                ${f.label}
                            </label>
                            <input type="file" name="${f.id}" accept="image/*" capture="environment" class="hidden" id="file-input-${f.id}">
                            <button type="button" onclick="document.getElementById('file-input-${f.id}').click()" 
                                class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-2 rounded-md font-semibold text-sm shadow-sm hover:from-blue-600 hover:to-blue-700 transition-all flex items-center justify-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14.5 4h-4L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-3.5-3z"></path>
                                    <circle cx="12" cy="13" r="3"></circle>
                                    <path d="M12 10v3l1.5 1.5"></path>
                                </svg>
                                <span>‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</span>
                            </button>
                            
                            <!-- ‚úÖ ‡∏õ‡πâ‡∏≤‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ -->
                            <div id="filename-container-${f.id}" class="mt-1.5">
                                <span id="filename-badge-${f.id}" 
                                    class="text-[10px] text-blue-600 font-medium px-2 py-0.5 bg-blue-50 rounded-full inline-flex items-center gap-1 cursor-pointer hover:bg-blue-100 transition"
                                    onclick="handleImageBadgeClick('${data.image || ''}', '${data.picture || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û'}')">
                                    <i data-lucide="image" class="w-3 h-3"></i>
                                    <span id="filename-text-${f.id}">${fileName}</span>
                                </span>
                            </div>
                        </div>
                    </div>`;
                } else if (f.type === 'select') {
                    const customClass = f.customClass || '';
                    const isDisabled = f.disabled ? 'disabled' : '';
                    if (f.allowCustom) {
                        const value = fieldValue !== undefined && fieldValue !== null && fieldValue !== '' ? fieldValue : (f.defaultValue !== undefined ? f.defaultValue : '');
                        html += `<input type="text" name="${f.id}" class="form-input ${customClass}" list="${f.id}-options" value="${value}" ${isDisabled}>`;
                        html += `<datalist id="${f.id}-options">`;
                        f.options.forEach(opt => {
                            html += `<option value="${opt}">${opt}</option>`;
                        });
                        html += `</datalist>`;
                    } else {
                        const value = fieldValue !== undefined && fieldValue !== null && fieldValue !== '' ? fieldValue : (f.defaultValue !== undefined ? f.defaultValue : '');
                        html += `<select name="${f.id}" class="form-input ${customClass}" ${isDisabled}>`;
                        f.options.forEach(opt => {
                            const selected = String(value) === String(opt) ? 'selected' : '';
                            html += `<option value="${opt}" ${selected}>${opt}</option>`;
                        });
                        html += `</select>`;
                    }
                } else if (f.type === 'number') {
                    const customClass = f.customClass || '';
                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏° A (b_area) - ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Mobile/Tablet/Desktop
                    if (f.id === 'b_area' && f.withButton) {
                        html += `
                        <div class="relative">
                            <input type="number" name="${f.id}"
                            class="form-input ${customClass} w-full pr-12 md:pr-10 input-area-wrapper"
                            value="${fieldValue}"${f.readonly ? ' readonly' : ''}
                            style="padding-right: 3rem;">
                            <button type="button" onclick="openAreaCalculatorA()"
                            class="calc-btn-a absolute right-1.5 top-1/2 -translate-y-1/2 w-10 h-10 md:w-7 md:h-7 bg-purple-600 text-white rounded-md font-bold text-sm hover:bg-purple-700 active:bg-purple-800 transition-all flex items-center justify-center shadow-sm"
                            title="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà A">
                            A
                            </button>
                        </div>`;
                    }
                    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏° B (buse_area2)
                    else if (f.id === 'buse_area2' && f.withButtons) {
                        html += `
                        <div class="flex gap-2 items-center">
                            <input type="number" name="${f.id}" class="form-input ${customClass} flex-1" value="${fieldValue}"${f.readonly ? ' readonly' : ''}>
                            <div class="flex gap-1">
                                <button type="button" onclick="openAreaCalculator()"
                                class="px-3 py-2 bg-orange-500 text-white rounded font-bold text-sm hover:bg-orange-600 transition"
                                title="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà">
                                B
                                </button>
                                <button type="button" onclick="calculateDeltaArea()"
                                class="px-3 py-2 bg-green-500 text-white rounded font-bold text-sm hover:bg-green-600 transition"
                                title="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L22 22H2L12 2z"></path>
                                </svg>
                                </button>
                            </div>
                        </div>`;
                    } else {
                        html += `<input type="${f.type}" name="${f.id}" class="form-input ${customClass}" value="${fieldValue}"${f.readonly ? ' readonly' : ''}>`;
                    }
                } else {
                    const customClass = f.customClass || '';
                    html += `<input type="${f.type}" name="${f.id}" class="form-input ${customClass}" value="${fieldValue}"${f.readonly ? ' readonly' : ''}>`;
                }
                html += `</div>`;

            
                // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡∏π‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                if (pairedField) {
                    html += `<div>`;
                    if (pairedField.type !== 'file') {
                        html += `<label class="form-label">${pairedField.label}</label>`;
                    }
                    
                    let pairedFieldValue = data[pairedField.id] || '';
                    if (pairedField.id === 'check') {
                        if (pairedFieldValue === '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') {
                            // ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ
                        } else if (data.picture && data.picture.trim() !== '') {
                            pairedFieldValue = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß';
                        }
                    }
                    
                    if (pairedField.type === 'select') {
                        const customClass = pairedField.customClass || '';
                        const isDisabled = pairedField.disabled ? 'disabled' : '';
                        if (pairedField.allowCustom) {
                            const value = pairedFieldValue !== undefined && pairedFieldValue !== null && pairedFieldValue !== '' ? pairedFieldValue : (pairedField.defaultValue !== undefined ? pairedField.defaultValue : '');
                            html += `<input type="text" name="${pairedField.id}" class="form-input ${customClass}" list="${pairedField.id}-options" value="${value}" ${isDisabled}>`;
                            html += `<datalist id="${pairedField.id}-options">`;
                            pairedField.options.forEach(opt => {
                                html += `<option value="${opt}">${opt}</option>`;
                            });
                            html += `</datalist>`;
                        } else {
                            const value = pairedFieldValue !== undefined && pairedFieldValue !== null && pairedFieldValue !== '' ? pairedFieldValue : (pairedField.defaultValue !== undefined ? pairedField.defaultValue : '');
                            html += `<select name="${pairedField.id}" class="form-input ${customClass}" ${isDisabled}>`;
                            pairedField.options.forEach(opt => {
                                const selected = String(value) === String(opt) ? 'selected' : '';
                                html += `<option value="${opt}" ${selected}>${opt}</option>`;
                            });
                            html += `</select>`;
                        }
                    } else if (pairedField.type === 'number') {
                        const customClass = pairedField.customClass || '';
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏∏‡πà‡∏° A ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏Ñ‡∏π‡πà
                        if (pairedField.id === 'b_area' && pairedField.withButton) {
                            html += `
                            <div class="relative">
                                <input type="number" name="${pairedField.id}"
                                class="form-input ${customClass} w-full pr-10"
                                value="${pairedFieldValue}"${pairedField.readonly ? ' readonly' : ''}
                                style="padding-right: 2.5rem;">
                                <button type="button" onclick="openAreaCalculatorA()"
                                class="absolute right-1 top-1/2 -translate-y-1/2 w-7 h-7 bg-purple-600 text-white rounded font-bold text-sm hover:bg-purple-700 transition flex items-center justify-center"
                                style="width: 28px; height: 28px; font-size: 12px;"
                                title="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà A">
                                A
                                </button>
                            </div>`;
                        } else {
                            html += `<input type="${pairedField.type}" name="${pairedField.id}" class="form-input ${customClass}" value="${pairedFieldValue}"${pairedField.readonly ? ' readonly' : ''}>`;
                        }
                    } else {
                        const customClass = pairedField.customClass || '';
                        html += `<input type="${pairedField.type}" name="${pairedField.id}" class="form-input ${customClass}" value="${pairedFieldValue}"${pairedField.readonly ? ' readonly' : ''}>`;
                    }
                    html += `</div>`;
                }
                
                html += `</div>`;
            });

            form.innerHTML = html;
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å form.innerHTML = html; ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô openEditPanel()
            // ‚úÖ ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏´‡∏•‡∏±‡∏á form.innerHTML)
            // ‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà (‡∏ß‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á form.innerHTML = html;)
            // ‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û + ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
            const fileInputs = form.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.addEventListener('change', (e) => {
                    const fileId = input.id.replace('file-input-', '');
                    const fileNameBadge = document.getElementById(`filename-text-${fileId}`);
                    const checkSelect = form.querySelector('select[name="check"]'); // ‡∏î‡∏∂‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    
                    if (e.target.files.length > 0) {
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
                        const file = e.target.files[0];
                        const prefix = type === 'building' ? 'B' : 'S';
                        const code = data.building_c || data.s_code || Date.now().toString().slice(-5);
                        const extension = file.name.split('.').pop().toLowerCase();
                        const fileName = `${prefix}${code}.${extension}`;
                        
                        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                        fileNameBadge.textContent = fileName;
                        
                        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à")
                        if (checkSelect && checkSelect.value === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à') {
                            checkSelect.value = '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß';
                            console.log('‚úÖ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß');
                        }
                        // ‚ö†Ô∏è ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß" ‚Üí ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£ (‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°)
                    } else {
                        fileNameBadge.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
                    }
                });
            });

            // ‚úÖ 2. ‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤)
            setTimeout(() => { 
                // 1. ‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô (‡πÄ‡∏õ‡πá‡∏ô select)
                const noFloorSelect = document.querySelector('select[name="no_floor"]');
                
                // 2. ‡∏´‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡πÄ‡∏õ‡πá‡∏ô input ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ allowCustom: true)
                const buseFloorInput = document.querySelector('input[name="buse_floor"]');

                if (noFloorSelect && buseFloorInput) {
                    noFloorSelect.addEventListener('change', function() {
                        const selectedFloor = this.value;
                        if (selectedFloor) {
                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ ‡πÄ‡∏õ‡πá‡∏ô 1-‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
                            buseFloorInput.value = `1-${selectedFloor}`;
                            
                            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö)
                            buseFloorInput.dispatchEvent(new Event('input')); 
                        } else {
                            buseFloorInput.value = '';
                        }
                    });
                }
            }, 100);
        
            // ‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
            if (type === 'building') {
                const bTypeSelect = document.querySelector('select[name="b_type"]');
                const bMatSelect = document.querySelector('select[name="b_mat"]');
                const noFloorSelect = document.querySelector('select[name="no_floor"]');
                
                if (bTypeSelect && bMatSelect && noFloorSelect) {
                    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô
                    const updateBuildingDependencies = () => {
                        const selectedValue = bTypeSelect.value;
                        
                        // ============================================
                        // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö "‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ï‡∏∂‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÑ‡∏°‡πâ" ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠!)
                        // ============================================
                        if (selectedValue.includes('‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ï‡∏∂‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÑ‡∏°‡πâ')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å/‡πÑ‡∏°‡πâ'; // ‚úÖ ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ (106, 111, 303)
                        } else if (selectedValue.includes('‡πÑ‡∏°‡πâ')) {
                            bMatSelect.value = '‡πÑ‡∏°‡πâ';
                        } else if (selectedValue.includes('‡πÇ‡∏£‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå')) {
                            bMatSelect.value = '‡πÑ‡∏°‡πâ';
                        } else if (selectedValue.includes('‡∏ó‡∏≤‡∏ß‡∏ô‡πå‡πÄ‡∏Æ‡∏≤‡∏™‡πå')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏´‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏û‡∏≤‡∏ì‡∏¥‡∏ä')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏≠‡∏≤‡∏®‡∏±‡∏¢‡∏£‡∏ß‡∏°')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏™‡∏£‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏ô')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡πÇ‡∏£‡∏á‡∏°‡∏´‡∏£‡∏™‡∏û')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏†‡∏±‡∏ï‡∏ï‡∏≤‡∏Ñ‡∏≤‡∏£')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏ï‡∏•‡∏≤‡∏î')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏à‡∏≠‡∏î‡∏£‡∏ñ')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏õ‡πâ‡∏≠‡∏°‡∏¢‡∏≤‡∏°')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏•‡∏≤‡∏ô‡∏Å‡∏µ‡∏¨‡∏≤')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏•‡∏≤‡∏î‡∏¢‡∏≤‡∏á')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏ó‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏∑‡∏≠')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        } else if (selectedValue.includes('‡∏ï‡∏∂‡∏Å')) {
                            bMatSelect.value = '‡∏ï‡∏∂‡∏Å';
                        }
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏î ‡πÜ ‚Üí ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                        
                        // ============================================
                        // 2. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô)
                        // ============================================
                        if (selectedValue.includes('‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡πÇ‡∏£‡∏á‡∏à‡∏≠‡∏î‡∏£‡∏ñ')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡πÇ‡∏£‡∏á‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á‡∏™‡∏±‡∏ï‡∏ß‡πå')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏ï‡∏•‡∏≤‡∏î')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏£‡∏ñ')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏õ‡πâ‡∏≠‡∏°‡∏¢‡∏≤‡∏°')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏°‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏™‡∏£‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏•‡∏≤‡∏ô‡∏Å‡∏µ‡∏¨‡∏≤')) {
                            noFloorSelect.value = '1';
                        } else if (selectedValue.includes('‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '2';
                        } else if (selectedValue.includes('‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '3';
                        } else if (selectedValue.includes('‡∏™‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '4';
                        } else if (selectedValue.includes('‡∏´‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '5';
                        } else if (selectedValue.includes('‡∏´‡∏Å‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '6';
                        }
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏î ‡πÜ ‚Üí ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                    };
                    
                    // ‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô)
                    bTypeSelect.addEventListener('change', updateBuildingDependencies);
                    
                    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á
                    updateBuildingDependencies();
                    
                    console.log('‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö "‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ï‡∏∂‡∏Å‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡πÑ‡∏°‡πâ" ‡∏Å‡πà‡∏≠‡∏ô)');
                }
            }

            // ‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
            if (type === 'building') {
                const bTypeSelect = document.querySelector('select[name="b_type"]');
                const noFloorSelect = document.querySelector('select[name="no_floor"]');
                if (bTypeSelect && noFloorSelect) {
                    const updateNoFloor = () => {
                        const selectedValue = bTypeSelect.value;
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß"
                        if (selectedValue.includes('‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß')) {
                            noFloorSelect.value = '1';
                        }
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô"
                        else if (selectedValue.includes('‡∏™‡∏≠‡∏á‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '2';
                        }
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô"
                        else if (selectedValue.includes('‡∏™‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '3';
                        }
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏™‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô"
                        else if (selectedValue.includes('‡∏™‡∏µ‡πà‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '4';
                        }
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô"
                        else if (selectedValue.includes('‡∏´‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '5';
                        }
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏´‡∏Å‡∏ä‡∏±‡πâ‡∏ô"
                        else if (selectedValue.includes('‡∏´‡∏Å‡∏ä‡∏±‡πâ‡∏ô')) {
                            noFloorSelect.value = '6';
                        }
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏î ‡πÜ ‚Üí ‡∏Ñ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏° (‡πÑ‡∏°‡πà‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤)
                    };
                    // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á"
                    bTypeSelect.addEventListener('change', updateNoFloor);
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà)
                    updateNoFloor();
                    console.log('‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á');
                }
            }

            // ‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô '‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á' + ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ", "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" ‡πÅ‡∏•‡∏∞ "‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á (2)" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            if (type === 'building') {
                const fullAreaSelect = document.querySelector('select[name="full_area"]');
                const noFloorSelect = document.querySelector('select[name="no_floor"]');
                const buseFloorInput = document.querySelector('input[name="buse_floor"]');
                const bAreaInput = document.querySelector('input[name="b_area"]');
                const buseAreaInput = document.querySelector('input[name="buse_area"]');
                const fullArea2Select = document.querySelector('select[name="full_area2"]'); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
                
                if (fullAreaSelect && noFloorSelect && buseFloorInput && bAreaInput && buseAreaInput && fullArea2Select) {
                    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" ‡∏à‡∏≤‡∏Å "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô" (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà")
                    const updateBuseFloor = () => {
                        if (fullAreaSelect.value === '‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà') {
                            const noFloorValue = noFloorSelect.value;
                            buseFloorInput.value = noFloorValue ? `1-${noFloorValue}` : '1-1';
                        }
                    };
                    
                    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" ‡∏à‡∏≤‡∏Å "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á" (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà")
                    const updateBuseArea = () => {
                        if (fullAreaSelect.value === '‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà') {
                            buseAreaInput.value = bAreaInput.value || '';
                        }
                    };
                    
                    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ "‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á (2)" ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô"
                    const syncFullArea2 = () => {
                        if (fullAreaSelect.value === '‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô' && !fullArea2Select.disabled) {
                            fullArea2Select.value = '‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô';
                        }
                    };
                    
                    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2 (‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ + ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà")
                    const toggleGroup2 = () => {
                        const isFullArea = fullAreaSelect.value === '‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà';
                        
                        // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2 ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        const group2Fields = [
                            'b_use2', 'per_use2', 'buse_floor2', 'buse_area2', 'ment_use2'
                            // ‚ùå ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° 'full_area2' ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
                        ];
                        
                        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà 2 (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô full_area2)
                        group2Fields.forEach(fieldId => {
                            const field = document.querySelector(`[name="${fieldId}"]`);
                            if (field) {
                                if (isFullArea) {
                                    field.value = '';
                                    field.disabled = true;
                                    field.style.backgroundColor = '#f3f4f6';
                                    field.style.cursor = 'not-allowed';
                                } else {
                                    field.disabled = false;
                                    field.style.backgroundColor = '';
                                    field.style.cursor = '';
                                }
                            }
                        });
                        
                        // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ "‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á (2)" ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
                        if (isFullArea) {
                            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"
                            fullArea2Select.value = '';
                            fullArea2Select.disabled = true;
                            fullArea2Select.style.backgroundColor = '#f3f4f6';
                            fullArea2Select.style.cursor = 'not-allowed';
                            
                            // ‚úÖ ‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå change ‡∏ö‡∏ô b_use2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï land_use ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            const bUse2Field = document.querySelector('select[name="b_use2"]');
                            if (bUse2Field) {
                                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô)
                                bUse2Field.value = '';
                                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå change
                                const changeEvent = new Event('change', { bubbles: true });
                                bUse2Field.dispatchEvent(changeEvent);
                                console.log('‚úÖ ‡∏ó‡∏£‡∏¥‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå change event ‡∏ö‡∏ô b_use2 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï land_use');
                            }
                        } else {
                            // ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"
                            fullArea2Select.disabled = false;
                            fullArea2Select.style.backgroundColor = '';
                            fullArea2Select.style.cursor = '';
                            
                            // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô" ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô" ‡πÉ‡∏ô full_area
                            syncFullArea2();
                        }
                        
                        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï "‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ" ‡πÅ‡∏•‡∏∞ "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ"
                        updateBuseFloor();
                        updateBuseArea();
                    };
                    
                    // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô "‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á"
                    fullAreaSelect.addEventListener('change', toggleGroup2);
                    
                    // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô"
                    noFloorSelect.addEventListener('change', updateBuseFloor);
                    
                    // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á"
                    bAreaInput.addEventListener('input', updateBuseArea);
                    
                    // ‚úÖ ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï full_area2 ‡πÄ‡∏°‡∏∑‡πà‡∏≠ full_area ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô"
                    fullAreaSelect.addEventListener('change', syncFullArea2);
                    
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á
                    toggleGroup2();
                }
            }
            // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ "‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô" ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á)
            if (type === 'building') {
                const updateLandUse = () => {
                    const bUse = document.querySelector('select[name="b_use"]')?.value || '';
                    const bUse2 = document.querySelector('select[name="b_use2"]')?.value || '';
                    const landUseSelect = document.querySelector('select[name="land_use"]');
                    
                    if (!landUseSelect) return;
                    
                    let newValue = '';
                    
                    // ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
                    if (bUse && bUse2) {
                        newValue = '5-‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó'; // ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡πà‡∏≤
                    } else if (bUse) {
                        newValue = bUse; // ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å b_use ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    } else if (bUse2) {
                        newValue = bUse2; // ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å b_use2 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                    }
                    
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    landUseSelect.value = newValue;
                    landUseSelect.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    landUseSelect.style.backgroundColor = '#f3f4f6'; // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô
                    landUseSelect.style.cursor = 'not-allowed';
                };
                
                // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤
                const bUseSelect = document.querySelector('select[name="b_use"]');
                const bUse2Select = document.querySelector('select[name="b_use2"]');
                
                if (bUseSelect && bUse2Select) {
                    bUseSelect.addEventListener('change', updateLandUse);
                    bUse2Select.addEventListener('change', updateLandUse);
                    
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    updateLandUse();
                }
            }
            // ‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å 'b_note' ‡πÑ‡∏õ‡∏¢‡∏±‡∏á 'ment_use' ‡πÅ‡∏•‡∏∞ 'ment_use2' (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà b_note ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
            if (type === 'building') {
                const bNoteInput = document.querySelector('input[name="b_note"]');
                const mentUseInput = document.querySelector('input[name="ment_use"]');
                const mentUse2Input = document.querySelector('input[name="ment_use2"]');
                
                if (bNoteInput && mentUseInput && mentUse2Input) {
                    // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≤‡∏Å b_note (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
                    const syncFromBNote = () => {
                        const value = bNoteInput.value;
                        
                        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ment_use ‡πÄ‡∏™‡∏°‡∏≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô
                        mentUseInput.value = value;
                        console.log(`üîÑ b_note ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ment_use = "${value}"`);
                        
                        // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ment_use2 ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
                        if (!mentUse2Input.disabled) {
                            mentUse2Input.value = value;
                            console.log(`üîÑ b_note ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ment_use2 = "${value}" (‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏¢‡∏π‡πà)`);
                        } else {
                            console.log(`‚è≠Ô∏è b_note ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÅ‡∏ï‡πà ment_use2 ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‚Üí ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï`);
                        }
                    };
                    
                    // ‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå 'change' (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)
                    bNoteInput.addEventListener('change', syncFromBNote);
                    
                    // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á
                    // syncFromBNote();
                    
                    console.log('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á b_note ‚Üí ment_use (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô) + ment_use2 (‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç)');
                } else {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå b_note, ment_use ‡∏´‡∏£‡∏∑‡∏≠ ment_use2');
                }
            }

            // ‚úÖ ‡∏ú‡∏π‡∏Å Event Listeners ‡∏Å‡∏±‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
            if (type === 'building') {
                const bNoteInput = document.querySelector('input[name="b_note"]');
                const bUseSelect = document.querySelector('select[name="b_use"]');
                const bUse2Select = document.querySelector('select[name="b_use2"]');
                
                // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠ b_note ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                if (bNoteInput) {
                    bNoteInput.addEventListener('change', autoFillBasedOnConditions);
                    bNoteInput.addEventListener('input', autoFillBasedOnConditions);
                }
                
                // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠ b_use ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                if (bUseSelect) {
                    bUseSelect.addEventListener('change', autoFillBasedOnConditions);
                }
                
                // ‚úÖ ‡πÄ‡∏°‡∏∑‡πà‡∏≠ b_use2 ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‚Üí ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                if (bUse2Select) {
                    bUse2Select.addEventListener('change', autoFillBasedOnConditions);
                }
                
                // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)
                setTimeout(() => {
                    autoFillBasedOnConditions();
                }, 100);
            }

            if (type === 'sign') {
                // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤ s_characte ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                const updateSCharacte = () => {
                    const contentTypeEl = document.querySelector('select[name="content_type_temp"]');
                    const signTypeDetailEl = document.querySelector('select[name="sign_type_detail_temp"]');
                    const sCharacteEl = document.querySelector('input[name="s_characte"]');
                    
                    if (!contentTypeEl || !signTypeDetailEl || !sCharacteEl) return;
                    
                    const num = contentTypeEl.value.charAt(0); // ‡∏î‡∏∂‡∏á‡πÄ‡∏•‡∏Ç‡∏´‡∏ô‡πâ‡∏≤‡∏™‡∏∏‡∏î (1, 2, 3, 4)
                    const letterMatch = signTypeDetailEl.value.match(/\(([^)]+)\)/); // ‡∏î‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡∏ß‡∏á‡πÄ‡∏•‡πá‡∏ö
                    const letter = letterMatch ? letterMatch[1].charAt(0) : ''; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å (‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ç)
                    
                    sCharacteEl.value = num && letter ? `${num}(${letter})` : '-';
                };
                
                // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤
                const contentTypeEl = document.querySelector('select[name="content_type_temp"]');
                const signTypeDetailEl = document.querySelector('select[name="sign_type_detail_temp"]');
                
                if (contentTypeEl && signTypeDetailEl) {
                    contentTypeEl.addEventListener('change', updateSCharacte);
                    signTypeDetailEl.addEventListener('change', updateSCharacte);
                    
                    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                    if (data.s_characte) {
                        const match = data.s_characte.match(/^(\d)\(([^)]+)\)$/);
                        if (match) {
                            const num = match[1];
                            const letter = match[2];
                            
                            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                            for (let opt of contentTypeEl.options) {
                                if (opt.value.startsWith(`${num}.`)) {
                                    contentTypeEl.value = opt.value;
                                    break;
                                }
                            }
                            
                            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏õ‡πâ‡∏≤‡∏¢
                            for (let opt of signTypeDetailEl.options) {
                                if (opt.value.includes(`(${letter})`)) {
                                    signTypeDetailEl.value = opt.value;
                                    break;
                                }
                            }
                        }
                    }
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    updateSCharacte();
                }
            }

            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            const imagePreviewContainer = document.getElementById('image-preview-container');
            if (imagePreviewContainer && imagePreviewContainer.style.display === 'flex') {
                console.log('üñºÔ∏è ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‚Üí ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà');
                if (data.image && data.image.trim() !== '') {
                    showImagePreview(data.image, data.picture || '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô
                    const placeholder = document.getElementById('image-preview-placeholder');
                    const img = document.getElementById('image-preview');
                    if (placeholder && img) {
                        img.classList.add('hidden');
                        placeholder.textContent = '‚ö†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
                        placeholder.classList.remove('text-gray-300');
                        placeholder.classList.add('text-yellow-500', 'font-medium');
                    }
                }
            }

            document.getElementById('side-panel').classList.add('open');
            marker.closePopup();
        }

        function closePanel() {
            const panel = document.getElementById('side-panel');
            if (panel) {
                panel.classList.remove('open');
            }
            // ‚úÖ ‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏á (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
            // hideImagePreview();
        }


        function locateUser() { 
            map.locate({setView: true, maxZoom: 18}); 
            map.once('locationfound', (e) => {
                L.circleMarker(e.latlng, { radius: 8, fillColor: '#2563eb', color: '#fff', weight: 3, fillOpacity: 0.9 }).addTo(map);
            });
        }
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        let deleteMarkerData = null;
        let deleteMarkerType = null;
        let deleteMarkerRef = null;

        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        function showDeleteConfirm(marker, data, type) {
            deleteMarkerRef = marker;
            deleteMarkerData = data;
            deleteMarkerType = type;
            
            const title = document.getElementById('delete-modal-title');
            const message = document.getElementById('delete-modal-message');
            
            if (type === 'building') {
                title.textContent = '‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á';
                message.textContent = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ';
            } else {
                title.textContent = '‡∏•‡∏ö‡∏õ‡πâ‡∏≤‡∏¢';
                message.textContent = '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏ô‡∏µ‡πâ? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ';
            }
            
            document.getElementById('confirm-delete-modal').classList.remove('hidden');
            document.getElementById('confirm-delete-modal').classList.add('flex');
        }

        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        function cancelDelete() {
            document.getElementById('confirm-delete-modal').classList.add('hidden');
            deleteMarkerData = null;
            deleteMarkerType = null;
            deleteMarkerRef = null;
        }

        // ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö
        async function confirmDeleteAction() {
            if (!deleteMarkerRef || !deleteMarkerData || !deleteMarkerType) {
                cancelDelete();
                return;
            }
            
            // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            document.getElementById('confirm-delete-modal').classList.add('hidden');
            
            try {
                await deleteMarker(deleteMarkerRef, deleteMarkerData, deleteMarkerType);
            } catch (err) {
                console.error("Error in delete action:", err);
            } finally {
                cancelDelete();
            }
        }

        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        function showEditModeModal() {
            document.getElementById('edit-mode-modal').classList.remove('hidden');
            document.getElementById('edit-mode-modal').classList.add('flex');
            
            // ‡∏õ‡∏¥‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                closeEditModeModal();
            }, 4000);
        }

        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        function closeEditModeModal() {
            document.getElementById('edit-mode-modal').classList.add('hidden');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function toggleTable() {
            const panel = document.getElementById('data-table-panel');
            const imagePreview = document.getElementById('image-preview-container');
            const btn = document.getElementById('btn-show-table');
            
            panel.classList.toggle('open');
            
            // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            if (panel.classList.contains('open')) {
                // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‚Üí ‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                if (imagePreview && imagePreview.style.display !== 'none') {
                    imagePreview.style.bottom = `calc(5px + 45vh + 10px)`;
                }
                btn.innerHTML = '<i data-lucide="x" class="w-6 h-6 text-red-600"></i>';
            } else {
                // ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‚Üí ‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏° (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á)
                if (imagePreview && imagePreview.style.display !== 'none') {
                    imagePreview.style.bottom = '5px';
                }
                btn.innerHTML = '<i data-lucide="table" class="w-6 h-6 text-blue-600"></i>';
            }
            
            lucide.createIcons();
            // ‚úÖ ‡∏Å‡∏î‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            triggerAutoRefresh();
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡πÅ‡∏ó‡πá‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function switchTableTab(type) {
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ó‡πá‡∏ö
            document.querySelectorAll('.table-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            document.getElementById('building-table-container').classList.toggle('hidden', type !== 'building');
            document.getElementById('sign-table-container').classList.toggle('hidden', type !== 'sign');
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡∏π‡∏°‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
        function zoomToLocation(latlng, zoomLevel = 18) {
            map.setView(latlng, zoomLevel);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
            const blinkMarker = L.circleMarker(latlng, {
                radius: 15,
                fillColor: '#22d3ee',
                color: '#fff',
                weight: 3,
                fillOpacity: 0.8,
                opacity: 1
            }).addTo(map);
            
            // ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
            let count = 0;
            const blinkInterval = setInterval(() => {
                blinkMarker.setStyle({
                    opacity: blinkMarker.options.opacity === 1 ? 0 : 1,
                    fillOpacity: blinkMarker.options.fillOpacity === 0.8 ? 0 : 0.8
                });
                count++;
                if (count >= 6) {
                    clearInterval(blinkInterval);
                    map.removeLayer(blinkMarker);
                }
            }, 300);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
        function renderBuildingTable() {
            const tbody = document.getElementById('building-table-body');
            
            if (!allBuildings || allBuildings.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á</td></tr>';
                return;
            }
            
            // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° ID (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞)
            const sortedBuildings = sortBuildings(allBuildings, buildingSortColumn, buildingSortDirection);

            tbody.innerHTML = sortedBuildings.map(building => {
                if (!building.lat_long) return '';
                
                const [lat, lng] = building.lat_long.split(',').map(Number);
                if (isNaN(lat) || isNaN(lng)) return '';
                
                // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                let statusClass = 'status-‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à';
                let statusText = building.check || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à';
                
                if (building.check === '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß') {
                    statusClass = 'status-‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß';
                } else if (building.check === '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') {
                    statusClass = 'status-‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß';
                }
                
                // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á "-")
                const displayValue = (val) => val && val.toString().trim() !== '' ? val : '-';
                
                return `
                    <tr>
                        <td><span class="marker-icon marker-building"></span></td>
                        <td class="font-medium">${displayValue(building.building_c)}</td>
                        <td>${displayValue(building.full_name)}</td>
                        <td class="text-center">${displayValue(building.hs_no)}</td>
                        <td class="text-center">${displayValue(building.hs_moo)}</td>
                        <td>${displayValue(building.b_type)}</td>
                        <td class="text-center">${displayValue(building.b_mat)}</td>
                        <td class="text-center">${displayValue(building.no_floor)}</td>
                        <td class="text-center">${displayValue(building.b_area)}</td>
                        <td class="text-center">${displayValue(building.b_year)}</td>
                        <td>${displayValue(building.b_note)}</td>
                        <td>${displayValue(building.b_use)}</td>
                        <td>${displayValue(building.buse_area)}</td>
                        <td>${displayValue(building.b_use2)}</td>
                        <td>${displayValue(building.buse_area2)}</td>
                        <td>${displayValue(building.land_use)}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="zoom-btn" onclick="zoomToLocation(L.latLng(${lat}, ${lng}))">
                                <i data-lucide="locate" class="w-3 h-3 inline"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            updateTableCounters();

            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à
            lucide.createIcons();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function updateTableCounters() {
            const buildingCount = allBuildings ? allBuildings.length : 0;
            const signCount = allSigns ? allSigns.length : 0;
            
            const buildingBadge = document.getElementById('building-count-badge');
            const signBadge = document.getElementById('sign-count-badge');
            
            if (buildingBadge) {
                buildingBadge.textContent = buildingCount;
            }
            
            if (signBadge) {
                signBadge.textContent = signCount;
            }
            
            console.log(`üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á: ${buildingCount}, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡πâ‡∏≤‡∏¢: ${signCount}`);
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ü‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á
        // ============================================

        /**
         * ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ü‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á
         */
        function toggleSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            const icon = document.getElementById('settings-icon');
            const badge = document.getElementById('settings-badge');
            
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                icon.classList.add('animate-spin');
                if (badge) badge.classList.add('hidden');
                
                // ‚úÖ ‡πÉ‡∏ä‡πâ requestAnimationFrame 2 ‡∏ä‡∏±‡πâ‡∏ô (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å!)
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        const buttons = menu.querySelectorAll('button');
                        buttons.forEach((btn, index) => {
                            setTimeout(() => {
                                btn.style.opacity = '1';
                                btn.style.transform = 'translateY(0)';
                            }, index * 100);
                        });
                    });
                });
                
                setTimeout(() => {
                    document.addEventListener('click', closeSettingsMenuOnClickOutside);
                }, 100);
                
            } else {
                closeSettingsMenu();
            }
        }

        /**
         * ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
         */
        function closeSettingsMenuOnClickOutside(e) {
            const settingsBtn = document.getElementById('btn-settings');
            const settingsMenu = document.getElementById('settings-menu');
            
            if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
                closeSettingsMenu();
                document.removeEventListener('click', closeSettingsMenuOnClickOutside);
            }
        }

        /**
         * ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
         */
        function closeSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            const icon = document.getElementById('settings-icon');
            
            const buttons = menu.querySelectorAll('button');
            
            // ‚úÖ ‡πÉ‡∏ä‡πâ requestAnimationFrame ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏î‡πâ‡∏ß‡∏¢
            requestAnimationFrame(() => {
                buttons.forEach((btn, index) => {
                    setTimeout(() => {
                        btn.style.opacity = '0';
                        btn.style.transform = 'translateY(-20px)';
                    }, (buttons.length - index - 1) * 60);
                });
            });
            
            setTimeout(() => {
                menu.classList.add('hidden');
                icon.classList.remove('animate-spin');
                document.removeEventListener('click', closeSettingsMenuOnClickOutside);
            }, buttons.length * 60 + 100);
        }

        /**
         * ‡∏õ‡∏∏‡πà‡∏° 1: ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á (GeoJSON)
         */
        async function exportBuildingGeoJSON() {
          closeSettingsMenu();
          
          // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
          showNotificationLeft('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á...', 'info');
          
          try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            const res = await fetch(`${CONFIG.SCRIPT_URL}?action=exportGeoJSON&type=building`);
            const geojsonData = await res.json();
            
            if (geojsonData.type === 'FeatureCollection') {
              // ‡∏™‡∏£‡πâ‡∏≤‡∏á Blob ‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
              const blob = new Blob([JSON.stringify(geojsonData, null, 2)], { 
                type: 'application/geo+json' 
              });
              
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `buildings_${new Date().toISOString().slice(0,10)}.geojson`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
              
              showNotificationLeft('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } else {
              throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
          } catch (err) {
            console.error('Error exporting buildings:', err);
            showNotificationLeft('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
          }
        }

        /**
         * ‡∏õ‡∏∏‡πà‡∏° 2: ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≤‡∏¢ (GeoJSON)
         */
        async function exportSignGeoJSON() {
          closeSettingsMenu();
          
          showNotificationLeft('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡πâ‡∏≤‡∏¢...', 'info');
          
          try {
            const res = await fetch(`${CONFIG.SCRIPT_URL}?action=exportGeoJSON&type=sign`);
            const geojsonData = await res.json();
            
            if (geojsonData.type === 'FeatureCollection') {
              const blob = new Blob([JSON.stringify(geojsonData, null, 2)], { 
                type: 'application/geo+json' 
              });
              
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `signs_${new Date().toISOString().slice(0,10)}.geojson`;
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);
              
              showNotificationLeft('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏õ‡πâ‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } else {
              throw new Error('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            }
          } catch (err) {
            console.error('Error exporting signs:', err);
            showNotificationLeft('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
          }
        }

        /**
         * ‡∏õ‡∏∏‡πà‡∏° 3: ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive
         */
        async function loadBuildingImages() {
          closeSettingsMenu();
          
          showNotificationLeft('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á...', 'info');
          
          try {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const res = await fetch(`${CONFIG.SCRIPT_URL}?action=getData`);
            const data = await res.json();
            const buildings = data.buildings || [];
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            const buildingsWithImages = buildings.filter(b => b.image && b.image.trim() !== '');
            
            if (buildingsWithImages.length === 0) {
              showNotificationLeft('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á', 'warning');
              return;
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            showImageGallery(buildingsWithImages, 'building');
            
          } catch (err) {
            console.error('Error loading building images:', err);
            showNotificationLeft('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
          }
        }

        /**
         * ‡∏õ‡∏∏‡πà‡∏° 4: ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏õ‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive
         */
        async function loadSignImages() {
          closeSettingsMenu();
          
          showNotificationLeft('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡πâ‡∏≤‡∏¢...', 'info');
          
          try {
            const res = await fetch(`${CONFIG.SCRIPT_URL}?action=getData`);
            const data = await res.json();
            const signs = data.signs || [];
            
            const signsWithImages = signs.filter(s => s.picture && s.picture.trim() !== '');
            
            if (signsWithImages.length === 0) {
              showNotificationLeft('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡πâ‡∏≤‡∏¢', 'warning');
              return;
            }
            
            showImageGallery(signsWithImages, 'sign');
            
          } catch (err) {
            console.error('Error loading sign images:', err);
            showNotificationLeft('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
          }
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
         */
        function showImageGallery(items, type) {
            // ‚úÖ ‡∏Ç‡πâ‡∏≠ 1: ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå
            const filteredItems = items.filter(item => {
                if (type === 'building') {
                    return item.image && item.image.trim() !== '';
                } else {
                    return item.picture && item.picture.trim() !== '';
                }
            });
            
            if (filteredItems.length === 0) {
                showNotificationLeft('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå', 'warning');
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà
            const galleryDiv = document.createElement('div');
            galleryDiv.id = 'image-gallery-modal';
            galleryDiv.className = 'fixed inset-0 bg-black/90 z-[3000] flex flex-col p-4 overflow-hidden';
            
            // ‚úÖ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            let isGridView = false;
            
            galleryDiv.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-white text-xl font-bold">
                    ${type === 'building' ? '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á' : '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡πâ‡∏≤‡∏¢'} (${filteredItems.length} ‡∏£‡∏π‡∏õ)
                </h3>
                <div class="flex gap-2">
                    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á (‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û) -->
                    <button onclick="toggleGalleryView()" id="btn-toggle-view" class="bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center gap-2">
                        <i data-lucide="grid" id="view-icon" class="w-4 h-4"></i>
                        <span id="view-text">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û</span>
                    </button>
                    <!-- ‚úÖ ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
                    <button onclick="downloadAllImagesAsZip()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                    </button>
                    <button onclick="closeImageGallery()" class="text-white hover:text-gray-300 transition">
                        <i data-lucide="x" class="w-8 h-8"></i>
                    </button>
                </div>
            </div>
            <!-- ‚úÖ ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏•‡∏±‡∏ö‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á -->
            <div id="gallery-container" class="flex-1 overflow-y-auto">
                <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toggleGalleryView() -->
            </div>
            `;
            
            document.body.appendChild(galleryDiv);
            lucide.createIcons();
            
            // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
            renderGalleryListView(filteredItems, type);
        }

        // ‚úÖ ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let currentGalleryItems = [];
        let currentGalleryType = '';
        let isGridView = false; // ‚úÖ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: false = ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠

        /**
         * ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏•‡∏±‡∏ö‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
         */
        function toggleGalleryView() {
            isGridView = !isGridView;
            
            const btn = document.getElementById('btn-toggle-view');
            const icon = document.getElementById('view-icon');
            const text = document.getElementById('view-text');
            
            if (isGridView) {
                // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
                btn.className = 'bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center gap-2';
                icon.innerHTML = '<i data-lucide="list" class="w-4 h-4"></i>';
                text.textContent = '‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠';
                renderGalleryGridView(currentGalleryItems, currentGalleryType);
            } else {
                // ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠
                btn.className = 'bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition flex items-center gap-2';
                icon.innerHTML = '<i data-lucide="grid" class="w-4 h-4"></i>';
                text.textContent = '‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏û';
                renderGalleryListView(currentGalleryItems, currentGalleryType);
            }
            
            lucide.createIcons();
        }

        /**
         * ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (Grid View)
         */
        function renderGalleryGridView(items, type) {
            currentGalleryItems = items;
            currentGalleryType = type;
            
            const container = document.getElementById('gallery-container');
            
            container.innerHTML = `
            <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                ${items.map((item, index) => `
                <div class="relative group cursor-pointer" onclick="openImageViewer(${index}, '${type}')">
                    <img src="${type === 'building' ? item.image : item.picture}"
                        alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${index + 1}"
                        class="w-full h-32 object-cover rounded-lg hover:opacity-75 transition"
                        onerror="this.src='https://via.placeholder.com/150?text=No+Image'">
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center">
                        <span class="text-white text-sm font-bold">‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà</span>
                    </div>
                    <div class="mt-1 text-xs text-white truncate">
                        ${type === 'building' ? (item.building_c || item.full_name || '-') : (item.s_code || item.s_name || '-')}
                    </div>
                </div>
                `).join('')}
            </div>
            `;
            
            lucide.createIcons();
        }

        /**
         * ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (List View)
         */
        function renderGalleryListView(items, type) {
            currentGalleryItems = items;
            currentGalleryType = type;
            
            const container = document.getElementById('gallery-container');
            
            container.innerHTML = `
            <div class="bg-gray-800 rounded-lg overflow-hidden">
                <div class="grid grid-cols-[40px_1fr_120px_80px] gap-2 p-3 bg-gray-700 text-white font-bold text-sm">
                    <span>#</span>
                    <span>‡∏ä‡∏∑‡πà‡∏≠</span>
                    <span>‡∏Ç‡∏ô‡∏≤‡∏î</span>
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</span>
                </div>
                <div class="max-h-[calc(100vh-150px)] overflow-y-auto">
                    ${items.map((item, index) => `
                    <div class="grid grid-cols-[40px_1fr_120px_80px] gap-2 p-3 border-b border-gray-700 hover:bg-gray-700/50 transition cursor-pointer" onclick="openImageViewer(${index}, '${type}')">
                        <span class="text-gray-400 text-sm">${index + 1}</span>
                        <div class="flex items-center gap-2">
                            <i data-lucide="image" class="w-4 h-4 text-blue-400"></i>
                            <span class="text-white truncate">
                                ${type === 'building' ? (item.building_c || item.full_name || '-') : (item.s_code || item.s_name || '-')}
                            </span>
                        </div>
                        <span class="text-gray-400 text-xs">-</span>
                        <button onclick="event.stopPropagation(); downloadSingleImage('${type === 'building' ? item.image : item.picture}', '${type === 'building' ? (item.building_c || 'building') : (item.s_code || 'sign')}')" 
                            class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 transition text-xs flex items-center justify-center gap-1">
                            <i data-lucide="download" class="w-3 h-3"></i>
                        </button>
                    </div>
                    `).join('')}
                </div>
            </div>
            `;
            
            lucide.createIcons();
        }

        /**
         * ‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
         */
        function downloadSingleImage(url, filename) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filename}_${Date.now()}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotificationLeft(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${filename} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
        }

        // ============================================
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÉ‡∏ä‡πâ JSZip) - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
        // ============================================
        async function downloadAllImagesAsZip() {
            showNotificationLeft('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', 'info');
            
            try {
                const galleryGrid = document.getElementById('gallery-grid');
                if (!galleryGrid) {
                    showNotificationLeft('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
                    return;
                }
                
                const items = [];
                const type = document.querySelector('#image-gallery-modal h3')?.innerText.includes('‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á') ? 'building' : 'sign';
                
                galleryGrid.querySelectorAll('.relative.group').forEach((el, index) => {
                    const img = el.querySelector('img');
                    const url = img?.src;
                    const codeEl = el.querySelector('p.font-bold');
                    const codeText = codeEl?.innerText || '';
                    const code = codeText.replace(/[^0-9]/g, '');
                    
                    // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    if (url && url !== 'https://via.placeholder.com/150?text=No+Image') {
                        items.push({
                            url: url,
                            filename: `${type === 'building' ? 'B' : 'S'}${code || index + 1}.jpg`
                        });
                    }
                });
                
                if (items.length === 0) {
                    showNotificationLeft('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î', 'warning');
                    return;
                }
                
                showNotificationLeft(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${items.length} ‡∏£‡∏π‡∏õ...`, 'info');
                
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÉ‡∏ô URL JSZip
                if (typeof JSZip === 'undefined') {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js'; // ‚úÖ ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
                        script.onload = resolve;
                        script.onerror = () => reject(new Error('Failed to load JSZip'));
                        document.head.appendChild(script);
                    });
                }
                
                const zip = new JSZip();
                const folder = zip.folder(type === 'building' ? 'buildings' : 'signs');
                let successCount = 0;
                
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    try {
                        const response = await fetch(item.url);
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        
                        const blob = await response.blob();
                        folder.file(item.filename, blob);
                        successCount++;
                        
                        if ((i + 1) % 5 === 0 || i === items.length - 1) {
                            showNotificationLeft(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (${successCount}/${items.length})...`, 'info');
                        }
                    } catch (err) {
                        console.error(`‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${item.filename} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, err);
                    }
                }
                
                if (successCount === 0) {
                    showNotificationLeft('‚ùå ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'error');
                    return;
                }
                
                const content = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `${type === 'building' ? 'buildings' : 'signs'}_${new Date().toISOString().slice(0, 10)}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
                showNotificationLeft(`‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${successCount} ‡∏£‡∏π‡∏õ) ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!`, 'success');
            } catch (err) {
                console.error('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', err);
                showNotificationLeft('‚ùå ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
            }
        }

        /**
         * ‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
         */
        function openImageViewer(index, type) {
            const items = currentGalleryItems;
            const item = items[index];
            
            if (!item) return;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà
            const viewerDiv = document.createElement('div');
            viewerDiv.id = 'image-viewer-modal';
            viewerDiv.className = 'fixed inset-0 bg-black/95 z-[3001] flex items-center justify-center p-4';
            viewerDiv.onclick = (e) => {
                if (e.target === viewerDiv) closeImageViewer();
            };
            
            // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
            const imageUrl = type === 'building' ? item.image : item.picture;
            const code = type === 'building' ? item.building_c : item.s_code;
            const name = type === 'building' ? item.full_name : item.s_name;
            const address = type === 'building' ? item.address : item.comment;
            
            viewerDiv.innerHTML = `
            <div class="relative max-w-4xl w-full">
                <img src="${imageUrl}"
                    alt="‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û"
                    class="w-full max-h-[80vh] object-contain rounded-lg"
                    onerror="this.src='https://via.placeholder.com/800x600?text=No+Image'">
                <div class="absolute bottom-4 left-4 right-4 bg-black/70 text-white p-3 rounded-lg">
                    <p class="font-bold">${type === 'building' ? '‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á:' : '‡∏õ‡πâ‡∏≤‡∏¢:'} ${code || '-'}</p>
                    <p class="text-sm">${name || ''}</p>
                    <p class="text-xs mt-1">${address || ''}</p>
                </div>
                <button onclick="closeImageViewer()" class="absolute top-4 right-4 text-white hover:text-gray-300 transition">
                    <i data-lucide="x" class="w-8 h-8"></i>
                </button>
                <button onclick="downloadSingleImage('${imageUrl}', '${code || 'image'}')"
                    class="absolute top-4 left-4 bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition">
                    <i data-lucide="download" class="w-5 h-5"></i>
                </button>
            </div>
            `;
            
            document.body.appendChild(viewerDiv);
            lucide.createIcons();
        }

        /**
         * ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà
         */
        function closeImageViewer() {
          const viewer = document.getElementById('image-viewer-modal');
          if (viewer) viewer.remove();
        }

        /**
         * ‡∏õ‡∏¥‡∏î‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
         */
        function closeImageGallery() {
          const gallery = document.getElementById('image-gallery-modal');
          if (gallery) gallery.remove();
          closeImageViewer(); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏î‡∏π‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏ç‡πà‡∏î‡πâ‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        }

        /**
         * ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
         */
        function downloadImage(url, filename) {
          const link = document.createElement('a');
          link.href = url;
          link.download = `${filename}_${Date.now()}.jpg`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }


        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏¢)
         */
        function renderAllMarkers() {
          allBuildings.forEach(r => {
            if (!r.lat_long) return;
            const coords = r.lat_long.split(',').map(Number);
            if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
            const m = createCircleMarker(L.latLng(coords[0], coords[1]), 'building', isEditMode, r.check);
            setupMarkerPopup(m, r, 'building');
            m.addTo(surveyLayers);
          });
          
          allSigns.forEach(r => {
            if (!r.lat_long) return;
            const coords = r.lat_long.split(',').map(Number);
            if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
            const m = createCircleMarker(L.latLng(coords[0], coords[1]), 'sign', isEditMode, r.check);
            setupMarkerPopup(m, r, 'sign');
            m.addTo(surveyLayers);
          });
        }

        async function saveLargeFileInChunks(file, fileName) {
            const CHUNK_SIZE = 10 * 1024 * 1024; // 10MB ‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô
            const db = await openDatabase();
            const transaction = db.transaction('mapFiles', 'readwrite');
            const store = transaction.objectStore('mapFiles');
            
            for (let start = 0; start < file.size; start += CHUNK_SIZE) {
                const chunk = file.slice(start, start + CHUNK_SIZE);
                const chunkData = await chunk.arrayBuffer();
                
                await store.add({
                    id: `${fileName}_chunk_${start}`,
                    fileName: fileName,
                    chunkIndex: start / CHUNK_SIZE,
                    totalChunks: Math.ceil(file.size / CHUNK_SIZE),
                     chunkData,
                    timestamp: new Date().toISOString()
                });
            }
            
            console.log(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå ${fileName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${file.size} bytes)`);
        }

        async function compressAndSaveMap(file) {
            // ‡πÉ‡∏ä‡πâ‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î ‡πÄ‡∏ä‡πà‡∏ô pako ‡∏´‡∏£‡∏∑‡∏≠ zlib
            const compressed = await compressFile(file);
            await saveToIndexedDB(compressed);
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
        const layersToCache = ['parcel', 'boundary']; // ‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° 'building' ‡∏ñ‡πâ‡∏≤‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ

        async function downloadMapStreaming(fileId) {
            const response = await fetch(`https://drive.google.com/uc?export=download&id=${fileId}`);
            const reader = response.body.getReader();
            const chunks = [];
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                chunks.push(value);
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥‡πÄ‡∏ï‡πá‡∏°
                if (chunks.length > 10) {
                    await saveChunksToDB(chunks);
                    chunks.length = 0;
                }
            }
            
            await saveChunksToDB(chunks);
        }

        async function checkMapFileSize(fileId) {
            const response = await fetch(`https://drive.google.com/uc?export=download&id=${fileId}`, {
                method: 'HEAD'
            });
            
            const size = response.headers.get('content-length');
            const mb = (size / 1024 / 1024).toFixed(2);
            
            console.log(`‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ${mb} MB`);
            
            if (size > 50 * 1024 * 1024) {
                alert(`‚ö†Ô∏è ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (${mb} MB)\n‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÅ‡∏ö‡πà‡∏á‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡πÑ‡∏ü‡∏•‡πå`);
            }
            
            return size;
        }

        // ============================================
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á (GPU Optimized)
        // ============================================
        function updateVisibleMarkers() {
            // ‚úÖ ‡πÉ‡∏ä‡πâ requestAnimationFrame ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏™‡∏π‡∏á
            requestAnimationFrame(() => {
                const bounds = map.getBounds();
                const zoom = map.getZoom();
                const bufferRatio = isMobile() ? 1.3 : 1.5; // ‡∏•‡∏î‡∏ö‡∏±‡∏ü‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
                const bufferedBounds = bounds.pad(bufferRatio);
                
                // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡∏•‡∏∞‡∏ï‡∏±‡∏ß)
                surveyLayers.clearLayers();
                
                // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡πÅ‡∏ö‡∏ï‡∏ä‡πå
                const markersToRender = [];
                
                // ‡∏à‡∏∏‡∏î‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
                allBuildings.forEach(r => {
                    if (!r.lat_long) return;
                    const coords = r.lat_long.split(',').map(Number);
                    if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                    
                    const latLng = L.latLng(coords[0], coords[1]);
                    if (!bufferedBounds.contains(latLng)) return;
                    
                    // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
                    const recordKey = r._row_num || r.id;
                    if (markersBeingMoved.has(recordKey)) return;
                    
                    markersToRender.push({ latLng, data: r, type: 'building' });
                });
                
                // ‡∏à‡∏∏‡∏î‡∏õ‡πâ‡∏≤‡∏¢
                allSigns.forEach(r => {
                    if (!r.lat_long) return;
                    const coords = r.lat_long.split(',').map(Number);
                    if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                    
                    const latLng = L.latLng(coords[0], coords[1]);
                    if (!bufferedBounds.contains(latLng)) return;
                    
                    const recordKey = r._row_num || r.id;
                    if (markersBeingMoved.has(recordKey)) return;
                    
                    markersToRender.push({ latLng, data: r, type: 'sign' });
                });
                
                // ‚úÖ ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                markersToRender.forEach(item => {
                    const m = createCircleMarker(item.latLng, item.type, isEditMode);
                    m._popupData = item.data;
                    m.addTo(surveyLayers);
                });
                
                console.log(`‚úÖ ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå ${markersToRender.length} ‡∏à‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢ GPU (Canvas)`);
            });
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡πâ‡∏≤‡∏¢
        function renderSignTable() {
            const tbody = document.getElementById('sign-table-body');
            if (!allSigns || allSigns.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡πâ‡∏≤‡∏¢</td></tr>';
                return;
            }
            // ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderSignTable() ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß:
            const sortedSigns = sortSigns(allSigns, signSortColumn, signSortDirection);

            tbody.innerHTML = sortedSigns.map(sign => {
                if (!sign.lat_long) return '';
                const [lat, lng] = sign.lat_long.split(',').map(Number);
                if (isNaN(lat) || isNaN(lng)) return '';
                
                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                const statusClass = sign.check === '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß' ? 'status-‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß' :
                                   sign.check === '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß' ? 'status-‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : 'status-‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à';
                const statusText = sign.check || '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à';
                
                return `
                <tr>
                    <td><span class="marker-icon marker-sign"></span></td>
                    <td class="font-medium">${sign.s_code || '-'}</td>      <!-- 1. ‡∏£‡∏´‡∏±‡∏™ -->
                    <td class="text-center">${sign.s_characte || '-'}</td>       <!-- ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ inline style -->
                    <td class="text-center">${sign.s_wide || '-'}</td>        <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
                    <td class="text-center">${sign.s_length || '-'}</td>      <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
                    <td class="text-center">${sign.no_side || '-'}</td>       <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
                    <td>${sign.s_text || '-'}</td>                          <!-- 6. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° -->
                    <td class="text-center"><span class="status-badge ${statusClass}">${statusText}</span></td> <!-- ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° -->
                    <td>
                        <button class="zoom-btn" onclick="zoomToLocation(L.latLng(${lat}, ${lng}))">
                            <i data-lucide="locate" class="w-3 h-3 inline"></i>
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
            lucide.createIcons();
        }

        // ============================================
        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏´‡∏±‡∏™)
        // ============================================
        let buildingSortColumn = 'building_c';
        let buildingSortDirection = 'asc'; // 'asc' ‡∏´‡∏£‡∏∑‡∏≠ 'desc'
        let signSortColumn = 's_code';
        let signSortDirection = 'asc';

        // ‡∏Ñ‡∏≠‡∏•‡∏±‡πà‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)
        const buildingNumericColumns = ['b_area', 'b_year', 'hs_no', 'hs_moo', 'no_floor', 'buse_area', 'buse_area2'];
        const signNumericColumns = ['s_wide', 's_length', 'no_side'];

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        // ============================================
        function updateSortIndicators(tableId, sortColumn, sortDirection) {
            // ‡∏•‡∏ö‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.querySelectorAll(`#${tableId} .sort-indicator`).forEach(el => el.remove());
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡πà‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á
            const header = document.querySelector(`#${tableId} th.sortable-header[data-sort="${sortColumn}"]`);
            if (header) {
                const indicator = document.createElement('span');
                indicator.className = 'sort-indicator ml-1 text-blue-600 font-bold';
                indicator.innerHTML = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
                header.appendChild(indicator);
            }
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
        // ============================================
        function sortBuildings(data, column, direction) {
            return [...data].sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';
                
                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                if (buildingNumericColumns.includes(column)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
                
                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
                if (typeof valA === 'string' && typeof valB === 'string') {
                    const result = valA.localeCompare(valB, 'th', { numeric: true, sensitivity: 'base' });
                    return direction === 'asc' ? result : -result;
                }
                
                // Fallback
                return direction === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡πâ‡∏≤‡∏¢
        // ============================================
        function sortSigns(data, column, direction) {
            return [...data].sort((a, b) => {
                let valA = a[column] || '';
                let valB = b[column] || '';
                
                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
                if (signNumericColumns.includes(column)) {
                    valA = parseFloat(valA) || 0;
                    valB = parseFloat(valB) || 0;
                    return direction === 'asc' ? valA - valB : valB - valA;
                }
                
                // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
                if (typeof valA === 'string' && typeof valB === 'string') {
                    const result = valA.localeCompare(valB, 'th', { numeric: true, sensitivity: 'base' });
                    return direction === 'asc' ? result : -result;
                }
                
                // Fallback
                return direction === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
        }

        // ============================================
        // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
            document.querySelectorAll('#building-table .sortable-header').forEach(header => {
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if (buildingSortColumn === column) {
                        buildingSortDirection = buildingSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        buildingSortColumn = column;
                        buildingSortDirection = 'asc';
                    }
                    updateSortIndicators('building-table', buildingSortColumn, buildingSortDirection);
                    renderBuildingTable(); // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
                });
            });
            
            // ‡∏ú‡∏π‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡πâ‡∏≤‡∏¢
            document.querySelectorAll('#sign-table .sortable-header').forEach(header => {
                header.style.cursor = 'pointer';
                header.style.userSelect = 'none';
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if (signSortColumn === column) {
                        signSortDirection = signSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        signSortColumn = column;
                        signSortDirection = 'asc';
                    }
                    updateSortIndicators('sign-table', signSortColumn, signSortDirection);
                    renderSignTable(); // ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà
                });
            });
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            updateSortIndicators('building-table', buildingSortColumn, buildingSortDirection);
            updateSortIndicators('sign-table', signSortColumn, signSortDirection);
        });

        // ============================================
        // ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        // ============================================
        async function loadExistingData() {
          try {
            const res = await fetch(`${CONFIG.SCRIPT_URL.trim()}?action=getData`);
            const data = await res.json();
            
            // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "1-1", "1-2"
            if (data.buildings && Array.isArray(data.buildings)) {
              data.buildings.forEach(b => {
                b.buse_floor = normalizeFloorValue(b.buse_floor);
                b.buse_floor2 = normalizeFloorValue(b.buse_floor2);
              });
            }
            
            // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
            const tempMarkers = [];
            surveyLayers.eachLayer(layer => {
              if (layer._popupData && layer._popupData.tempMarker && !layer._popupData.beingMoved) {
                tempMarkers.push({
                  latlng: layer.getLatLng(),
                  data: layer._popupData,
                  type: layer._popupData.type
                });
              }
            });
            
            surveyLayers.clearLayers();
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå
            allBuildings = data.buildings || [];
            allSigns = data.signs || [];
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            renderBuildingTable();
            renderSignTable();
            
            const totalMarkers = allBuildings.length + allSigns.length;
            const useOptimizedRendering = totalMarkers > 200;
            
                
                if (useOptimizedRendering) {
                    map.off('moveend', updateVisibleMarkers);
                    map.off('zoomend', updateVisibleMarkers);
                    map.on('moveend', updateVisibleMarkers);
                    map.on('zoomend', updateVisibleMarkers);
                    updateVisibleMarkers();
                } else {
              // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
              allBuildings.forEach(r => {
                if (!r.lat_long) return;
                const coords = r.lat_long.split(',').map(Number);
                if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                
                // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
                const recordKey = r._row_num || r.id;
                if (markersBeingMoved.has(String(recordKey))) {
                  return;
                }
                
                const m = createCircleMarker(L.latLng(coords[0], coords[1]), 'building', isEditMode, r.check);
                m._popupData = r; // ‚úÖ ‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ tempMarker
                setupMarkerPopup(m, r, 'building');
                m.addTo(surveyLayers);
              });
              
              allSigns.forEach(r => {
                if (!r.lat_long) return;
                const coords = r.lat_long.split(',').map(Number);
                if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                
                // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢
                const recordKey = r._row_num || r.id;
                if (markersBeingMoved.has(String(recordKey))) {
                  return;
                }
                
                const m = createCircleMarker(L.latLng(coords[0], coords[1]), 'sign', isEditMode, r.check);
                m._popupData = r; // ‚úÖ ‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ tempMarker
                setupMarkerPopup(m, r, 'sign');
                m.addTo(surveyLayers);
              });
            }
            
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ (‡πÅ‡∏ï‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
            tempMarkers.forEach(marker => {
              // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÉ‡∏ä‡πâ ID)
              const realMarkerExists = allBuildings.some(b => b.id === marker.data.id) || 
                                       allSigns.some(s => s.id === marker.data.id);
              
              if (!realMarkerExists) {
                // ‚úÖ ‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ï‡πà‡∏≠
                const m = createCircleMarker(marker.latlng, marker.type, isEditMode);
                m._popupData = marker.data;
                setupMarkerPopup(m, marker.data, marker.type);
                m.addTo(surveyLayers);
                console.log(`üìå ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ï‡πà‡∏≠: ${marker.data.id} (‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå)`);
              } else {
                // ‚úÖ ‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                console.log(`‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß: ${marker.data.id} (‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß)`);
              }
            });
            
            // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            updateTableCounters();
            
            // ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: return ‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Promise resolve
            return { success: true, buildings: allBuildings.length, signs: allSigns.length };

          } catch (e) {
            console.error("Error loading data:", e);
            throw e;
          }
        }

        // ============================================
        // Offline Data Storage System
        // ============================================

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
        let isOnline = navigator.onLine;
        let syncQueue = [];

        // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connection-status');
            if (!statusDiv) {
                const div = document.createElement('div');
                div.id = 'connection-status';
                div.className = 'fixed top-4 left-4 px-4 py-2 rounded-lg text-white font-bold shadow-lg z-[2000]';
                document.body.appendChild(div);
            }
            
            const status = document.getElementById('connection-status');
            if (isOnline) {
                status.textContent = '‚úì ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
                status.className = 'fixed top-4 left-4 px-4 py-2 rounded-lg text-white font-bold shadow-lg z-[2000] bg-green-500';
            } else {
                status.textContent = '‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠';
                status.className = 'fixed top-4 left-4 px-4 py-2 rounded-lg text-white font-bold shadow-lg z-[2000] bg-yellow-500';
            }
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            setTimeout(() => {
                status.style.opacity = '0';
                setTimeout(() => status.remove(), 300);
            }, 1000);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
            // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
            setTimeout(processSyncQueue, 1000);
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß
        function addToSyncQueue(action, type, data, rowKey = null) {
            const queueItem = {
                id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                timestamp: new Date().toISOString(),
                action: action, // 'add', 'update', 'delete', 'updatePosition'
                type: type,     // 'building', 'sign'
                data: data,
                rowKey: rowKey,
                status: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à', // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à, success, failed
                retryCount: 0
            };
            
            syncQueue.push(queueItem);
            saveSyncQueueToStorage();
            
            // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            showNotificationLeft(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (${syncQueue.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå)`, 'warning');
            
            return queueItem.id;
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏•‡∏á‡πÉ‡∏ô LocalStorage
        function saveSyncQueueToStorage() {
            localStorage.setItem('syncQueue', JSON.stringify(syncQueue));
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≤‡∏Å LocalStorage
        function loadSyncQueueFromStorage() {
            const saved = localStorage.getItem('syncQueue');
            if (saved) {
                syncQueue = JSON.parse(saved);
            }
        }

        // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        function removeFromSyncQueue(id) {
            syncQueue = syncQueue.filter(item => item.id !== id);
            saveSyncQueueToStorage();
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà (Retry Mechanism)
        // ============================================

        async function sendDataWithRetry(action, type, data, rowKey = null, maxRetries = 5) {
            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå ‚Üí ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            if (!isOnline || !navigator.onLine) {
                return addToSyncQueue(action, type, data, rowKey);
            }
            
            let retryCount = 0;
            
            while (retryCount < maxRetries) {
                try {
                    const body = new URLSearchParams();
                    body.append('action', action);
                    body.append('type', type);
                    
                    if (rowKey) {
                        body.append('rowKey', rowKey);
                    }
                    
                    if (data) {
                        // ‚úÖ ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏≠‡∏Å
                        const { image, fileName, ...textData } = data;
                        
                        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                        if (Object.keys(textData).length > 0) {
                            body.append('payload', JSON.stringify(textData));
                        }
                        
                        // ‚úÖ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                        if (image && fileName) {
                            body.append('image', image);
                            body.append('fileName', fileName);
                            console.log(`‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${fileName}`);
                        }
                    }
                    
                    const res = await fetch(CONFIG.SCRIPT_URL.trim(), {
                        method: 'POST',
                        body,
                        timeout: action === 'updateImage' || (data && data.image) ? 60000 : 30000
                    });
                    
                    if (res.ok) {
                        // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå 'data'
                        return { success: true, data: await res.json() };
                    } else {
                        throw new Error(`HTTP ${res.status}`);
                    }
                } catch (err) {
                    retryCount++;
                    
                    if (retryCount >= maxRetries) {
                        // ‚úÖ ‡∏´‡∏≤‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏Ñ‡∏¥‡∏ß
                        const queueId = addToSyncQueue(action, type, data, rowKey);
                        console.error(`Failed after ${maxRetries} retries. Saved to queue: ${queueId}`);
                        return { success: false, queued: true, queueId: queueId };
                    }
                    
                    const waitTime = 1000 * Math.pow(2, retryCount);
                    console.log(`Retry ${retryCount}/${maxRetries} after ${waitTime}ms...`);
                    
                    // ‡∏£‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
            }
        }

        // ============================================
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (GeoJSON)
        // ============================================
        async function checkAndLoadMap() {
            console.log('üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà GeoJSON...');
            
            // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á 3 layer
            const layerTypes = ['parcel', 'boundary', 'building'];
            
            for (const layerType of layerTypes) {
                const config = MAP_CONFIG[layerType];
                const cachedData = await getCachedMapData(layerType);
                
                if (cachedData) {
                    console.log(`‚úÖ ‡∏û‡∏ö${layerType}‡πÉ‡∏ô‡πÅ‡∏Ñ‡∏ä - ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä`);
                    try {
                        const geoJson = JSON.parse(cachedData);
                        await loadMapFromCache(geoJson, layerType);
                    } catch (err) {
                        console.error(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î${layerType}‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä:`, err);
                    }
                } else {
                    console.log(`‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö${layerType}‡πÉ‡∏ô‡πÅ‡∏Ñ‡∏ä`);
                }
            }
        }

        // ============================================
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏π‡πÄ‡∏Å‡∏¥‡πâ‡∏•‡πÑ‡∏î‡∏£‡πå‡∏ü (‡πÉ‡∏ä‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏°‡∏¥‡πà‡∏á)
        // ============================================
        async function downloadAndCacheMap() {
            try {
                showNotificationLeft('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', 'info');
                
                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                const progressIndicator = document.createElement('div');
                progressIndicator.id = 'map-download-progress';
                progressIndicator.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-[2001]';
                progressIndicator.innerHTML = '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: 0%';
                document.body.appendChild(progressIndicator);
                
                // ‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏π‡πÄ‡∏Å‡∏¥‡πâ‡∏•‡πÑ‡∏î‡∏£‡πå‡∏ü
                const fileUrl = `https://drive.google.com/uc?export=download&id=${MAP_CONFIG.googleDriveFileId.trim()}`;
                const response = await fetch(fileUrl);
                
                if (!response.ok) {
                    throw new Error('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
                }
                
                // ‚úÖ ‡∏î‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ Last-Modified (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç!)
                const lastModifiedHeader = response.headers.get('last-modified');
                const lastModified = lastModifiedHeader 
                    ? new Date(lastModifiedHeader).toISOString() 
                    : new Date().toISOString();
                
                // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå
                const contentLength = response.headers.get('content-length');
                const total = parseInt(contentLength, 10);
                let loaded = 0;
                
                // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏°‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô
                const reader = response.body.getReader();
                const chunks = [];
                
                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;
                    
                    chunks.push(value);
                    loaded += value.length;
                    
                    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                    const percent = Math.round((loaded / total) * 100);
                    progressIndicator.innerHTML = `‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ${percent}%`;
                    
                    // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏∏‡∏Å 10 ‡∏ä‡∏¥‡πâ‡∏ô (‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏Ç‡∏ô‡∏≤‡∏î 5MB)
                    if (chunks.length >= 10 || loaded >= 5 * 1024 * 1024) {
                        await saveChunksToDB(chunks);
                        chunks.length = 0; // ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß
                    }
                }
                
                // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà
                if (chunks.length > 0) {
                    await saveChunksToDB(chunks);
                }
                
                // ‚úÖ ‡∏£‡∏ß‡∏°‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                console.log('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô...');
                const arrayBuffer = await assembleChunks(MAP_CONFIG.fileName);
                
                // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÅ‡∏Ñ‡∏ä (‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡∏£‡πå‡∏ü!)
                await cacheMapData(arrayBuffer, lastModified);
                
                // ‚úÖ ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                progressIndicator.remove();
                
                console.log(`‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(lastModified).toLocaleString('th-TH')})`);
                showNotificationLeft('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                
                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                loadMapFromCache(arrayBuffer);
                
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà:', err);
                showNotificationLeft('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
                
                // ‚úÖ ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤
                const progressIndicator = document.getElementById('map-download-progress');
                if (progressIndicator) progressIndicator.remove();
                
                // ‚úÖ ‡∏•‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
                try {
                    const db = await openMapDatabase();
                    const transaction = db.transaction(['mapChunks'], 'readwrite');
                    const store = transaction.objectStore('mapChunks');
                    const request = store.index('fileName').openCursor(IDBKeyRange.only(MAP_CONFIG.fileName));
                    
                    request.onsuccess = (event) => {
                        const cursor = event.target.result;
                        if (cursor) {
                            store.delete(cursor.key);
                            cursor.continue();
                        }
                    };
                    
                    db.close();
                } catch (cleanupErr) {
                    console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ:', cleanupErr);
                }
            }
        }


        // ============================================
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÅ‡∏Ñ‡∏ä (IndexedDB)
        // ============================================
        async function cacheMapData(data, lastModified, layerType = 'all') {
            try {
                const db = await openMapDatabase();
                const transaction = db.transaction(['maps'], 'readwrite');
                const store = transaction.objectStore('maps');
                
                const cacheKey = layerType === 'all' ? 'parcel_geojson' : `${layerType}_geojson`;
                
                await store.put({
                    id: cacheKey,
                    data: data,
                    lastModified: lastModified,
                    layerType: layerType
                });
                
                localStorage.setItem(`${cacheKey}_last_modified`, lastModified);
                db.close();
                
                console.log(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å${layerType === 'all' ? '' : ' ' + layerType}‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏Ñ‡∏ä:', err);
                throw err;
            }
        }

        // ============================================
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏°‡∏¥‡πà‡∏á)
        // ============================================
        async function saveChunksToDB(chunks) {
            if (chunks.length === 0) return;
            
            try {
                const db = await openMapDatabase();
                const transaction = db.transaction(['mapChunks'], 'readwrite');
                const store = transaction.objectStore('mapChunks');
                
                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô
                for (let i = 0; i < chunks.length; i++) {
                    await store.put({
                        id: `${MAP_CONFIG.fileName}_chunk_${Date.now()}_${i}`,
                        fileName: MAP_CONFIG.fileName,
                        chunkData: chunks[i],
                        chunkIndex: i,
                        timestamp: new Date().toISOString()
                    });
                }
                
                db.close();
                console.log(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ${chunks.length} ‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`);
                
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô:', err);
                throw err;
            }
        }

        // ============================================
        // ‡∏£‡∏ß‡∏°‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
        // ============================================
        async function assembleChunks(fileName) {
            try {
                const db = await openMapDatabase();
                const transaction = db.transaction(['mapChunks'], 'readonly');
                const store = transaction.objectStore('mapChunks');
                
                // ‡∏î‡∏∂‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ
                const request = store.index('fileName').getAll(fileName);
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = async (event) => {
                        const chunks = event.target.result;
                        
                        if (chunks.length === 0) {
                            db.close();
                            reject(new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'));
                            return;
                        }
                        
                        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏î‡∏±‡∏ä‡∏ô‡∏µ
                        chunks.sort((a, b) => a.chunkIndex - b.chunkIndex);
                        
                        // ‡∏£‡∏ß‡∏°‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                        const allData = chunks.map(chunk => chunk.chunkData);
                        const blob = new Blob(allData);
                        const arrayBuffer = await blob.arrayBuffer();
                        
                        // ‡∏•‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡πÅ‡∏•‡πâ‡∏ß
                        const deleteTransaction = db.transaction(['mapChunks'], 'readwrite');
                        const deleteStore = deleteTransaction.objectStore('mapChunks');
                        
                        for (const chunk of chunks) {
                            deleteStore.delete(chunk.id);
                        }
                        
                        db.close();
                        resolve(arrayBuffer);
                    };
                    
                    request.onerror = (event) => {
                        db.close();
                        reject(event.target.error);
                    };
                });
                
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô:', err);
                throw err;
            }
        }

        // ============================================
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä
        // ============================================
        async function getCachedMapData(layerType = 'all') {
            try {
                const db = await openMapDatabase();
                const transaction = db.transaction(['maps'], 'readonly');
                const store = transaction.objectStore('maps');
                
                const cacheKey = layerType === 'all' ? 'parcel_geojson' : `${layerType}_geojson`;
                const request = store.get(cacheKey);
                
                return new Promise((resolve, reject) => {
                    request.onsuccess = (event) => {
                        db.close();
                        resolve(event.target.result ? event.target.result.data : null);
                    };
                    request.onerror = (event) => {
                        db.close();
                        reject(event.target.error);
                    };
                });
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏Ñ‡∏ä:', err);
                return null;
            }
        }

        // ============================================
        // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IndexedDB ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        // ============================================
        function openMapDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('MapCacheDB', 3); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô 3
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á store ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
                    if (!db.objectStoreNames.contains('maps')) {
                        const mapStore = db.createObjectStore('maps', { keyPath: 'id' });
                        mapStore.createIndex('lastModified', 'lastModified', { unique: false });
                    }
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á store ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô (‡πÉ‡∏´‡∏°‡πà!)
                    if (!db.objectStoreNames.contains('mapChunks')) {
                        const chunkStore = db.createObjectStore('mapChunks', { keyPath: 'id' });
                        chunkStore.createIndex('fileName', 'fileName', { unique: false });
                        chunkStore.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // ============================================
        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡∏ä (GeoJSON) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‚úÖ
        // ============================================
        async function loadMapFromCache(geoJsonData, layerType = 'all') {
            try {
                console.log('üó∫Ô∏è Loading GeoJSON from cache, layerType:', layerType);
                
                if (!geoJsonData) throw new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà');
                
                let geoJson = typeof geoJsonData === 'string' ? JSON.parse(geoJsonData) : geoJsonData;
                
                if (!geoJson.type || geoJson.type !== 'FeatureCollection') {
                    throw new Error('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà GeoJSON ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }
                
                if (!geoJson.features || !Array.isArray(geoJson.features)) {
                    console.warn('‚ö†Ô∏è GeoJSON ‡πÑ‡∏°‡πà‡∏°‡∏µ features');
                    geoJson.features = [];
                }
                
                console.log(`üìä Total features: ${geoJson.features.length}`);
                
                // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ 1: ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß (boundary.geojson, building.geojson, parcel.geojson)
                // ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° properties
                if (layerType !== 'all') {
                    displayGeoJSONLayer(geoJson, layerType);
                    console.log(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå ${layerType}: ${geoJson.features.length} features`);
                } 
                // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ 2: ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏™‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå (layerType === 'all')
                // ‚Üí ‡∏Å‡∏£‡∏≠‡∏á‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ï‡∏≤‡∏° properties.layer ‡∏´‡∏£‡∏∑‡∏≠ properties.type
                else {
                    ['parcel', 'boundary', 'building'].forEach(targetLayer => {
                        const layerFeatures = geoJson.features.filter(f => {
                            const fLayer = f.properties?.layer || f.properties?.type;
                            // ‚úÖ ‡πÅ‡∏Å‡πâ: ‡∏•‡∏ö !fLayer ‡∏≠‡∏≠‡∏Å ‚Üí ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ layer ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
                            return fLayer === targetLayer;
                        });
                        
                        console.log(`üîç ${targetLayer}: filtered ${layerFeatures.length} features`);
                        
                        if (layerFeatures.length > 0) {
                            const layerGeoJson = {
                                type: 'FeatureCollection',
                                features: layerFeatures
                            };
                            displayGeoJSONLayer(layerGeoJson, targetLayer);
                        }
                    });
                }
                
                console.log('‚úÖ Map loaded successfully');
                showNotificationLeft('‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (err) {
                console.error('‚ùå Error loading map:', err);
                showNotificationLeft('‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
            }
        }


        // ============================================
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô GeoJSON
        // ============================================
        function convertToGeoJSON(features, layerName) {
            const geoJson = {
                type: 'FeatureCollection',
                features: features.map((feature) => {
                    return {
                        type: 'Feature',
                        geometry: feature.geometry,
                        properties: feature.attributes
                    };
                })
            };
            
            return geoJson;
        }

        // ============================================
        // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Polygon) - GeoJSON
        // ============================================
        function getMapLayerStyle(feature, layerName) {
            console.log('üé® Styling:', layerName, 'feature:', feature.properties?.parcel_cod || feature.properties?.boundaryor || feature.properties?.building_c);
            
            // ‚úÖ Boundary Layer - ‡πÄ‡∏™‡πâ‡∏ô‡∏î‡∏≥ ‡∏û‡∏∑‡πâ‡∏ô‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
            if (layerName === 'boundary') {
                return {
                    color: '#000000',
                    weight: 3,
                    opacity: 1.0,
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    interactive: false
                };
            }
            
            // ‚úÖ Building Layer - ‡∏™‡∏µ‡∏™‡πâ‡∏°
            if (layerName === 'building') {
                return {
                    color: '#2A3439',
                    weight: 1,
                    opacity: 1.0,
                    fillColor: '#fdba74',
                    fillOpacity: 0.5,
                    interactive: false
                };
            }
            
            // ‚úÖ Parcel Layer (default) - ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏î‡∏á ‡∏û‡∏∑‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß
            return {
                color: '#ef4444',
                weight: 2,
                opacity: 1.0,
                fillColor: '#ffffff',
                fillOpacity: 0.05,
                interactive: true
            };
        }

        // ============================================
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå GeoJSON ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà   function displayGeoJSONLayer(geoJson, layerName) {
        // function displayParcelLayer(geoJson) { ============================================
        function displayGeoJSONLayer(geoJson, layerName) {
            console.log('üì¶ Displaying layer:', layerName, 'features:', geoJson.features?.length || 0);
            
            const layer = L.geoJSON(geoJson, {
                // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: Wrap ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á layerName ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢!
                style: function(feature) {
                    return getMapLayerStyle(feature, layerName);
                },
                // ‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ interactive ‡∏ï‡∏≤‡∏° layerName
                interactive: layerName === 'parcel',
                onEachFeature: function(feature, polygonLayer) {
                    // ‚úÖ Popup ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ parcel layer
                    if (layerName === 'parcel') {
                        const props = feature.properties || {};
                        const parcelCod = props.parcel_cod;

                        // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ: ‡πÄ‡∏Å‡πá‡∏ö layerName ‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ resetHighlight ‡πÉ‡∏ä‡πâ
                        polygonLayer.layerName = layerName;
           
                        polygonLayer.on({
                            mouseover: highlightFeature,
                           mouseout: resetHighlight,
                            click: function(e) {
                                if (mouseAddMode) return;
                                L.DomEvent.stopPropagation(e);
                                
                                const popupContent = `
        <div class="popup-simple" onclick="event.stopPropagation()">
            <div class="popup-header" onclick="showRawParcelData('${encodeURIComponent(JSON.stringify(props))}', ${e.latlng.lat}, ${e.latlng.lng})">
                <span class="parcel-cod">${parcelCod || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'}</span>
            </div>
            <div class="popup-owner">${props.title || ''} ${props.fname || ''} ${props.lname || ''}</div>
        </div>`;
                                
                                L.popup({ minWidth: 160, maxWidth: 220, className: 'mobile-popup' })
                                    .setLatLng(e.latlng)
                                    .setContent(popupContent)
                                    .openOn(map);
                            }
                        });
                    }
                    // ‚úÖ boundary ‡πÅ‡∏•‡∏∞ building: ‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å event ‡πÉ‡∏î‡πÜ
                }
            });
            
            layer.addTo(map);
            console.log('‚úÖ Layer added to map:', layerName);
            return layer;
        }


        // ============================================
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå Boundary ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß‡∏•‡πâ‡∏≠‡∏°‡∏î‡∏≥ (Minimal)
        // ============================================
        function displayBoundaryLayer(geoJson) {
            // ‚úÖ ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1: ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≤‡∏ß‡∏´‡∏ô‡∏≤ (Buffer)
            const white = L.geoJSON(geoJson, {
                style: {
                    color: '#ffff00',  // üî∂ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏î (‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏Å‡∏ß‡πà‡∏≤‡∏Ç‡∏≤‡∏ß)
                    weight: 10,         // ‡∏´‡∏ô‡∏≤ 10px
                    opacity: 1,
                    fill: false
                }
            }).addTo(map);
            
            // ‚úÖ ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏™‡πâ‡∏ô‡∏î‡∏≥‡∏ö‡∏≤‡∏á (‡πÄ‡∏™‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á)
            const black = L.geoJSON(geoJson, {
                style: {
                    color: '#000000',  // ‚ö´ ‡∏î‡∏≥
                    weight: 2,
                    opacity: 1,
                    fill: false
                }
            }).addTo(map);
            
            // ‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô LayerGroup
            return L.layerGroup([white, black]);
        }

        // ============================================
        // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå Building (‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
        // ============================================
        function displayBuildingLayer(geoJson) {
            const layer = L.geoJSON(geoJson, {
                style: function(feature) {
                    return getMapLayerStyle(feature, 'building');
                }
                // ‚úÖ ‡πÑ‡∏°‡πà‡∏ú‡∏π‡∏Å event ‡πÉ‡∏î‡πÜ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö building
            });
            layer.addTo(map);
            return layer;
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ç‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á
        // ============================================
        function showRawParcelData(props, lat, lng) {
            // ‚úÖ ‡∏õ‡∏¥‡∏î popup ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
            map.closePopup();

            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (key: value) ‡πÑ‡∏°‡πà‡πÅ‡∏õ‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
            const rawRows = Object.entries(props || {})
                .filter(([key, value]) => value !== null && value !== undefined && value !== '')
                .map(([key, value]) => {
                    return `<tr class="border-b border-gray-100 last:border-0 hover:bg-gray-50">
                        <td class="py-1.5 px-2 font-mono text-[10px] text-gray-500 align-top whitespace-nowrap">${key}:</td>
                        <td class="py-1.5 px-2 text-[11px] text-gray-800 break-all">${value}</td>
                    </tr>`;
                }).join('');
            
            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á popup ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
            const rawPopup = L.popup({ maxWidth: 450, minWidth: 300, className: 'raw-data-popup' })
                .setLatLng(L.latLng(lat, lng))
                .setContent(`
                    <div class="raw-popup-content min-w-[280px] max-w-[450px] max-h-[70vh] overflow-y-auto bg-white rounded-lg shadow-lg">
                        <div class="font-bold text-sm text-center border-b pb-2 mb-2 text-blue-700 sticky top-0 bg-white z-10">
                            ${props.parcel_cod || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'} - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                        </div>
                        <table class="w-full text-[11px]">
                            ${rawRows || '<tr><td colspan="2" class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'}
                        </table>
                        <div class="text-[10px] text-gray-400 text-center mt-3 pt-2 border-t">
                            ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å popup ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î
                        </div>
                    </div>
                `)
                .openOn(map);
            
            console.log('üìã ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö:', props.parcel_cod);
        }

        // ============================================
        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        // ============================================
        function getLayerStyle(layerName) {
            switch (layerName) {
                case 'parcel':
                    return {
                        color: '#2563eb',
                        weight: 2,
                        fillOpacity: 0.1,
                        fillColor: '#2563eb'
                    };
                case 'boundary':
                    return {
                        color: '#dc2626',
                        weight: 3,
                        fillOpacity: 0,
                        dashArray: '5, 5'
                    };
                case 'building':
                    return {
                        color: '#16a34a',
                        weight: 1,
                        fillOpacity: 0.3,
                        fillColor: '#22c55e'
                    };
                default:
                    return {
                        color: '#6b7280',
                        weight: 1,
                        fillOpacity: 0.1
                    };
            }
        }

        // ============================================
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå
        // ============================================
        function onEachFeature(feature, layer) {
            if (feature.properties) {
                // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
                layer.bindPopup(`
                    <div class="map-popup">
                        <h3>${feature.properties.name || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</h3>
                        <table class="popup-table">
                            ${Object.entries(feature.properties)
                                .map(([key, value]) => 
                                    `<tr><td><strong>${key}:</strong></td><td>${value}</td></tr>`
                                )
                                .join('')}
                        </table>
                    </div>
                `);
            }
        }

        // ============================================
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        // ============================================
        window.addEventListener('load', () => {
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
            checkAndLoadMap();            

        });

        // ============================================
        // Enhanced Sync Process with Image Support
        // ============================================

        let isProcessingQueue = false; // ‚úÖ ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏Ñ‡∏•‡πÄ‡∏≠‡∏ô‡∏ï‡πå

        async function processSyncQueue() {
          // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•
          if (isProcessingQueue || !navigator.onLine || syncQueue.length === 0) {
            console.log('‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå: ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
            return;
          }
          
          isProcessingQueue = true; // ‚úÖ ‡∏•‡πá‡∏≠‡∏Å
          
          try {
            console.log(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (${syncQueue.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)...`);
            const failedItems = [];
            
            for (let item of syncQueue) {
              if (item.status === 'success') continue;
              
              try {
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ id ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const duplicateItems = syncQueue.filter(i => 
                  i.id === item.id && i.status === 'success'
                );
                
                if (duplicateItems.length > 0) {
                  console.log(`‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥: ${item.id} (‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß)`);
                  item.status = 'success';
                  removeFromSyncQueue(item.id);
                  continue;
                }
                
                const result = await sendDataWithRetry(
                  item.action,
                  item.type,
                  item.data,
                  item.rowKey,
                  3
                );
                
                if (result.success) {
                  item.status = 'success';
                  removeFromSyncQueue(item.id);
                  console.log(`‚úÖ Synced: ${item.id}`);
                } else {
                  item.retryCount++;
                  if (item.retryCount >= 5) {
                    item.status = 'failed';
                    failedItems.push(item);
                  }
                }
              } catch (err) {
                item.retryCount++;
                console.error(`‚ùå Error syncing ${item.id}:`, err);
                if (item.retryCount >= 5) {
                  item.status = 'failed';
                  failedItems.push(item);
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á
            await syncPendingImages();
            saveSyncQueueToStorage();
            
          } catch (err) {
            console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå:', err);
          } finally {
            isProcessingQueue = false; // ‚úÖ ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å
          }
        }


        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
        loadSyncQueueFromStorage();

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ü‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á
        // ‡πÉ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô toggleSettingsMenu ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà:

        /*
        <button onclick="checkSyncStatus()" class="map-btn p-3 w-48 bg-gradient-to-r from-gray-400 to-gray-600 text-white hover:scale-105 transition-all shadow-lg flex items-center justify-start gap-2 text-left">
            <i data-lucide="sync" class="w-5 h-5"></i>
            <span class="text-xs font-bold">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå</span>
        </button>
        */

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        function checkSyncStatus() {
            closeSettingsMenu();
            
            const ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à = syncQueue.filter(i => i.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à').length;
            const failed = syncQueue.filter(i => i.status === 'failed').length;
            const success = syncQueue.filter(i => i.status === 'success').length;
            
            let message = `üìä ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:\n`;
            message += `‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${success} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
            message += `‚è≥ ‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå: ${‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n`;
            message += `‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${failed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            
            if (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à > 0) {
                message += `\n\n‚ö†Ô∏è ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå!`;
            }
            
            alert(message);
            
            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÄ‡∏•‡∏¢‡πÑ‡∏´‡∏°
            if (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à > 0 && isOnline) {
                if (confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                    processSyncQueue();
                }
            }
        }

        // ============================================
        // Auto-check and sync on app startup
        // ============================================

        async function checkAndSyncOnStartup() {
            console.log('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...');
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏¥‡∏ß‡∏à‡∏≤‡∏Å localStorage
            loadSyncQueueFromStorage();
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå
            try {
                const unsyncedImages = await getUnsyncedImages();
                const ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏àCount = syncQueue.filter(i => i.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à').length;
                
                if (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏àCount > 0 || unsyncedImages.length > 0) {
                    const totalPending = ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏àCount + unsyncedImages.length;
                    
                    showNotificationLeft(
                        `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå ${totalPending} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 
                        'warning'
                    );
                    
                    // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                    if (isOnline) {
                        setTimeout(() => {
                            showNotificationLeft('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info');
                            processSyncQueue();
                        }, 1000);
                    } else {
                        showNotificationLeft('‚ö†Ô∏è ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'warning');
                    }
                }
            } catch (err) {
                console.error('Error checking ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à data:', err);
            }
        }

        // ============================================
        // window.addEventListener
        // ============================================

        // ============================================
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏≠‡∏õ (‡∏£‡∏ß‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á 2 ‡∏™‡πà‡∏ß‡∏ô)
        // ============================================
        window.addEventListener('load', async () => {
            // 1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°)
            initMap();
            lucide.createIcons();
            
            // ‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏≤‡∏™‡πå
            initMouseAddMode();
            console.log('‚úÖ initMouseAddMode called on load');

            // 2. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°)
            loadExistingData();
            
            // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
            await loadExistingData(); // ‚Üê ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à
            startRealtimeAutoUpdate();
            
            // 4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
            await checkAndSyncOnStartup();
            
            // 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∏‡∏î‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå
            setInterval(() => {
                updateSyncBadge();
            }, 1000);            
           
            // 7. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker
            if ('serviceWorker' in navigator && window.location.protocol !== 'file:') {
                navigator.serviceWorker.register('/sw.js')
                    .then(() => console.log('Service Worker registered'))
                    .catch(err => console.error('Service Worker registration failed:', err));
            } else {
                console.warn('‚ö†Ô∏è Service Worker ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ö‡∏ô file:// protocol');
            }
        });

        // ============================================
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)
        // ============================================
        window.addEventListener('online', () => {
            isOnline = true;
            updateConnectionStatus();
            setTimeout(() => {
                if (!isProcessingQueue && navigator.onLine) {
                    console.log('‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå ‚Üí ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                    processSyncQueue();
                }
            }, 2000);
        });

        // ============================================
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå (‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥)
        // ============================================
        window.addEventListener('offline', () => {
            isOnline = false;
            updateConnectionStatus();
        });

        // ============================================
        // window.addEventListener
        // ============================================

        // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ü‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡∏≠‡∏á
        function updateSyncBadge() {
            const ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à = syncQueue.filter(i => i.status === '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à').length;
            const badge = document.getElementById('settings-badge');
            
            if (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à > 0) {
                badge.textContent = ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à > 9 ? '9+' : ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏à;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏¥‡∏ß
        setInterval(updateSyncBadge, 1000);

        // ============================================
        // IndexedDB Storage for Images
        // ============================================

        let dbPromise = null;

        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏™‡∏£‡πâ‡∏≤‡∏á IndexedDB
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SurveyAppDB', 2);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Store ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    if (!db.objectStoreNames.contains('images')) {
                        const imageStore = db.createObjectStore('images', { 
                            keyPath: 'id' 
                        });
                        imageStore.createIndex('timestamp', 'timestamp');
                        imageStore.createIndex('synced', 'synced');
                    }
                    
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Store ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏¥‡∏á‡∏Ñ‡πå
                    if (!db.objectStoreNames.contains('syncQueue')) {
                        const queueStore = db.createObjectStore('syncQueue', { 
                            keyPath: 'id' 
                        });
                        queueStore.createIndex('status', 'status');
                        queueStore.createIndex('timestamp', 'timestamp');
                    }
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡∏á‡πÉ‡∏ô IndexedDB (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)
        async function saveImageToDB(imageData, filename, relatedId, type) {
            try {
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                const estimateSize = Math.ceil(imageData.length * 0.75); // ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏£‡∏¥‡∏á (‡∏•‡∏ö 25% ‡∏à‡∏≤‡∏Å base64)
                
                if (estimateSize > 50 * 1024 * 1024) { // ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô 50MB
                    showNotificationLeft('‚ö†Ô∏è ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å', 'warning');
                }
                
                const db = await openDatabase();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction('images', 'readwrite');
                    const store = transaction.objectStore('images');
                    
                    const imageRecord = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        filename: filename,
                         imageData, // base64 string
                        relatedId: relatedId,
                        type: type, // 'building' ‡∏´‡∏£‡∏∑‡∏≠ 'sign'
                        timestamp: new Date().toISOString(),
                        synced: false,
                        retryCount: 0
                    };
                    
                    const request = store.add(imageRecord);
                    
                    request.onsuccess = () => {
                        console.log(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${filename} (${Math.round(estimateSize / 1024)} KB)`);
                        resolve(imageRecord.id);
                    };
                    
                    request.onerror = (event) => {
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ï‡πá‡∏°
                        if (event.target.error && event.target.error.name === 'QuotaExceededError') {
                            showNotificationLeft(
                                '‚ùå ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ï‡πá‡∏°! ‡πÇ‡∏õ‡∏£‡∏î‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏°',
                                'error'
                            );
                            reject(new Error('Storage quota exceeded'));
                        } else {
                            console.error('Error saving image to DB:', event.target.error);
                            reject(event.target.error);
                        }
                    };
                });
            } catch (err) {
                console.error('Error in saveImageToDB:', err);
                throw err;
            }
        }

        async function checkStorageSpace() {
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const usage = estimate.usage || 0;
                    const quota = estimate.quota || 50 * 1024 * 1024; // 50MB default
                    
                    const usagePercent = (usage / quota) * 100;
                    
                    if (usagePercent > 80) {
                        showNotificationLeft(
                            `‚ö†Ô∏è ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢ (${Math.round(100 - usagePercent)}%)`,
                            'warning'
                        );
                    }
                    
                    if (usagePercent > 95) {
                        showNotificationLeft(
                            `‚ùå ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡πÄ‡∏ï‡πá‡∏°! ‡πÇ‡∏õ‡∏£‡∏î‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•`,
                            'error'
                        );
                    }
                }
            } catch (err) {
                console.error('Error checking storage:', err);
            }
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏±‡∏ä‡∏ô‡∏µ boolean)
        // ============================================
        async function getUnsyncedImages() {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction('images', 'readonly');
                const store = transaction.objectStore('images');
                const request = store.openCursor(); // ‚úÖ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏±‡∏ä‡∏ô‡∏µ
                const unsyncedImages = [];
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const image = cursor.value;
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                        if (!image.synced || image.synced === false) {
                            unsyncedImages.push(image);
                        }
                        cursor.continue();
                    } else {
                        resolve(unsyncedImages);
                    }
                };
                
                request.onerror = (event) => {
                    console.error('Error getting unsynced images:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß - ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå)
        // ============================================
        async function syncPendingImages() {
            try {
                const unsyncedImages = await getUnsyncedImages();
                if (unsyncedImages.length === 0) {
                    console.log('‚ÑπÔ∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå');
                    return;
                }
                
                showNotificationLeft(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (${unsyncedImages.length} ‡∏£‡∏π‡∏õ)...`, 'info');
                console.log(`üì§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (${unsyncedImages.length} ‡∏£‡∏π‡∏õ)`);
                
                let successCount = 0;
                
                for (const image of unsyncedImages) {
                    try {
                        console.log(`üì§ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ${image.filename} (${image.relatedId})`);
                        
                        // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô IndexedDB (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏¢‡∏Å‡∏≠‡∏µ‡∏Å)
                        const payload = {};
                        
                        const body = new URLSearchParams();
                        body.append('action', 'update');
                        body.append('type', image.type);
                        body.append('rowKey', image.relatedId);
                        body.append('payload', JSON.stringify(payload));
                        body.append('image', image.imageData);
                        body.append('fileName', image.filename); // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
                        
                        const res = await fetch(CONFIG.SCRIPT_URL.trim(), {
                            method: 'POST',
                            body,
                            timeout: 60000
                        });
                        
                        let result = null;
                        try {
                            result = await res.json();
                        } catch (parseErr) {
                            console.error(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå:`, parseErr);
                        }
                        
                        if (res.ok && result && (result.success === true || result.status === 200)) {
                            await markImageAsSynced(image.id);
                            successCount++;
                            console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${image.filename}`);
                            showNotificationLeft(`‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ${image.filename} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
                        } else {
                            const errorMsg = result?.error || result?.message || `HTTP ${res.status}`;
                            console.error(`‚ùå ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${image.filename} - ${errorMsg}`);
                            
                            image.retryCount = (image.retryCount || 0) + 1;
                            if (image.retryCount >= 5) {
                                console.error(`‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏•‡∏±‡∏á‡∏•‡∏≠‡∏á ${image.retryCount} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${image.filename}`);
                            }
                            
                            showNotificationLeft(`‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${image.filename}`, 'error');
                        }
                    } catch (err) {
                        console.error(`‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ${image.filename}:`, err);
                        image.retryCount = (image.retryCount || 0) + 1;
                        showNotificationLeft(`‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${image.filename}`, 'error');
                    }
                    
                    // ‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡πà‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏π‡∏õ
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                // ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
                await cleanupSyncedImages();
                
                if (successCount > 0) {
                    console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${successCount}/${unsyncedImages.length} ‡∏£‡∏π‡∏õ`);
                }
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:', err);
                showNotificationLeft('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û', 'error');
            }
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß - ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏±‡∏ä‡∏ô‡∏µ)
        // ============================================
        async function cleanupSyncedImages() {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction('images', 'readwrite');
                const store = transaction.objectStore('images');
                const request = store.openCursor(); // ‚úÖ ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏î‡∏±‡∏ä‡∏ô‡∏µ
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const image = cursor.value;
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                        if (image.synced === true) {
                            store.delete(cursor.primaryKey);
                        }
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                
                request.onerror = (event) => {
                    console.error('Error cleaning up synced images:', event.target.error);
                    reject(event.target.error);
                };
            });
        }


        // ‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        async function markImageAsSynced(imageId) {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction('images', 'readwrite');
                const store = transaction.objectStore('images');
                
                const request = store.get(imageId);
                
                request.onsuccess = (event) => {
                    const image = event.target.result;
                    if (image) {
                        image.synced = true;
                        const updateRequest = store.put(image);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = () => reject(updateRequest.error);
                    } else {
                        reject(new Error('Image not found'));
                    }
                };
                
                request.onerror = () => {
                    reject(request.error);
                };
            });
        }

        // ‡∏•‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        async function cleanupSyncedImages() {
            const db = await openDatabase();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction('images', 'readwrite');
                const store = transaction.objectStore('images');
                
                // ‚úÖ ‡πÉ‡∏ä‡πâ openCursor ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏î‡∏±‡∏ä‡∏ô‡∏µ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ IDBKeyRange)
                const request = store.openCursor();
                
                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const image = cursor.value;
                        // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á
                        if (image.synced === true) {
                            store.delete(cursor.primaryKey);
                        }
                        cursor.continue();
                    } else {
                        resolve();
                    }
                };
                
                request.onerror = (event) => {
                    console.error('Error cleaning up synced images:', event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
        function showNotificationLeft(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-4 z-[9999] px-4 py-3 rounded-lg shadow-lg text-white font-medium transform transition-all duration-300 translate-x-[-150%] ${
                type === 'success' ? 'bg-green-600' :
                type === 'error' ? 'bg-red-600' :
                type === 'warning' ? 'bg-yellow-600' :
                'bg-blue-600'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i data-lucide="${
                        type === 'success' ? 'check-circle' :
                        type === 'error' ? 'alert-circle' :
                        type === 'warning' ? 'alert-triangle' :
                        'info'
                    }" class="w-5 h-5"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            lucide.createIcons();
            
            void notification.offsetWidth;
            notification.classList.remove('translate-x-[-150%]');
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const isUpdateNotification = message.includes('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï') || 
                                          message.includes('‡πÄ‡∏û‡∏¥‡πà‡∏°') || 
                                          message.includes('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç') || 
                                          message.includes('‡∏•‡∏ö') ||
                                          message.includes('‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á');
            
            // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ç‡πâ‡∏≤‡∏° cooldown)
            if (isUpdateNotification && type !== 'error') {
                setTimeout(() => {
                    const refreshBtn = document.getElementById('btn-refresh');
                    if (refreshBtn && !refreshBtn.disabled) {
                        triggerAutoRefresh(true);  // ‚úÖ ‡∏™‡πà‡∏á true ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏° cooldown
                    }
                }, 500);
            }
            
            setTimeout(() => {
                notification.classList.add('translate-x-[-150%]');
                setTimeout(() => {
                    if (notification && notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 3000);
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Helper: ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        function triggerAutoRefresh(bypassCooldown = false) {
            const refreshBtn = document.getElementById('btn-refresh');
            
            // ‚úÖ 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (isRefreshing) {
                console.log('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥');
                return;
            }
            
            // ‚úÖ 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ cooldown (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏Ç‡πâ‡∏≤‡∏°)
            if (!bypassCooldown) {
                const now = Date.now();
                if (now - lastAutoRefreshTime < AUTO_REFRESH_COOLDOWN) {
                    const remaining = Math.ceil((AUTO_REFRESH_COOLDOWN - (now - lastAutoRefreshTime)) / 1000);
                    console.log(`‚è≥ Cooldown: ‡∏£‡∏≠‡∏≠‡∏µ‡∏Å ${remaining} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`);
                    return;  // ‚úÖ ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö 30 ‡∏ß‡∏¥
                }
            }
            
            // ‚úÖ 3. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î
            lastAutoRefreshTime = Date.now();  // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
            
            if (refreshBtn && !refreshBtn.disabled) {
                setTimeout(() => {
                    refreshBtn.click();
                }, 300);
            }
        }


        // ============================================
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        // ============================================
        async function realtimeUpdate() {
            if (!navigator.onLine || isUpdating) return;
            
            isUpdating = true;
            try {
                const res = await fetch(`${CONFIG.SCRIPT_URL}?action=getData&t=${Date.now()}`);
                const newData = await res.json();
                
                // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö timestamp ‡∏≠‡∏≠‡∏Å (‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤)
                if (!newData.buildings || !newData.signs) { // ‚Üê ‡∏•‡∏ö newData.timestamp ||
                    console.warn('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
                    return;
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                const buildingChanges = detectChanges(allBuildings, newData.buildings);
                const signChanges = detectChanges(allSigns, newData.signs);
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏£‡∏≤‡∏á
                if (buildingChanges.total > 0) {
                    applyChanges(buildingChanges, 'building');
                    showUpdateNotification(buildingChanges, '‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á');
                }
                
                if (signChanges.total > 0) {
                    applyChanges(signChanges, 'sign');
                    showUpdateNotification(signChanges, '‡∏õ‡πâ‡∏≤‡∏¢');
                }
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏Ñ‡∏ä
                allBuildings = newData.buildings;
                allSigns = newData.signs;
                
                console.log('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:', err);
            } finally {
                isUpdating = false;
            }
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        function detectChanges(oldData, newData) {
            const oldMap = new Map(oldData.map(item => [item.id || item._row_num, item]));
            const newMap = new Map(newData.map(item => [item.id || item._row_num, item]));
            
            const added = [];
            const updated = [];
            const deleted = [];
            
            // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
            newData.forEach(item => {
                const id = item.id || item._row_num;
                if (!oldMap.has(id)) added.push(item);
            });
            
            // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï
            newData.forEach(item => {
                const id = item.id || item._row_num;
                const oldItem = oldMap.get(id);
                if (oldItem && JSON.stringify(oldItem) !== JSON.stringify(item)) {
                    updated.push(item);
                }
            });
            
            // ‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
            oldData.forEach(item => {
                const id = item.id || item._row_num;
                if (!newMap.has(id)) deleted.push(item);
            });
            
            return { 
                added, 
                updated, 
                deleted,
                total: added.length + updated.length + deleted.length
            };
        }

        // ‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        function applyChanges(changes, type) {
            // ‡∏•‡∏ö‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
            changes.deleted.forEach(item => {
                surveyLayers.eachLayer(layer => {
                    if (layer._popupData && 
                        (layer._popupData.id === item.id || layer._popupData._row_num === item._row_num)) {
                        surveyLayers.removeLayer(layer);
                    }
                });
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
            [...changes.added, ...changes.updated].forEach(item => {
                if (!item.lat_long) return;
                
                const coords = item.lat_long.split(',').map(Number);
                if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
                let existingMarker = null;
                surveyLayers.eachLayer(layer => {
                    if (layer._popupData && 
                        (layer._popupData.id === item.id || layer._popupData._row_num === item._row_num)) {
                        existingMarker = layer;
                    }
                });
                
                if (existingMarker) {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
                    existingMarker.setLatLng(L.latLng(coords[0], coords[1]));
                    existingMarker._popupData = item;
                    setupMarkerPopup(existingMarker, item, type);
                } else {
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
                    const marker = createCircleMarker(L.latLng(coords[0], coords[1]), type, isEditMode);
                    marker._popupData = item;
                    setupMarkerPopup(marker, item, type);
                    marker.addTo(surveyLayers);
                    if (isEditMode) enableMarkerDragging(marker, item);
                }
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            if (type === 'building') renderBuildingTable();
            else renderSignTable();
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        function showUpdateNotification(changes, typeName) {
            if (changes.total === 0) return;
            
            let message = `üîÑ ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï${typeName} `;
            const parts = [];
            if (changes.added.length > 0) parts.push(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${changes.added.length}`);
            if (changes.updated.length > 0) parts.push(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${changes.updated.length}`);
            if (changes.deleted.length > 0) parts.push(`‡∏•‡∏ö ${changes.deleted.length}`);
            
            message += parts.join(', ');
            showNotificationLeft(message, 'info');
        }

        // ============================================
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        // ============================================
        function startRealtimeAutoUpdate() {
            if (autoUpdateInterval) clearInterval(autoUpdateInterval);
            
            autoUpdateInterval = setInterval(() => {
                if (!isUpdating && navigator.onLine) {
                    realtimeUpdate();
                }
            }, 10000); // 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            
            console.log('‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ');
        }

        // ============================================
        // ‡∏Ç‡πâ‡∏≠ 1.1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏Å‡∏ß‡πâ‡∏≤‡∏á √ó ‡∏¢‡∏≤‡∏ß)
        // ============================================
        let areaCalculatorModal = null;
        function openAreaCalculator() {
            // ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            if (areaCalculatorModal) {
                areaCalculatorModal.remove();
            }
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
            areaCalculatorModal = document.createElement('div');
            areaCalculatorModal.className = 'fixed inset-0 bg-black/20 z-[3000] flex items-center justify-center p-4 pointer-events-none';
            areaCalculatorModal.innerHTML = `
            <div class="bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl w-full max-w-sm animate-scale-in pointer-events-auto">
                <div class="p-3 border-b flex justify-between items-center">
                    <h3 class="font-bold text-base text-blue-900">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£</h3>
                    <button onclick="closeAreaCalculator()" class="p-1.5 hover:bg-gray-200 rounded-full transition">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="p-3 space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="form-label text-xs">‡∏Å‡∏ß‡πâ‡∏≤‡∏á (‡∏°.)</label>
                            <input type="number" id="calc-width" class="form-input text-center text-sm" placeholder="" step="0.01" oninput="calculateAreaResult()" style="-webkit-appearance: textfield; -moz-appearance: textfield; appearance: textfield;">
                        </div>
                        <div>
                            <label class="form-label text-xs">‡∏¢‡∏≤‡∏ß (‡∏°.)</label>
                            <input type="number" id="calc-length" class="form-input text-center text-sm" placeholder="" step="0.01" oninput="calculateAreaResult()" style="-webkit-appearance: textfield; -moz-appearance: textfield; appearance: textfield;">
                        </div>
                    </div>
                    <div>
                        <label class="form-label text-xs">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (‡∏ï‡∏£.‡∏°.)</label>
                        <input type="number" id="calc-result" class="form-input bg-custom-green/80 font-bold text-center text-sm" readonly placeholder="‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£" style="-webkit-appearance: textfield; -moz-appearance: textfield; appearance: textfield;">
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="clearAreaCalculator()"
                        class="flex-1 py-1.5 bg-gray-500 text-white rounded font-bold text-xs hover:bg-gray-600 transition">
                        ‡∏•‡πâ‡∏≤‡∏á
                        </button>
                        <button type="button" onclick="addAreaToField()"
                        class="flex-1 py-1.5 bg-blue-600 text-white rounded font-bold text-xs hover:bg-blue-700 transition">
                        ‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°
                        </button>
                    </div>
                </div>
            </div>
            `;
            document.body.appendChild(areaCalculatorModal);
            lucide.createIcons();
            // ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå
            const preventWheel = (e) => e.preventDefault();
            ['calc-width', 'calc-length', 'calc-result'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('wheel', preventWheel, { passive: false });
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                            e.preventDefault();
                        }
                    });
                }
            });
            document.getElementById('calc-width')?.focus();
        }

        // ============================================
        // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà A (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö b_area) - ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
        // ============================================
        let areaCalculatorModalA = null;
        let areaAccumulatorA = 0;
        let areaHistoryA = [];

        function openAreaCalculatorA() {
            if (areaCalculatorModalA) { areaCalculatorModalA.remove(); }
            areaAccumulatorA = 0;
            areaHistoryA = [];
            
            areaCalculatorModalA = document.createElement('div');
            areaCalculatorModalA.className = 'fixed inset-0 bg-black/20 z-[3000] flex items-center justify-center p-4 pointer-events-none';
            areaCalculatorModalA.innerHTML = `
            <div id="area-calculator-a-window" class="bg-white/95 backdrop-blur-sm rounded-xl shadow-2xl w-full max-w-sm animate-scale-in pointer-events-auto" 
                 style="width: 340px; position: absolute;">
                <!-- ‚úÖ Header ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á -->
                <div id="area-calculator-a-header" class="p-3 border-b flex justify-between items-center bg-purple-50 cursor-move rounded-t-lg">
                    <h3 class="font-bold text-sm text-purple-900">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á (A)</h3>
                    <button onclick="closeAreaCalculatorA()" class="p-1 hover:bg-purple-200 rounded-full transition">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="p-3 space-y-3">
                    <!-- ‚úÖ ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1: ‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤ + ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏° (‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô) -->
                    <div class="flex gap-2 items-center">
                        <input type="number" id="calc-input-a" class="form-input flex-1 text-center"
                               placeholder="‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡∏ï‡∏£.‡∏°.)" step="0.01"
                               style="-webkit-appearance: textfield; -moz-appearance: textfield; appearance: textfield;">
                        <button type="button" onclick="addAreaToAccumulatorA()"
                                class="px-3 py-2 bg-purple-600 text-white rounded font-bold text-sm hover:bg-purple-700 transition whitespace-nowrap">
                            + ‡πÄ‡∏û‡∏¥‡πà‡∏°
                        </button>
                    </div>
                    
                    <!-- ‚úÖ ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 2: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∞‡∏™‡∏° + ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å -->
                    <div class="bg-purple-100 rounded-lg p-2">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs font-bold text-purple-900">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏∞‡∏™‡∏° (‡∏ï‡∏£.‡∏°.)</label>
                            <input type="text" id="calc-result-a" class="form-input bg-white font-bold text-center w-24 text-sm"
                                   readonly value="0.00"
                                   style="-webkit-appearance: textfield; -moz-appearance: textfield; appearance: textfield;">
                        </div>
                        <!-- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏ß‡∏Å -->
                        <div id="area-history-a" class="text-xs text-purple-700 font-mono bg-white/50 rounded px-2 py-1 min-h-[20px]">
                            <!-- ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ä‡πà‡∏ô: 12 + 13.5 + 8 -->
                        </div>
                    </div>
                    
                    <!-- ‚úÖ ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 3: ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
                    <div class="flex gap-2">
                        <button type="button" onclick="clearAreaCalculatorA()"
                                class="flex-1 py-2 bg-gray-500 text-white rounded font-bold text-xs hover:bg-gray-600 transition">
                            ‡∏•‡πâ‡∏≤‡∏á
                        </button>
                        <button type="button" onclick="addAreaToFieldA()"
                                class="flex-1 py-2 bg-purple-600 text-white rounded font-bold text-xs hover:bg-purple-700 transition">
                            ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ
                        </button>
                    </div>
                </div>
            </div>
            `;
            
            document.body.appendChild(areaCalculatorModalA);
            lucide.createIcons();
            
            // ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
            makeDraggable(
                areaCalculatorModalA.querySelector('#area-calculator-a-window'),
                areaCalculatorModalA.querySelector('#area-calculator-a-header')
            );
            
            // ‚úÖ ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤
            const preventWheel = (e) => e.preventDefault();
            const input = document.getElementById('calc-input-a');
            if (input) {
                input.addEventListener('wheel', preventWheel, { passive: false });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowUp' || e.key === 'ArrowDown') e.preventDefault();
                });
                input.focus();
                // ‚úÖ ‡∏Å‡∏î Enter ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') addAreaToAccumulatorA();
                });
            }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
        function makeDraggable(element, header) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            header.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏ß‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏∞‡∏™‡∏°
        function addAreaToAccumulatorA() {
            const input = document.getElementById('calc-input-a');
            const resultDisplay = document.getElementById('calc-result-a');
            const historyDisplay = document.getElementById('area-history-a');
            const val = parseFloat(input.value) || 0;
            
            if (val === 0) {
                showNotificationLeft('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà', 'warning');
                return;
            }
            
            areaAccumulatorA += val;
            areaHistoryA.push(val);
            
            resultDisplay.value = areaAccumulatorA.toFixed(2);
            
            if (historyDisplay) {
                historyDisplay.textContent = areaHistoryA.join(' + ');
            }
            
            input.value = '';
            input.focus();
            
            showNotificationLeft(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${val.toFixed(2)} ‡∏ï‡∏£.‡∏°. (‡∏£‡∏ß‡∏°: ${areaAccumulatorA.toFixed(2)} ‡∏ï‡∏£.‡∏°.)`, 'success');
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
        function clearAreaCalculatorA() {
            areaAccumulatorA = 0;
            areaHistoryA = [];
            
            const resultDisplay = document.getElementById('calc-result-a');
            const historyDisplay = document.getElementById('area-history-a');
            const input = document.getElementById('calc-input-a');
            
            if (resultDisplay) resultDisplay.value = '0.00';
            if (historyDisplay) historyDisplay.textContent = '';
            if (input) {
                input.value = '';
                input.focus();
            }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ
        function addAreaToFieldA() {
            const result = areaAccumulatorA;
            if (result === 0) {
                showNotificationLeft('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì', 'warning');
                return;
            }
            
            const bAreaField = document.querySelector('input[name="b_area"]');
            if (!bAreaField) {
                showNotificationLeft('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á', 'error');
                return;
            }
            
            bAreaField.value = result.toFixed(2);
            showNotificationLeft(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á = ${result.toFixed(2)} ‡∏ï‡∏£.‡∏°.`, 'success');
            closeAreaCalculatorA();
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        function closeAreaCalculatorA() {
            if (areaCalculatorModalA) {
                areaCalculatorModalA.classList.add('animate-scale-out');
                setTimeout(() => {
                    if (areaCalculatorModalA && areaCalculatorModalA.parentNode) {
                        areaCalculatorModalA.remove();
                    }
                    areaCalculatorModalA = null;
                    areaAccumulatorA = 0;
                    areaHistoryA = [];
                }, 200);
            }
        }


        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå
        function calculateAreaResult() {
            const width = parseFloat(document.getElementById('calc-width').value) || 0;
            const length = parseFloat(document.getElementById('calc-length').value) || 0;
            const result = width * length;
            document.getElementById('calc-result').value = result.toFixed(2);
        }

        // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤
        function clearAreaCalculator() {
            document.getElementById('calc-width').value = '';
            document.getElementById('calc-length').value = '';
            document.getElementById('calc-result').value = '0';
        }

        // ‡∏ö‡∏ß‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á buse_area2
        function addAreaToField() {
            const result = parseFloat(document.getElementById('calc-result').value) || 0;
            const buseArea2Field = document.querySelector('input[name="buse_area2"]');
            
            if (!buseArea2Field) {
                showNotificationLeft('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (2)', 'error');
                return;
            }
            
            const currentValue = parseFloat(buseArea2Field.value) || 0;
            const newValue = currentValue + result;
            
            buseArea2Field.value = newValue.toFixed(2);
            showNotificationLeft(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ${result.toFixed(2)} ‡∏ï‡∏£.‡∏°. ‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô ${newValue.toFixed(2)} ‡∏ï‡∏£.‡∏°.`, 'success');
            
            // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏ß ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å
            document.getElementById('calc-width').value = '';
            document.getElementById('calc-length').value = '';
            document.getElementById('calc-result').value = '0';
            document.getElementById('calc-width').focus();
        }

        // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
        function closeAreaCalculator() {
            if (areaCalculatorModal) {
                areaCalculatorModal.classList.add('animate-scale-out');
                setTimeout(() => {
                    if (areaCalculatorModal && areaCalculatorModal.parentNode) {
                        areaCalculatorModal.remove();
                    }
                    areaCalculatorModal = null;
                }, 200);
            }
        }

        // ============================================
        // ‡∏Ç‡πâ‡∏≠ 1.2: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (b_area - buse_area2)
        // ============================================
        function calculateDeltaArea() {
            const bAreaField = document.querySelector('input[name="b_area"]');
            const buseArea2Field = document.querySelector('input[name="buse_area2"]');
            const buseAreaField = document.querySelector('input[name="buse_area"]');
            
            if (!bAreaField || !buseArea2Field || !buseAreaField) {
                showNotificationLeft('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£', 'error');
                return;
            }
            
            const bArea = parseFloat(bAreaField.value) || 0;
            const buseArea2 = parseFloat(buseArea2Field.value) || 0;
            
            if (buseArea2 === 0) {
                showNotificationLeft('‚ö†Ô∏è ‡∏ä‡πà‡∏≠‡∏á "‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (2)" ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤', 'warning');
                return;
            }
            
            const result = bArea - buseArea2;
            
            if (result < 0) {
                showNotificationLeft('‚ùå ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                return;
            }
            
            buseAreaField.value = result.toFixed(2);
            showNotificationLeft(`‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á: ${bArea.toFixed(2)} - ${buseArea2.toFixed(2)} = ${result.toFixed(2)} ‡∏ï‡∏£.‡∏°.`, 'success');
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ó‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "1-1", "1-2" ‡∏Ø‡∏•‡∏Ø
        function normalizeFloorValue(value) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ä‡πà‡∏ô "2025-12-31T17:00:00.000Z")
            if (typeof value === 'string' && value.includes('T') && value.includes('Z')) {
                try {
                    const date = new Date(value);
                    const month = date.getMonth() + 1;
                    const day = date.getDate();
                    return `${day}-${month}`;
                } catch (e) {
                    return '';
                }
            }
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (serial number ‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ó)
            else if (typeof value === 'number' && value > 365) {
                const baseDate = new Date('1899-12-30');
                baseDate.setDate(baseDate.getDate() + Math.floor(value));
                const month = baseDate.getMonth() + 1;
                const day = baseDate.getDate();
                return `${day}-${month}`;
            }
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥
            return value || '';
        }





        // ‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î
        async function applyDeltaUpdates(records, type) {
            for (const record of records) {
                const id = record.id || record._row_num;
                
                // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
                let existingMarker = null;
                surveyLayers.eachLayer(layer => {
                    if (layer._popupData && (layer._popupData.id === id || layer._popupData._row_num === id)) {
                        existingMarker = layer;
                    }
                });
                
                if (existingMarker) {
                    // ‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                    existingMarker._popupData = { ...existingMarker._popupData, ...record };
                    setupMarkerPopup(existingMarker, existingMarker._popupData, type);
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
                    if (record.lat_long && record.lat_long !== existingMarker._popupData.lat_long) {
                        const coords = record.lat_long.split(',').map(Number);
                        existingMarker.setLatLng(L.latLng(coords[0], coords[1]));
                    }
                } else {
                    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
                    if (record.lat_long) {
                        const coords = record.lat_long.split(',').map(Number);
                        const marker = createCircleMarker(L.latLng(coords[0], coords[1]), type, isEditMode);
                        marker._popupData = record;
                        setupMarkerPopup(marker, record, type);
                        marker.addTo(surveyLayers);
                        if (isEditMode) enableMarkerDragging(marker, record);
                    }
                }
            }
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (type === 'building') {
                allBuildings = [...allBuildings.filter(b => !records.some(r => r.id === b.id)), ...records];
                renderBuildingTable();
            } else {
                allSigns = [...allSigns.filter(s => !records.some(r => r.id === s.id)), ...records];
                renderSignTable();
            }
        }

        // ‡∏•‡∏ö‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö
        function removeDeletedMarkers(deletedIds) {
            surveyLayers.eachLayer(layer => {
                if (layer._popupData && deletedIds.includes(layer._popupData.id || layer._popupData._row_num)) {
                    surveyLayers.removeLayer(layer);
                }
            });
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            allBuildings = allBuildings.filter(b => !deletedIds.includes(b.id));
            allSigns = allSigns.filter(s => !deletedIds.includes(s.id));
            renderBuildingTable();
            renderSignTable();
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        async function updateChangedMarkers(data) {
            const currentMarkers = {};
            
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            surveyLayers.eachLayer(layer => {
                if (layer._popupData && layer._popupData.id) {
                    currentMarkers[layer._popupData.id] = layer;
                }
            });
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            surveyLayers.clearLayers();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            const allData = [...(data.buildings || []), ...(data.signs || [])];
            
            for (const item of allData) {
                if (!item.lat_long) continue;
                
                const coords = item.lat_long.split(',').map(Number);
                if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) continue;
                
                const type = item.building_c ? 'building' : 'sign';
                const latLng = L.latLng(coords[0], coords[1]);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const existingMarker = currentMarkers[item.id];
                
                if (existingMarker) {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏¥‡∏°
                    existingMarker.setLatLng(latLng);
                    existingMarker._popupData = item;
                    setupMarkerPopup(existingMarker, item, type);
                    existingMarker.addTo(surveyLayers);
                    
                    if (isEditMode) enableMarkerDragging(existingMarker, item);
                } else {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà
                    const m = createCircleMarker(latLng, type, isEditMode);
                    setupMarkerPopup(m, item, type);
                    m.addTo(surveyLayers);
                    
                    if (isEditMode) enableMarkerDragging(m, item);
                }
            }
        }


        // ‡πÉ‡∏ä‡πâ MarkerCluster ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å
        let markerCluster = null;

        function initMarkerClustering() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á MarkerCluster Group
            markerCluster = L.markerClusterGroup({
                maxClusterRadius: 80, // ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏•‡∏±‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå
                disableClusteringAtZoom: 16, // ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏•‡∏±‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ã‡∏π‡∏°‡πÉ‡∏Å‡∏•‡πâ
                chunkedLoading: true, // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡πÅ‡∏ö‡πà‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô
                chunkInterval: 200, // ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
                chunkDelay: 50 // ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏•‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            markerCluster.addTo(map);
        }

        // ‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πåÏç∏‡πÄ‡∏ô‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö <img> (‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á)
        function convertDriveUrlToDirect(url) {
            if (!url) return url;
            url = url.trim();
            
            // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πåÏç∏‡πÄ‡∏ô‡∏•‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            if (url.includes('drive.google.com/thumbnail')) {
                return url;
            }
            
            // ‚úÖ ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å Googleusercontent ‚Üí ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            if (url.includes('googleusercontent.com')) {
                return url;
            }
            
            // ‚úÖ ‡∏î‡∏∂‡∏á FILE_ID ‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ
            let fileId = '';
            
            // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 1: /file/d/FILE_ID/view
            const pattern1 = /\/file\/d\/([a-zA-Z0-9_-]+)/;
            const match1 = url.match(pattern1);
            if (match1 && match1[1]) {
                fileId = match1[1];
            }
            
            // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 2: /uc?export=view&id=FILE_ID
            if (!fileId) {
                const pattern2 = /id=([a-zA-Z0-9_-]+)/;
                const match2 = url.match(pattern2);
                if (match2 && match2[1]) {
                    fileId = match2[1];
                }
            }
            
            // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà 3: /open?id=FILE_ID
            if (!fileId) {
                const pattern3 = /open\?id=([a-zA-Z0-9_-]+)/;
                const match3 = url.match(pattern3);
                if (match3 && match3[1]) {
                    fileId = match3[1];
                }
            }
            
            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πåÏç∏‡πÄ‡∏ô‡∏• (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏±‡∏ö <img>)
            if (fileId) {
                // sz=w1000 ‚Üí ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á 1000px (‡∏õ‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥), ‡πÉ‡∏ä‡πâ w2000 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
                return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
            }
            
            // ‚úÖ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‚Üí ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
            return url;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        function showImagePreview(imageUrl, fileName) {
            const container = document.getElementById('image-preview-container');
            const img = document.getElementById('image-preview');
            const placeholder = document.getElementById('image-preview-placeholder');
            
            if (!imageUrl || !imageUrl.trim()) {
                hideImagePreview();
                return;
            }
            
            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö
            container.style.display = 'flex';
            
            // ‚úÖ ‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå Google Drive ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏£‡∏á (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î!)
            const directUrl = convertDriveUrlToDirect(imageUrl);
            console.log('üñºÔ∏è ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•‡∏á):', directUrl);
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß
            img.src = directUrl; // ‚úÖ ‡πÉ‡∏ä‡πâ directUrl ‡πÅ‡∏ó‡∏ô imageUrl
            img.alt = fileName || '‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
            img.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏ì‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
            img.onerror = () => {
                img.classList.add('hidden');
                placeholder.textContent = '‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ';
                placeholder.classList.remove('hidden');
                placeholder.classList.add('text-red-400');
                console.error('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', directUrl);
            };
            
            // ‚úÖ ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
            const tablePanel = document.getElementById('data-table-panel');
            if (tablePanel && tablePanel.classList.contains('open')) {
                container.style.bottom = `calc(5px + 45vh + 10px)`;
            } else {
                container.style.bottom = '5px';
            }
            
            // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Lucide ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î
            lucide.createIcons();
        }

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î)
        function hideImagePreview() {
            const container = document.getElementById('image-preview-container');
            if (container) {
                container.style.display = 'none';
                console.log('üñºÔ∏è ‡∏ã‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
            }
        }

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        function handleImageBadgeClick(imageUrl, fileName) {
            if (!imageUrl || imageUrl.trim() === '') {
                showNotificationLeft('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á', 'warning');
                return;
            }
            
            // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            showImagePreview(imageUrl, fileName);
        }


        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô createCircleMarker
        function createCircleMarker(latlng, type, isDraggable = false, checkStatus = null) {
            // ‚úÖ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            let shapeClass = 'circle-round'; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡∏ß‡∏á‡∏Å‡∏•‡∏°
            let colorClass = '';
            
            if (type === 'building') {
                colorClass = 'circle-building'; // ‡∏™‡πâ‡∏°
            } else {
                colorClass = 'circle-sign'; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
            }
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡∏£‡πà‡∏≤‡∏á
            if (checkStatus === '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏•‡πâ‡∏ß') {
                shapeClass = 'circle-square'; // ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°
            } else if (checkStatus === '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß') {
                // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏´‡∏°‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                return createPinMarker(latlng, type, isDraggable);
            }
            
            const icon = L.divIcon({
                className: `circle-marker ${colorClass} ${shapeClass}`,
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });
            
            const marker = L.marker(latlng, {
                icon: icon,
                draggable: isDraggable,
                zIndexOffset: 1000
            });
            
            return marker;
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏°‡∏∏‡∏î (‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢‡∏Å‡∏π‡πÄ‡∏Å‡∏¥‡πâ‡∏•‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå)
        function createPinMarker(latlng, type, isDraggable = false) {
            const color = type === 'building' ? '#f97316' : '#22c55e';
            
            // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° stroke="white" stroke-width="2" ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á SVG
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                    <path fill="${color}" stroke="white" stroke-width="2" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/>
                </svg>
            `;
            
            const icon = L.divIcon({
                className: 'pin-marker',
                html: svg,
                iconSize: [24, 24],
                iconAnchor: [12, 24],
                popupAnchor: [0, -24]
            });
            
            const marker = L.marker(latlng, {
                icon: icon,
                draggable: isDraggable,
                zIndexOffset: 2000
            });
            
            return marker;
        }

        // ============================================
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏™‡πÄ‡∏õ‡∏£‡∏î‡∏ä‡∏µ‡∏ï
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const downloadBtn = document.getElementById('download-all-images');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', async function() {
                    try {
                        showNotificationLeft('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...', 'info');
                        
                        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏™‡πÄ‡∏õ‡∏£‡∏î‡∏ä‡∏µ‡∏ï
                        const response = await fetch(CONFIG.SCRIPT_URL + '?action=getData');
                        const data = await response.json();
                        
                        // ‡∏£‡∏ß‡∏°‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≤‡∏¢
                        const allImages = [
                            ...data.buildings.filter(b => b.image && b.image.includes('http')),
                            ...data.signs.filter(s => s.image && s.image.includes('http'))
                        ];
                        
                        if (allImages.length === 0) {
                            showNotificationLeft('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö', 'warning');
                            return;
                        }
                        
                        showNotificationLeft(`‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${allImages.length} ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...`, 'info');
                        
                        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏£‡∏π‡∏õ
                        for (let i = 0; i < allImages.length; i++) {
                            const item = allImages[i];
                            const imageUrl = item.image;
                            const fileName = item.picture || `image_${i + 1}.jpg`;
                            
                            try {
                                // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ
                                const imgResponse = await fetch(imageUrl);
                                const blob = await imgResponse.blob();
                                
                                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(blob);
                                link.download = fileName;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                URL.revokeObjectURL(link.href);
                                
                                console.log(`‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î: ${fileName}`);
                                
                                // ‡∏£‡∏≠ 500ms ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏π‡∏õ
                                if (i < allImages.length - 1) {
                                    await new Promise(resolve => setTimeout(resolve, 500));
                                }
                            } catch (err) {
                                console.error(`‚ùå ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${fileName} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, err);
                                showNotificationLeft(`‚ö†Ô∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${fileName} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`, 'error');
                            }
                        }
                        
                        showNotificationLeft(`‚úÖ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${allImages.length} ‡∏£‡∏π‡∏õ) ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!`, 'success');
                    } catch (err) {
                        console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', err);
                        showNotificationLeft('‚ùå ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
                    }
                });
            }
        });

        // ============================================
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏•‡πÄ‡∏°‡∏≤‡∏™‡πå
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const surveyForm = document.getElementById('survey-form');
            if (surveyForm) {
                surveyForm.addEventListener('wheel', function(e) {
                    if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                console.log('‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤‡∏ä‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à');
            }
            
            // ‚úÖ ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠ log ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
            const refreshBtn = document.getElementById('btn-refresh');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    // ‚úÖ ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏≠‡∏á‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï cooldown ‡πÉ‡∏ô refreshData() ‡πÅ‡∏•‡πâ‡∏ß
                    // ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏Ñ‡πà log ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
                    console.log('üñ±Ô∏è ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á');
                });
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô + buffer
        function loadVisibleMarkers() {
            // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏•‡πâ‡∏≤‡∏á
            const ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏àMarkers = [];
            if (markerCluster) {
                markerCluster.eachLayer(layer => {
                    if (layer._popupData) {
                        if (layer._popupData.queued || layer._popupData.tempMarker) {
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏àMarkers.push({
                                latlng: layer.getLatLng(),
                                data: layer._popupData,
                                type: layer._popupData.type
                            });
                        }
                    }
                });
            } else {
                surveyLayers.eachLayer(layer => {
                    if (layer._popupData) {
                        if (layer._popupData.queued || layer._popupData.tempMarker) {
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏àMarkers.push({
                                latlng: layer.getLatLng(),
                                data: layer._popupData,
                                type: layer._popupData.type
                            });
                        }
                    }
                });
            }
            
            const bounds = map.getBounds();
            const bufferRatio = isMobile() ? 1.5 : 2.0;
            const bufferedBounds = bounds.pad(bufferRatio);
            
            // ‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            if (markerCluster) {
                markerCluster.clearLayers();
            } else {
                surveyLayers.clearLayers();
            }
            
            // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏°‡∏≤‡∏£‡πå‡∏Å‡πÄ‡∏Å‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï + buffer
            allBuildings.forEach(r => {
                if (!r.lat_long) return;
                const coords = r.lat_long.split(',').map(Number);
                if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                const latLng = L.latLng(coords[0], coords[1]);
                if (!bufferedBounds.contains(latLng)) return;
                
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const recordKey = r._row_num || r.id;
                if (markersBeingMoved.has(recordKey)) {
                    return; // ‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏à‡∏£‡∏¥‡∏á
                }
                
                const m = createCircleMarker(latLng, 'building', isEditMode, r.check);
                setupMarkerPopup(m, r, 'building');
                if (markerCluster) {
                    markerCluster.addLayer(m);
                } else {
                    m.addTo(surveyLayers);
                }
            });
            
            allSigns.forEach(r => {
                if (!r.lat_long) return;
                const coords = r.lat_long.split(',').map(Number);
                if (coords.length < 2 || isNaN(coords[0]) || isNaN(coords[1])) return;
                const latLng = L.latLng(coords[0], coords[1]);
                if (!bufferedBounds.contains(latLng)) return;
                
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                const recordKey = r._row_num || r.id; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
                if (markersBeingMoved.has(recordKey)) { // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô recordKey
                    return;
                }
                
                const m = createCircleMarker(latLng, 'sign', isEditMode, r.check);
                setupMarkerPopup(m, r, 'sign');
                if (markerCluster) {
                    markerCluster.addLayer(m);
                } else {
                    m.addTo(surveyLayers);
                }
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏£‡∏ß‡∏àMarkers.forEach(marker => {
                const m = createCircleMarker(marker.latlng, marker.type, isEditMode);
                m._popupData = marker.data;
                setupMarkerPopup(m, marker.data, marker.type);
                if (markerCluster) {
                    markerCluster.addLayer(m);
                } else {
                    m.addTo(surveyLayers);
                }
                if (isEditMode) enableMarkerDragging(m, marker.data);
            });
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ã‡∏π‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        map.on('moveend', loadVisibleMarkers);
        map.on('zoomend', loadVisibleMarkers);

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô refreshData (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏≠‡∏á - ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)
        // ============================================
        function refreshData() {
            const refreshBtn = document.getElementById('btn-refresh');
            const refreshIcon = document.getElementById('refresh-icon');
            
            // ‚úÖ 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ã‡πâ‡∏≥)
            if (isRefreshing) {
                console.log('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà - ‡∏Ç‡πâ‡∏≤‡∏°');
                return;
            }
            
            // ‚úÖ 2. ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î
            isRefreshing = true;
            
            // ‚úÖ 3. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï cooldown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
            lastAutoRefreshTime = Date.now();  // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ
            console.log('üñ±Ô∏è ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á - ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï cooldown');
            
            disableRefreshButton();
            refreshIcon.classList.add('animate-spin');
            
            loadExistingData().finally(() => {
                setTimeout(() => {
                    refreshIcon.classList.remove('animate-spin');
                    enableRefreshButton();
                    
                    // ‚úÖ 4. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
                    isRefreshing = false;
                    
                    console.log('‚úÖ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');
                }, 500);
            });
        }

        // ============================================
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
        // ============================================
        function selectMapFile() {
            closeSettingsMenu();
            
            // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î dialog ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
            const fileInput = document.getElementById('map-file-input');
            if (fileInput) {
                fileInput.click();
            }
        }

        // ============================================
        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 3 ‡πÑ‡∏ü‡∏•‡πå)
        // ============================================
        async function handleMapFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏ü‡∏•‡πå
            if (!file.name.toLowerCase().endsWith('.geojson') && 
                !file.name.toLowerCase().endsWith('.json')) {
                showNotificationLeft('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå .geojson ‡∏´‡∏£‡∏∑‡∏≠ .json ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô', 'error');
                return;
            }
            
            try {
                showNotificationLeft('üìÇ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', 'info');
                
                // ‚úÖ ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô text
                const text = await file.text();
                console.log('üìÑ ‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå:', text.length, 'bytes');
                
                // ‚úÖ Parse JSON
                const geoJson = JSON.parse(text);
                console.log('üìä ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á GeoJSON:', geoJson);
                
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á
                if (!geoJson.type || geoJson.type !== 'FeatureCollection') {
                    throw new Error('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà GeoJSON ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ type: FeatureCollection)');
                }
                
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö features
                if (!geoJson.features || !Array.isArray(geoJson.features)) {
                    throw new Error('‡πÑ‡∏ü‡∏•‡πå GeoJSON ‡πÑ‡∏°‡πà‡∏°‡∏µ features ‡∏´‡∏£‡∏∑‡∏≠ features ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Array');
                }
                
                console.log(`‚úÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô features: ${geoJson.features.length}`);
                
                // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠
                let layerType = 'all';
                if (file.name.toLowerCase().includes('parcel')) layerType = 'parcel';
                else if (file.name.toLowerCase().includes('boundary')) layerType = 'boundary';
                else if (file.name.toLowerCase().includes('building')) layerType = 'building';
                
                // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô IndexedDB
                await cacheMapData(JSON.stringify(geoJson), new Date().toISOString(), layerType);
                
                // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                await loadMapFromCache(geoJson, layerType);
                
                const layerNames = {
                    parcel: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á',
                    boundary: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï',
                    building: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á',
                    all: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà'
                };
                
                showNotificationLeft(`‚úÖ ‡πÇ‡∏´‡∏•‡∏î${layerNames[layerType]}‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, 'success');
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà:', err);
                showNotificationLeft('‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message, 'error');
            }
            
            // ‚úÖ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï input
            event.target.value = '';
        }

        // ============================================
        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á 3 ‡πÑ‡∏ü‡∏•‡πå + ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
        // ============================================
        function downloadMapFile(layerType = 'parcel') {
            closeSettingsMenu();
            
            const config = MAP_CONFIG[layerType];
            if (!config) {
                showNotificationLeft('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà', 'error');
                return;
            }
            
            // ‚úÖ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö (force download)
            const downloadUrl = `https://drive.google.com/uc?export=download&confirm=t&id=${config.googleDriveFileId}`;
            
            const layerNames = {
                parcel: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á',
                boundary: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï',
                building: '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á'
            };
            
            const fileName = config.fileName;
            
            // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
            
            if (isMobile) {
                // üì± ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
                showNotificationLeft(`üì• ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${layerNames[layerType]}...`, 'info');
                
                setTimeout(() => {
                    // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
                    const confirmMsg = `üì• ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${layerNames[layerType]}\n\n` +
                        `‡πÑ‡∏ü‡∏•‡πå: ${fileName}\n\n` +
                        `‚ö†Ô∏è ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏ö‡∏≤‡∏á‡∏£‡∏∏‡πà‡∏ô:\n` +
                        `‚Ä¢ ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥\n` +
                        `‚Ä¢ ‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå ‚Üí "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå"\n` +
                        `‚Ä¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Chrome/Safari ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà\n\n` +
                        `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏•‡∏¢‡πÑ‡∏´‡∏°?`;
                    
                    if (confirm(confirmMsg)) {
                        // ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÉ‡∏ä‡πâ window.location.href (‡πÑ‡∏î‡πâ‡∏ú‡∏•‡∏Å‡∏ß‡πà‡∏≤‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
                        window.location.href = downloadUrl;
                        
                        // ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏™‡∏≥‡∏£‡∏≠‡∏á - ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                        setTimeout(() => {
                            const newWindow = window.open(downloadUrl, '_blank');
                            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                                // ‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
                                alert(`üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î:\n\n${downloadUrl}\n\n` +
                                    `‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:\n` +
                                    `1. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô\n` +
                                    `2. ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà (Chrome/Safari)\n` +
                                    `3. ‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î Enter\n` +
                                    `4. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è`);
                            }
                        }, 2000);
                        
                        // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                        setTimeout(() => {
                            alert(`üìÅ ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à:\n\n` +
                                `‚Ä¢ Android: ‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô /Download/ ‡∏´‡∏£‡∏∑‡∏≠ /Documents/\n` +
                                `‚Ä¢ iOS: ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏≠‡∏õ "Files" ‚Üí ‡∏î‡∏π‡πÉ‡∏ô Downloads\n\n` +
                                `‚úÖ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà:\n` +
                                `1. ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ\n` +
                                `2. ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤\n` +
                                `3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà"\n` +
                                `4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ${fileName} ‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤`);
                        }, 3000);
                    }
                }, 300);
                
            } else {
                // üñ•Ô∏è ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå: ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏î‡∏¥‡∏°
                showNotificationLeft(`üì• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${layerNames[layerType]}...`, 'info');
                
                setTimeout(() => {
                    window.open(downloadUrl, '_blank');
                    
                    setTimeout(() => {
                        alert(`üì• ‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ${layerNames[layerType]}\n\n` +
                            `1. ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå\n` +
                            `2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå "${fileName}"\n` +
                            `3. ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ\n` +
                            `4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤`);
                    }, 1000);
                }, 300);
            }
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å DOMContentLoaded ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö window
        function showRawParcelData(propsJson, lat, lng) {
            try {
                // ‚úÖ Decode ‡πÅ‡∏•‡∏∞ parse ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const props = JSON.parse(decodeURIComponent(propsJson));
                
                // ‚úÖ ‡∏õ‡∏¥‡∏î popup ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
                map.closePopup();
                
                // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                const rawRows = Object.entries(props || {})
                    .filter(([key, value]) => value !== null && value !== undefined && value !== '')
                    .map(([key, value]) => {
                        return `<tr><td class="k">${key}:</td><td class="v">${value}</td></tr>`;
                    }).join('');
                
                // ‚úÖ Popup ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö
                const rawContent = `
                    <div class="popup-raw" onclick="event.stopPropagation()">
                        <div class="popup-raw-header">
                            <span>${props.parcel_cod || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™'}</span>
                            <button class="popup-close" onclick="map.closePopup()">‚úï</button>
                        </div>
                        <div class="popup-raw-body">
                            <table>${rawRows || '<tr><td colspan="2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>'}</table>
                        </div>
                    </div>
                `;
                
                L.popup({ 
                    minWidth: 200, 
                    maxWidth: 280, 
                    maxHeight: 300,
                    className: 'mobile-popup-raw' 
                })
                .setLatLng(L.latLng(lat, lng))
                .setContent(rawContent)
                .openOn(map);
                
                console.log('üìã ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö:', props.parcel_cod);
                
            } catch (err) {
                console.error('‚ùå Error showing raw data:', err);
                alert('‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + err.message);
            }
        }

        // ============================================
        // ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á (parcel_cod)
        // ============================================
        function getParcelLabelStyle() {
            return {
                // ‚úÖ ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°
                color: '#991b1b',        // red-800
                // ‚úÖ ‡∏Ç‡∏≠‡∏ö‡∏≠‡∏±‡∏Å‡∏©‡∏£: ‡∏Ç‡∏≤‡∏ß (‡πÉ‡∏ä‡πâ text-shadow ‡∏à‡∏≥‡∏•‡∏≠‡∏á)
                textShadow: '-1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff',
                // ‚úÖ ‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏ü‡∏≠‡∏ô‡∏ï‡πå
                fontSize: '11px',
                fontWeight: 'bold',
                fontFamily: 'Tahoma, sans-serif',
                // ‚úÖ ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
                textAlign: 'center',
                // ‚úÖ ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™
                backgroundColor: 'transparent'
            };
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡πÄ‡∏ß‡∏≠‡∏£‡πå Polygon
        function highlightFeature(e) {
            const layer = e.target;
            layer.setStyle({
                weight: 3,
                color: '#22d3ee',
                fillOpacity: 0.2
            });
            layer.bringToFront();
        }

        // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏Æ‡πÄ‡∏ß‡∏≠‡∏£‡πå - ‡πÅ‡∏Å‡πâ‡πÅ‡∏Ñ‡πà 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
        function resetHighlight(e) {
            const layer = e.target;
            
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡∏î‡∏∂‡∏á feature + layerName ‡∏à‡∏≤‡∏Å layer ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
            const feature = layer.feature;
            const layerName = layer.layerName || 'parcel';
            
            // ‚úÖ ‡∏™‡πà‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏£‡∏ö ‡πÉ‡∏´‡πâ getMapLayerStyle ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ
            layer.setStyle(getMapLayerStyle(feature, layerName));
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Label ‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°
        map.on('zoomend', function() {
            const currentZoom = map.getZoom();
            const labels = document.querySelectorAll('.parcel-label');
            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡∏π‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡πÄ‡∏ä‡πà‡∏ô 17 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏î‡∏¥‡∏ô)
            if (currentZoom >= 17) {
                labels.forEach(el => el.style.display = 'block');
            } else {
                labels.forEach(el => el.style.display = 'none');
            }
        });

        // ============================================
        // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        // ============================================
        async function clearMapData() {
            // ‚úÖ ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            const confirmed = confirm(
                '‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà\n\n' +
                '‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞:\n' +
                '‚Ä¢ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n' +
                '‚Ä¢ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï\n' +
                '‚Ä¢ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πà‡∏á‡∏õ‡∏•‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á\n' +
                '‚Ä¢ ‡∏•‡∏ö markers ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà\n\n' +
                '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?'
            );
            
            if (!confirmed) return;
            
            try {
                showNotificationLeft('üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà...', 'info');
                
                // ‚úÖ 1. ‡∏•‡∏ö markers ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                surveyLayers.clearLayers();
                console.log('‚úÖ ‡∏•‡∏ö markers ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                
                // ‚úÖ 2. ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å IndexedDB
                const db = await openMapDatabase();
                const transaction = db.transaction(['maps', 'mapChunks'], 'readwrite');
                
                // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                const mapStore = transaction.objectStore('maps');
                await mapStore.clear();
                console.log('‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å IndexedDB ‡πÅ‡∏•‡πâ‡∏ß');
                
                // ‡∏•‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                const chunkStore = transaction.objectStore('mapChunks');
                await chunkStore.clear();
                console.log('‚úÖ ‡∏•‡∏ö‡∏ä‡∏¥‡πâ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≤‡∏Å IndexedDB ‡πÅ‡∏•‡πâ‡∏ß');
                
                db.close();
                
                // ‚úÖ 3. ‡∏•‡∏ö localStorage keys ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
                const keysToRemove = [
                    'parcel_geojson_last_modified',
                    'boundary_geojson_last_modified',
                    'building_geojson_last_modified',
                    'mapCache'
                ];
                
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                console.log('‚úÖ ‡∏•‡∏ö localStorage keys ‡πÅ‡∏•‡πâ‡∏ß');
                
                // ‚úÖ 4. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£
                allBuildings = [];
                allSigns = [];
                
                // ‚úÖ 5. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                renderBuildingTable();
                renderSignTable();
                updateTableCounters();
                
                // ‚úÖ 6. ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                showNotificationLeft('‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
                // ‚úÖ 7. ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π
                closeSettingsMenu();
                
            } catch (err) {
                console.error('‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà:', err);
                showNotificationLeft('‚ùå ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
            }
        }

        // ============================================
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        // ============================================
        function updateFileName(input, fieldId) {
            const filenameSpan = document.getElementById(`filename-${fieldId}`);
            if (!filenameSpan) return;
            if (input.files && input.files[0]) {
                const filename = input.files[0].name;
                filenameSpan.textContent = filename;
                filenameSpan.classList.remove('hidden');
                filenameSpan.classList.add('bg-blue-100', 'text-blue-800');
            } else {
                filenameSpan.classList.add('hidden');
            }
        }

    </script>
</body>

</html>
